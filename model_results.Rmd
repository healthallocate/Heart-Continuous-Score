---
title: "Model Results"
output:
  html_document:
    toc: true
    df_print: paged
authors: Kevin Zhang
---

<!-- 1. Set up dataset with generated cardiac variables (Line 40) -->
<!-- 2. Set up matrices for predictions (Line 153) -->
<!-- 3. Run selected logistic regression models and create coefficient plots (Line 609) -->
<!-- 4. Run sensitivity logistic regression models (Line 1693) -->
<!-- 5. Obtain machine learning model results (Line 1769) -->
<!-- 6. Make predictions on test dataset (Line 1831) -->
<!-- 7. Create AUC curves (Line 1892) -->
<!-- 8. Variable importance plots from gradient-boosted models (Line 1948) -->
<!-- 9. Create calibration plot in test dataset (Line 2009) -->
<!-- 10. Create facet plot of 50 point score at initial listing (Line 2066) -->
<!-- 11. Examine gender and race differences in prediction (Line 2098) -->
<!-- 12. Check for informative censoring (Line 2259) -->
<!-- 13. Examine a model with center random effects (Line 2291) -->
<!-- 14. Examine sensitivity and specificity at certain cut points (Line 2309) -->
<!-- 15. Examine model performance based on temporal split (Line 2368) -->



```{r, include=F, warning=F, echo=F, comment=NA}
rm(list=ls()); invisible(gc())
if (!require('pacman')) {install.packages('pacman')}
library(pacman)
pacman::p_load(tidyverse, splines, knitr, kableExtra, glmnet, caret, gtsummary, pROC, xgboost, survival, DescTools, cowplot, lme4)
knitr::opts_knit$set(root.dir = 'C:/Users/Kevin (Work)/Desktop/US-CRS')
```


---------------------------------


# 1. Set up dataset with generated cardiac variables
Starting dataset requires the interval dataset from **6week_death_data_prep.Rmd**.


```{r, warning=F, comment=NA}
load('./intervals_v17_impute_6wkdeath.RData')


### Convert variable types to correct types
factor_vars <- c('diagnosis', 'diabetes', 'dialysis', 'IV_inotropes', 'dobutamine', 
                 'dopamine', 'epinephrine', 'milrinone', 'IABP', 'ECMO', 'BiVAD', 'LVAD', 'RVAD',
                 'MCSD_complication', 'life_arrhythmia', 'BiVAD_no_discharge', 
                 'temp_surg_LVAD', 'other_durable_MCSD', 'MCSD_malfunction', 'v_tach_fib', 
                 'perc_LVAD', 'MCSD_hemolysis', 'MCSD_rhf', 'MCSD_device_infx', 
                 'MCSD_bleed', 'MCSD_aortic_insf', 'angina', 
                 
                 'temp_surg_MCS_ever', 'BiVAD_no_discharge_ever', 'IV_inotropes_ever', 
                 'IABP_ever', 'ECMO_ever', 'BiVAD_ever', 'LVAD_ever', 'RVAD_ever')

numeric_vars <- c('interval', 'interval_start', 'interval_stop', 'age', 
                  'systolicBP', 'diastolicBP', 'PASP', 'PADP', 'heart_rate', 'cardiac_output', 
                  'central_venous_pressure', 'arterial_lactate', 
                  'PCWP', 'hemoglobin', 'albumin', 'bilirubin', 'creatinine', 'sodium', 
                  'AST', 'BNP', 'BUN', 'INR', 'LDH', 'eGFR',
                  
                  'sodium_max', 'creatinine_max', 
                  'bilirubin_max', 'albumin_max', 'arterial_lactate_max', 'BUN_max', 'AST_max', 
                  'INR_max', 'BNP_max', 'LDH_max', 'sodium_min', 'creatinine_min', 
                  'bilirubin_min', 'albumin_min', 'arterial_lactate_min', 'BUN_min', 'AST_min', 
                  'INR_min', 'BNP_min', 'LDH_min', 'sodium_slope', 'creatinine_slope', 'bilirubin_slope', 
                  'albumin_slope', 'arterial_lactate_slope', 'BUN_slope', 'AST_slope', 
                  'INR_slope', 'BNP_slope', 'LDH_slope')


df_intervals[ ,factor_vars] <- lapply(df_intervals[ ,factor_vars], as.factor)
df_intervals[ ,numeric_vars] <- lapply(df_intervals[ ,numeric_vars], as.numeric)
df_intervals$death6week <- as.factor(df_intervals$death6week)
df_intervals$age <- as.numeric(df_intervals$age)
df_intervals$interval <- as.numeric(df_intervals$interval)



### Change specific baseline factor levels 
df_intervals$diagnosis <- relevel(factor(df_intervals$diagnosis), ref = 'Dilated_CM')
df_intervals$dobutamine <- relevel(factor(df_intervals$dobutamine), ref = 'Not High')
df_intervals$dopamine <- relevel(factor(df_intervals$dopamine), ref = 'Not High')
df_intervals$epinephrine <- relevel(factor(df_intervals$epinephrine), ref = 'Not High')
df_intervals$milrinone <- relevel(factor(df_intervals$milrinone), ref = 'Not High')



### Generated cardiac variables
df_intervals <- df_intervals %>%
  mutate(
    cpo = (1/541) * cardiac_output * (((2/3)*systolicBP) + ((1/3)*diastolicBP)),
    api = (systolicBP - diastolicBP) / PCWP,
    papi = (PASP - PADP) / central_venous_pressure) %>%
  
  mutate(cpo = as.numeric(cpo),
         api = as.numeric(api),
         papi = as.numeric(papi))


# Fix cases where PCWP or central venous pressure is 0 (division by 0)
# Lower bound of PAPi set to 1
df_intervals$api[df_intervals$PCWP == 0] <- NA

df_intervals$papi[df_intervals$central_venous_pressure == 0] <- 1
df_intervals$papi[df_intervals$papi < 1 & !is.na(df_intervals$papi)] <- 1


### MCS variables
df_intervals <- df_intervals %>% 
  group_by(PX_ID) %>%
  mutate(perc_LVAD_ever = case_when(perc_LVAD == '1' ~ '1', TRUE ~ NA_character_)) %>%
  fill(perc_LVAD_ever, .direction = 'down') %>%
  mutate(perc_LVAD_ever = case_when(is.na(perc_LVAD_ever) ~ '0', TRUE ~ perc_LVAD_ever))


df_intervals <- df_intervals %>%
  mutate(short_MCS_French = 
           case_when((ECMO == '1' & status == '1') | IABP == '1' ~ 1,
             TRUE ~ 0)) %>% 
  mutate(short_MCS_French_new = 
           case_when((ECMO == '1' & status == '1') ~ 1,
             TRUE ~ 0)) %>% 
  mutate(short_MCS_ever = 
           case_when(ECMO_ever == '1' | temp_surg_ever == '1' | BiVAD_no_discharge_ever == '1' ~ 1,
             TRUE ~ 0),
         short_MCS_ever_with_BP_perc = case_when(
           IABP_ever == '1' | perc_LVAD_ever == '1' ~ 1,
           TRUE ~ short_MCS_ever))



### Split into training and testing
set.seed(200)
center_ids_train <- sample(x = unique(df_intervals$CenterId), 
                           size = ceiling(0.7*length(unique(df_intervals$CenterId))), 
                           replace = F)
df_intervals$train_test <-  'Test'
df_intervals$train_test[df_intervals$CenterId %in% center_ids_train] <- 'Train'

save(center_ids_train, file = './train_ids.RData')


save(df_intervals, file = './df_intervals_setup.RData') ### Save a cleaner copy
```


---------------------------------


# 2. Set up matrices for predictions

### Training matrices

```{r, warning=F, comment=NA}
interval_dummies_train <- predict(
  caret::dummyVars(~ diagnosis + dobutamine + dopamine + epinephrine + milrinone, 
                   data = df_intervals[df_intervals$train_test == 'Train', ],
                   sep = NULL,
                   fullrank = T), 
  newdata = df_intervals[df_intervals$train_test == 'Train', ])
interval_dummies_train <- as.data.frame(interval_dummies_train)
interval_dummies_train <- interval_dummies_train %>% 
  select(-c(diagnosisDilated_CM, `dobutamineNot High`, `dopamineNot High`, 
            `epinephrineNot High`, `milrinoneNot High`))



mat_train <- data.frame(cbind(
  df_intervals[df_intervals$train_test == 'Train', ]$death6week,
  bs(df_intervals[df_intervals$train_test == 'Train', ]$interval, knots=3), 
  bs(df_intervals[df_intervals$train_test == 'Train', ]$age, knots=3),
  df_intervals[df_intervals$train_test == 'Train', ]$diabetes, 
  df_intervals[df_intervals$train_test == 'Train', ]$dialysis, 
  interval_dummies_train, 
  df_intervals[df_intervals$train_test == 'Train', ]$IABP,
  df_intervals[df_intervals$train_test == 'Train', ]$ECMO, 
  df_intervals[df_intervals$train_test == 'Train', ]$LVAD, 
  df_intervals[df_intervals$train_test == 'Train', ]$MCSD_complication, 
  df_intervals[df_intervals$train_test == 'Train', ]$systolicBP,
  df_intervals[df_intervals$train_test == 'Train', ]$diastolicBP, 
  df_intervals[df_intervals$train_test == 'Train', ]$PASP, 
  df_intervals[df_intervals$train_test == 'Train', ]$PADP, 
  df_intervals[df_intervals$train_test == 'Train', ]$heart_rate,
  df_intervals[df_intervals$train_test == 'Train', ]$cardiac_output, 
  df_intervals[df_intervals$train_test == 'Train', ]$central_venous_pressure, 
  df_intervals[df_intervals$train_test == 'Train', ]$arterial_lactate,
  df_intervals[df_intervals$train_test == 'Train', ]$cpo, 
  df_intervals[df_intervals$train_test == 'Train', ]$api, 
  df_intervals[df_intervals$train_test == 'Train', ]$papi, 
  df_intervals[df_intervals$train_test == 'Train', ]$hemoglobin, 
  df_intervals[df_intervals$train_test == 'Train', ]$albumin, 
  df_intervals[df_intervals$train_test == 'Train', ]$bilirubin,
  df_intervals[df_intervals$train_test == 'Train', ]$eGFR, 
  df_intervals[df_intervals$train_test == 'Train', ]$sodium, 
  df_intervals[df_intervals$train_test == 'Train', ]$AST, 
  df_intervals[df_intervals$train_test == 'Train', ]$BNP,
  df_intervals[df_intervals$train_test == 'Train', ]$BNP_NT_Pro,
  df_intervals[df_intervals$train_test == 'Train', ]$BUN, 
  df_intervals[df_intervals$train_test == 'Train', ]$INR, 
  df_intervals[df_intervals$train_test == 'Train', ]$life_arrhythmia,
  df_intervals[df_intervals$train_test == 'Train', ]$BiVAD_no_discharge,
  df_intervals[df_intervals$train_test == 'Train', ]$temp_surg_LVAD,
  df_intervals[df_intervals$train_test == 'Train', ]$other_durable_MCSD,
  df_intervals[df_intervals$train_test == 'Train', ]$MCSD_malfunction,
  df_intervals[df_intervals$train_test == 'Train', ]$v_tach_fib,
  df_intervals[df_intervals$train_test == 'Train', ]$perc_LVAD,
  df_intervals[df_intervals$train_test == 'Train', ]$MCSD_hemolysis,
  df_intervals[df_intervals$train_test == 'Train', ]$MCSD_rhf,
  df_intervals[df_intervals$train_test == 'Train', ]$MCSD_device_infx,
  df_intervals[df_intervals$train_test == 'Train', ]$MCSD_bleed,
  df_intervals[df_intervals$train_test == 'Train', ]$MCSD_aortic_insf,
  df_intervals[df_intervals$train_test == 'Train', ]$angina))


mat_train_all <- cbind(mat_train,
                       df_intervals[df_intervals$train_test == 'Train', ]$temp_surg_MCS_ever,
                       df_intervals[df_intervals$train_test == 'Train', ]$BiVAD_no_discharge_ever,
                       df_intervals[df_intervals$train_test == 'Train', ]$IV_inotropes_ever,
                       df_intervals[df_intervals$train_test == 'Train', ]$IABP_ever,
                       df_intervals[df_intervals$train_test == 'Train', ]$ECMO_ever,
                       df_intervals[df_intervals$train_test == 'Train', ]$BiVAD_ever,
                       df_intervals[df_intervals$train_test == 'Train', ]$LVAD_ever,
                       df_intervals[df_intervals$train_test == 'Train', ]$RVAD_ever,
                       df_intervals[df_intervals$train_test == 'Train', ]$short_MCS_ever,
                       
                       df_intervals[df_intervals$train_test == 'Train', ]$sodium_min,
                       df_intervals[df_intervals$train_test == 'Train', ]$creatinine_min,
                       df_intervals[df_intervals$train_test == 'Train', ]$bilirubin_min,
                       df_intervals[df_intervals$train_test == 'Train', ]$albumin_min,
                       df_intervals[df_intervals$train_test == 'Train', ]$arterial_lactate_min,
                       df_intervals[df_intervals$train_test == 'Train', ]$BUN_min,
                       df_intervals[df_intervals$train_test == 'Train', ]$AST_min,
                       df_intervals[df_intervals$train_test == 'Train', ]$INR_min,
                       df_intervals[df_intervals$train_test == 'Train', ]$BNP_min,
                       
                       df_intervals[df_intervals$train_test == 'Train', ]$sodium_max,
                       df_intervals[df_intervals$train_test == 'Train', ]$creatinine_max,
                       df_intervals[df_intervals$train_test == 'Train', ]$bilirubin_max,
                       df_intervals[df_intervals$train_test == 'Train', ]$albumin_max,
                       df_intervals[df_intervals$train_test == 'Train', ]$arterial_lactate_max,
                       df_intervals[df_intervals$train_test == 'Train', ]$BUN_max,
                       df_intervals[df_intervals$train_test == 'Train', ]$AST_max,
                       df_intervals[df_intervals$train_test == 'Train', ]$INR_max,
                       df_intervals[df_intervals$train_test == 'Train', ]$BNP_max,
                       df_intervals[df_intervals$train_test == 'Train', ]$sodium_slope,
                       df_intervals[df_intervals$train_test == 'Train', ]$creatinine_slope,
                       df_intervals[df_intervals$train_test == 'Train', ]$bilirubin_slope,
                       df_intervals[df_intervals$train_test == 'Train', ]$albumin_slope,
                       df_intervals[df_intervals$train_test == 'Train', ]$arterial_lactate_slope,
                       df_intervals[df_intervals$train_test == 'Train', ]$BUN_slope,
                       df_intervals[df_intervals$train_test == 'Train', ]$AST_slope,
                       df_intervals[df_intervals$train_test == 'Train', ]$INR_slope,
                       df_intervals[df_intervals$train_test == 'Train', ]$BNP_slope)


names(mat_train) <- c('Death', 'Interval_1', 'Interval_2', 'Interval_3', 'Interval_4',
                      'Age10_1', 'Age10_2', 'Age10_3', 'Age10_4', 'Diabetes', 'Dialysis', 
                      'Diag_Amyloid', 'Diag_Congenital', 'Diag_Hypertrophic', 'Diag_Ischemic',
                      'Diag_Other', 'Diag_Retransplant', 'Diag_Restricted', 'Diag_Valvular',
                      'Dobutamine_High', 'Dopamine_High', 'Epinephrine_High', 'Milrinone_High', 
                      'IABP', 'ECMO', 'LVAD', 'MCSD_Complication', 'SystolicBP', 'DiastolicBP', 
                      'PASP', 'PADP', 'Heart_Rate10', 'Cardiac_Output', 'Central_Venous_Pressure',
                      'Arterial_Lactate', 'CPO', 'API', 'PAPI', 'Hemoglobin', 'Albumin', 'Bilirubin', 
                      'eGFR', 'Sodium', 'AST100', 'BNP100', 'BNP_NT_Pro', 'BUN10', 'INR', 'Life_Arrhythmia',
                      'BiVAD_NoDischarge', 'TempSurgery_LVAD', 'Other_DurableMCSD', 'MCSD_Malfunction',
                      'VTach_Fib', 'Perc_LVAD', 'MCSD_Hemolysis', 'MCSD_Rhf', 'MCSD_DeviceInfection',
                      'MCSD_Bleed', 'MCSD_Aortic_Insufficent', 'Angina')
                          
                          
names(mat_train_all) <-  c('Death', 'Interval_1', 'Interval_2', 'Interval_3', 'Interval_4',
                           'Age10_1', 'Age10_2', 'Age10_3', 'Age10_4', 'Diabetes', 'Dialysis', 
                           'Diag_Amyloid', 'Diag_Congenital', 'Diag_Hypertrophic', 'Diag_Ischemic',
                           'Diag_Other', 'Diag_Retransplant', 'Diag_Restricted', 'Diag_Valvular',
                           'Dobutamine_High', 'Dopamine_High', 'Epinephrine_High', 'Milrinone_High', 
                           'IABP', 'ECMO', 'LVAD', 'MCSD_Complication', 'SystolicBP', 'DiastolicBP', 
                           'PASP', 'PADP', 'Heart_Rate10', 'Cardiac_Output', 'Central_Venous_Pressure',
                           'Arterial_Lactate', 'CPO', 'API', 'PAPI', 'Hemoglobin', 'Albumin', 'Bilirubin', 
                           'eGFR', 'Sodium', 'AST100', 'BNP100', 'BNP_NT_Pro', 'BUN10', 'INR', 'Life_Arrhythmia',
                           'BiVAD_NoDischarge', 'TempSurgery_LVAD', 'Other_DurableMCSD', 'MCSD_Malfunction',
                           'VTach_Fib', 'Perc_LVAD', 'MCSD_Hemolysis', 'MCSD_Rhf', 'MCSD_DeviceInfection',
                           'MCSD_Bleed', 'MCSD_Aortic_Insufficent', 'Angina',
                          
                           'Temp_Surg_Ever', 'BiVAD_No_Discharge_Ever', 'IV_Inotropes_Ever', 'IABP_Ever', 
                           'ECMO_Ever', 'BiVAD_Ever', 'LVAD_Ever', 'RVAD_Ever', 'Short_MCS_Ever',
                           
                           'Sodium_Min', 'Creatinine_Min', 'Bilirubin_Min', 'Albumin_Min', 'Arterial_Lactate_Min',
                           'BUN10_Min', 'AST100_Min', 'INR_Min', 'BNP100_Min',
                           
                           'Sodium_Max', 'Creatinine_Max', 'Bilirubin_Max', 'Albumin_Max', 'Arterial_Lactate_Max',
                           'BUN10_Max', 'AST100_Max', 'INR_Max', 'BNP100_Max',
                           
                           'Sodium_Slope', 'Creatinine_Slope', 'Bilirubin_Slope', 'Albumin_Slope',
                           'Arterial_Lactate_Slope', 'BUN10_Slope', 'AST100_Slope', 'INR_Slope', 'BNP100_Slope')
```


### Testing matrices

```{r, warning=F, comment=NA}
## Testing matrix
interval_dummies_test <- predict(
  caret::dummyVars(~ diagnosis + dobutamine + dopamine + epinephrine + milrinone, 
                   data = df_intervals[df_intervals$train_test == 'Test', ],
                   sep = NULL,
                   fullrank = T), 
  newdata = df_intervals[df_intervals$train_test == 'Test', ])
interval_dummies_test <- as.data.frame(interval_dummies_test)
interval_dummies_test <- interval_dummies_test %>% 
  select(-c(diagnosisDilated_CM, `dobutamineNot High`, `dopamineNot High`, 
            `epinephrineNot High`, `milrinoneNot High`))



mat_test <- data.frame(cbind(
  df_intervals[df_intervals$train_test == 'Test', ]$death6week,
  bs(df_intervals[df_intervals$train_test == 'Test', ]$interval, knots=3), 
  bs(df_intervals[df_intervals$train_test == 'Test', ]$age, knots=3),
  df_intervals[df_intervals$train_test == 'Test', ]$diabetes, 
  df_intervals[df_intervals$train_test == 'Test', ]$dialysis, 
  interval_dummies_test, 
  df_intervals[df_intervals$train_test == 'Test', ]$IABP,
  df_intervals[df_intervals$train_test == 'Test', ]$ECMO, 
  df_intervals[df_intervals$train_test == 'Test', ]$LVAD, 
  df_intervals[df_intervals$train_test == 'Test', ]$MCSD_complication, 
  df_intervals[df_intervals$train_test == 'Test', ]$systolicBP,
  df_intervals[df_intervals$train_test == 'Test', ]$diastolicBP, 
  df_intervals[df_intervals$train_test == 'Test', ]$PASP, 
  df_intervals[df_intervals$train_test == 'Test', ]$PADP, 
  df_intervals[df_intervals$train_test == 'Test', ]$heart_rate,
  df_intervals[df_intervals$train_test == 'Test', ]$cardiac_output, 
  df_intervals[df_intervals$train_test == 'Test', ]$central_venous_pressure, 
  df_intervals[df_intervals$train_test == 'Test', ]$arterial_lactate,
  df_intervals[df_intervals$train_test == 'Test', ]$cpo, 
  df_intervals[df_intervals$train_test == 'Test', ]$api, 
  df_intervals[df_intervals$train_test == 'Test', ]$papi,
  df_intervals[df_intervals$train_test == 'Test', ]$hemoglobin, 
  df_intervals[df_intervals$train_test == 'Test', ]$albumin, 
  df_intervals[df_intervals$train_test == 'Test', ]$bilirubin,
  df_intervals[df_intervals$train_test == 'Test', ]$eGFR, 
  df_intervals[df_intervals$train_test == 'Test', ]$sodium, 
  df_intervals[df_intervals$train_test == 'Test', ]$AST, 
  df_intervals[df_intervals$train_test == 'Test', ]$BNP,
  df_intervals[df_intervals$train_test == 'Test', ]$BNP_NT_Pro,
  df_intervals[df_intervals$train_test == 'Test', ]$BUN, 
  df_intervals[df_intervals$train_test == 'Test', ]$INR, 
  df_intervals[df_intervals$train_test == 'Test', ]$life_arrhythmia,
  df_intervals[df_intervals$train_test == 'Test', ]$BiVAD_no_discharge,
  df_intervals[df_intervals$train_test == 'Test', ]$temp_surg_LVAD,
  df_intervals[df_intervals$train_test == 'Test', ]$other_durable_MCSD,
  df_intervals[df_intervals$train_test == 'Test', ]$MCSD_malfunction,
  df_intervals[df_intervals$train_test == 'Test', ]$v_tach_fib,
  df_intervals[df_intervals$train_test == 'Test', ]$perc_LVAD,
  df_intervals[df_intervals$train_test == 'Test', ]$MCSD_hemolysis,
  df_intervals[df_intervals$train_test == 'Test', ]$MCSD_rhf,
  df_intervals[df_intervals$train_test == 'Test', ]$MCSD_device_infx,
  df_intervals[df_intervals$train_test == 'Test', ]$MCSD_bleed,
  df_intervals[df_intervals$train_test == 'Test', ]$MCSD_aortic_insf,
  df_intervals[df_intervals$train_test == 'Test', ]$angina))


mat_test_all <- cbind(mat_test,
                      df_intervals[df_intervals$train_test == 'Test', ]$temp_surg_MCS_ever,
                      df_intervals[df_intervals$train_test == 'Test', ]$BiVAD_no_discharge_ever,
                      df_intervals[df_intervals$train_test == 'Test', ]$IV_inotropes_ever,
                      df_intervals[df_intervals$train_test == 'Test', ]$IABP_ever,
                      df_intervals[df_intervals$train_test == 'Test', ]$ECMO_ever,
                      df_intervals[df_intervals$train_test == 'Test', ]$BiVAD_ever,
                      df_intervals[df_intervals$train_test == 'Test', ]$LVAD_ever,
                      df_intervals[df_intervals$train_test == 'Test', ]$RVAD_ever,
                      df_intervals[df_intervals$train_test == 'Test', ]$short_MCS_ever,
                      
                      df_intervals[df_intervals$train_test == 'Test', ]$sodium_min,
                      df_intervals[df_intervals$train_test == 'Test', ]$creatinine_min,
                      df_intervals[df_intervals$train_test == 'Test', ]$bilirubin_min,
                      df_intervals[df_intervals$train_test == 'Test', ]$albumin_min,
                      df_intervals[df_intervals$train_test == 'Test', ]$arterial_lactate_min,
                      df_intervals[df_intervals$train_test == 'Test', ]$BUN_min,
                      df_intervals[df_intervals$train_test == 'Test', ]$AST_min,
                      df_intervals[df_intervals$train_test == 'Test', ]$INR_min,
                      df_intervals[df_intervals$train_test == 'Test', ]$BNP_min,
                      
                      df_intervals[df_intervals$train_test == 'Test', ]$sodium_max,
                      df_intervals[df_intervals$train_test == 'Test', ]$creatinine_max,
                      df_intervals[df_intervals$train_test == 'Test', ]$bilirubin_max,
                      df_intervals[df_intervals$train_test == 'Test', ]$albumin_max,
                      df_intervals[df_intervals$train_test == 'Test', ]$arterial_lactate_max,
                      df_intervals[df_intervals$train_test == 'Test', ]$BUN_max,
                      df_intervals[df_intervals$train_test == 'Test', ]$AST_max,
                      df_intervals[df_intervals$train_test == 'Test', ]$INR_max,
                      df_intervals[df_intervals$train_test == 'Test', ]$BNP_max,
                      
                      df_intervals[df_intervals$train_test == 'Test', ]$sodium_slope,
                      df_intervals[df_intervals$train_test == 'Test', ]$creatinine_slope,
                      df_intervals[df_intervals$train_test == 'Test', ]$bilirubin_slope,
                      df_intervals[df_intervals$train_test == 'Test', ]$albumin_slope,
                      df_intervals[df_intervals$train_test == 'Test', ]$arterial_lactate_slope,
                      df_intervals[df_intervals$train_test == 'Test', ]$BUN_slope,
                      df_intervals[df_intervals$train_test == 'Test', ]$AST_slope,
                      df_intervals[df_intervals$train_test == 'Test', ]$INR_slope,
                      df_intervals[df_intervals$train_test == 'Test', ]$BNP_slope)


names(mat_test) <- c('Death', 'Interval_1', 'Interval_2', 'Interval_3', 'Interval_4',
                      'Age10_1', 'Age10_2', 'Age10_3', 'Age10_4', 'Diabetes', 'Dialysis', 
                      'Diag_Amyloid', 'Diag_Congenital', 'Diag_Hypertrophic', 'Diag_Ischemic',
                      'Diag_Other', 'Diag_Retransplant', 'Diag_Restricted', 'Diag_Valvular',
                      'Dobutamine_High', 'Dopamine_High', 'Epinephrine_High', 'Milrinone_High', 
                      'IABP', 'ECMO', 'LVAD', 'MCSD_Complication', 'SystolicBP', 'DiastolicBP', 
                      'PASP', 'PADP', 'Heart_Rate10', 'Cardiac_Output', 'Central_Venous_Pressure',
                      'Arterial_Lactate', 'CPO', 'API', 'PAPI', 'Hemoglobin', 'Albumin', 'Bilirubin', 
                      'eGFR', 'Sodium', 'AST100', 'BNP100', 'BNP_NT_Pro', 'BUN10', 'INR', 'Life_Arrhythmia',
                      'BiVAD_NoDischarge', 'TempSurgery_LVAD', 'Other_DurableMCSD', 'MCSD_Malfunction',
                      'VTach_Fib', 'Perc_LVAD', 'MCSD_Hemolysis', 'MCSD_Rhf', 'MCSD_DeviceInfection',
                      'MCSD_Bleed', 'MCSD_Aortic_Insufficent', 'Angina')
                          
                          
names(mat_test_all) <- c('Death', 'Interval_1', 'Interval_2', 'Interval_3', 'Interval_4',
                          'Age10_1', 'Age10_2', 'Age10_3', 'Age10_4', 'Diabetes', 'Dialysis', 
                          'Diag_Amyloid', 'Diag_Congenital', 'Diag_Hypertrophic', 'Diag_Ischemic',
                          'Diag_Other', 'Diag_Retransplant', 'Diag_Restricted', 'Diag_Valvular',
                          'Dobutamine_High', 'Dopamine_High', 'Epinephrine_High', 'Milrinone_High', 
                          'IABP', 'ECMO', 'LVAD', 'MCSD_Complication', 'SystolicBP', 'DiastolicBP', 
                          'PASP', 'PADP', 'Heart_Rate10', 'Cardiac_Output', 'Central_Venous_Pressure',
                          'Arterial_Lactate', 'CPO', 'API', 'PAPI', 'Hemoglobin', 'Albumin', 'Bilirubin', 
                          'eGFR', 'Sodium', 'AST100', 'BNP100', 'BNP_NT_Pro', 'BUN10', 'INR', 'Life_Arrhythmia',
                          'BiVAD_NoDischarge', 'TempSurgery_LVAD', 'Other_DurableMCSD', 'MCSD_Malfunction',
                          'VTach_Fib', 'Perc_LVAD', 'MCSD_Hemolysis', 'MCSD_Rhf', 'MCSD_DeviceInfection',
                          'MCSD_Bleed', 'MCSD_Aortic_Insufficent', 'Angina',
                          
                          'Temp_Surg_Ever', 'BiVAD_No_Discharge_Ever', 'IV_Inotropes_Ever', 'IABP_Ever', 
                          'ECMO_Ever', 'BiVAD_Ever', 'LVAD_Ever', 'RVAD_Ever', 'Short_MCS_Ever',
                          
                          'Sodium_Min', 'Creatinine_Min', 'Bilirubin_Min', 'Albumin_Min', 'Arterial_Lactate_Min',
                          'BUN10_Min', 'AST100_Min', 'INR_Min', 'BNP100_Min',
                          
                          'Sodium_Max', 'Creatinine_Max', 'Bilirubin_Max', 'Albumin_Max', 'Arterial_Lactate_Max',
                          'BUN10_Max', 'AST100_Max', 'INR_Max', 'BNP100_Max',
                          
                          'Sodium_Slope', 'Creatinine_Slope', 'Bilirubin_Slope', 'Albumin_Slope',
                          'Arterial_Lactate_Slope', 'BUN10_Slope', 'AST100_Slope', 'INR_Slope', 'BNP100_Slope')



mat_test_numeric <- mat_test  %>% select(-Death) %>% mutate_all(as.numeric)
mat_test_numeric$`(Intercept)` <- 1
mat_test_numeric <- mat_test_numeric[ , c('(Intercept)', 'Interval_1', 'Interval_2', 'Interval_3', 'Interval_4',
                                          'Age10_1', 'Age10_2', 'Age10_3', 'Age10_4', 'Diabetes', 'Dialysis',
                                          'Diag_Amyloid', 'Diag_Congenital', 'Diag_Hypertrophic', 'Diag_Ischemic',
                                          'Diag_Other', 'Diag_Retransplant', 'Diag_Restricted', 'Diag_Valvular',
                                          'Dobutamine_High', 'Dopamine_High', 'Epinephrine_High', 'Milrinone_High', 
                                          'IABP', 'ECMO', 'LVAD', 'MCSD_Complication', 'SystolicBP',
                                          'DiastolicBP', 'PASP', 'PADP', 'Heart_Rate10', 'Cardiac_Output',
                                          'Central_Venous_Pressure', 'Arterial_Lactate', 'CPO', 'API', 'PAPI',
                                          'Hemoglobin', 'Albumin', 'Bilirubin', 'eGFR', 'Sodium', 
                                          'AST100', 'BNP100', 'BNP_NT_Pro', 'BUN10', 'INR',
                                          'Life_Arrhythmia', 'BiVAD_NoDischarge', 'TempSurgery_LVAD',
                                          'Other_DurableMCSD', 'MCSD_Malfunction', 'VTach_Fib', 'Perc_LVAD',
                                          'MCSD_Hemolysis', 'MCSD_Rhf', 'MCSD_DeviceInfection', 'MCSD_Bleed',
                                          'MCSD_Aortic_Insufficent', 'Angina')]
mat_test_numeric <- mat_test_numeric %>% mutate_all(as.numeric)


mat_test_all_numeric <- mat_test_all %>% select(-Death) %>% mutate_all(as.numeric)
names(mat_test_all_numeric) <- c('Interval_1', 'Interval_2', 'Interval_3', 'Interval_4',
                                 'Age10_1', 'Age10_2', 'Age10_3', 'Age10_4', 'Diabetes', 'Dialysis',
                                 'Diag_Amyloid', 'Diag_Congenital', 'Diag_Hypertrophic', 'Diag_Ischemic',
                                 'Diag_Other', 'Diag_Retransplant', 'Diag_Restricted', 'Diag_Valvular',
                                 'Dobutamine_High', 'Dopamine_High', 'Epinephrine_High', 'Milrinone_High', 
                                 'IABP', 'ECMO', 'LVAD', 'MCSD_Complication', 'SystolicBP',
                                 'DiastolicBP', 'PASP', 'PADP', 'Heart_Rate10', 'Cardiac_Output',
                                 'Central_Venous_Pressure', 'Arterial_Lactate', 'CPO', 'API', 'PAPI',
                                 'Hemoglobin', 'Albumin', 'Bilirubin', 'eGFR', 'Sodium', 
                                 'AST100', 'BNP100', 'BNP_NT_Pro', 'BUN10', 'INR',
                                 'Life_Arrhythmia', 'BiVAD_NoDischarge', 'TempSurgery_LVAD', 'Other_DurableMCSD',
                                 'MCSD_Malfunction', 'VTach_Fib', 'Perc_LVAD', 'MCSD_Hemolysis', 'MCSD_Rhf',
                                 'MCSD_DeviceInfection', 'MCSD_Bleed', 'MCSD_Aortic_Insufficent', 'Angina',
                                 
                                 'Temp_Surg_Ever', 'BiVAD_No_Discharge_Ever', 'IV_Inotropes_Ever', 'IABP_Ever', 
                                 'ECMO_Ever', 'BiVAD_Ever', 'LVAD_Ever', 'RVAD_Ever', 'Short_MCS_Ever',
                                 
                                 'Sodium_Min', 'Creatinine_Min', 'Bilirubin_Min', 'Albumin_Min', 
                                 'Arterial_Lactate_Min', 'BUN10_Min', 'AST100_Min', 'INR_Min', 'BNP100_Min',
                                 
                                 'Sodium_Max', 'Creatinine_Max', 'Bilirubin_Max', 'Albumin_Max',
                                 'Arterial_Lactate_Max', 'BUN10_Max', 'AST100_Max', 'INR_Max', 'BNP100_Max',
                                   
                                 'Sodium_Slope', 'Creatinine_Slope', 'Bilirubin_Slope',
                                 'Albumin_Slope', 'Arterial_Lactate_Slope', 'BUN10_Slope', 'AST100_Slope', 
                                 'INR_Slope', 'BNP100_Slope')

mat_test_all_numeric$`(Intercept)` <- 1
mat_test_all_numeric <- mat_test_all_numeric[ , c('(Intercept)', 
                                                  'Interval_1', 'Interval_2', 'Interval_3', 'Interval_4',
                                                  'Age10_1', 'Age10_2', 'Age10_3', 'Age10_4', 'Diabetes', 'Dialysis',
                                                  'Diag_Congenital', 'Diag_Hypertrophic', 'Diag_Ischemic',
                                                  'Diag_Other', 'Diag_Retransplant', 'Diag_Restricted', 'Diag_Valvular',
                                                  'Dobutamine_High', 'Dopamine_High', 
                                                  'Epinephrine_High', 'Milrinone_High',
                                                  'IABP', 'ECMO', 'LVAD', 'MCSD_Complication', 'SystolicBP',
                                                  'DiastolicBP', 'PASP', 'PADP', 'Heart_Rate10', 'Cardiac_Output',
                                                  'Central_Venous_Pressure', 'Arterial_Lactate', 'Hemoglobin',
                                                  'Albumin', 'Bilirubin', 'eGFR', 'Sodium', 'AST100', 'BNP100',
                                                  'BNP_NT_Pro', 'BUN10', 'INR', 'Life_Arrhythmia', 'BiVAD_NoDischarge',
                                                  'TempSurgery_LVAD', 'Other_DurableMCSD', 
                                                  'MCSD_Malfunction', 'VTach_Fib',
                                                  'Perc_LVAD', 'MCSD_Hemolysis', 'MCSD_Rhf',
                                                  'MCSD_DeviceInfection', 'MCSD_Bleed', 
                                                  'MCSD_Aortic_Insufficent', 'Angina',
                                 
                                                  'Temp_Surg_Ever', 'BiVAD_No_Discharge_Ever', 
                                                  'IV_Inotropes_Ever', 'IABP_Ever', 'ECMO_Ever', 
                                                  'BiVAD_Ever', 'LVAD_Ever', 'RVAD_Ever', 'Short_MCS_Ever',
                                 
                                                  'Sodium_Min', 'Creatinine_Min', 'Bilirubin_Min', 'Albumin_Min',
                                                  'Arterial_Lactate_Min', 'BUN10_Min', 'AST100_Min', 
                                                  'INR_Min', 'BNP100_Min',
                                                  
                                                  'Sodium_Max', 'Creatinine_Max', 'Bilirubin_Max', 'Albumin_Max',
                                                  'Arterial_Lactate_Max', 'BUN10_Max', 
                                                  'AST100_Max', 'INR_Max', 'BNP100_Max',
                                   
                                                  'Sodium_Slope', 'Creatinine_Slope', 'Bilirubin_Slope',
                                                  'Albumin_Slope', 'Arterial_Lactate_Slope', 'BUN10_Slope', 
                                                  'AST100_Slope', 'INR_Slope', 'BNP100_Slope')]



df_intervals_test <- subset(df_intervals, df_intervals$train_test == 'Test')
df_intervals_test$status_initial <- factor(df_intervals_test$status_initial, 
                                           levels=c('1', '2', '3', '4', '5', '6'), ordered=T)
df_intervals_test$train_test <- NULL
```


### Matrices for gradient-boosted models

```{r, warning=F, comment=NA}
DMat_test <- xgb.DMatrix(as.matrix(mat_test_numeric[,c('(Intercept)', 
                                                       'Interval_1', 'Interval_2', 'Interval_3', 'Interval_4',
                                                       'Age10_1', 'Age10_2', 'Age10_3', 'Age10_4', 
                                                       'Diabetes', 'Dialysis',
                                                       'Diag_Congenital', 'Diag_Hypertrophic',
                                                       'Diag_Ischemic', 'Diag_Other', 'Diag_Retransplant',
                                                       'Diag_Restricted', 'Diag_Valvular', 'Dobutamine_High',
                                                       'Dopamine_High', 'Epinephrine_High', 'Milrinone_High',
                                                       'IABP', 'ECMO', 'LVAD', 'MCSD_Complication', 'SystolicBP',
                                                       'DiastolicBP', 'PASP', 'PADP', 'Heart_Rate10', 
                                                       'Cardiac_Output', 'Central_Venous_Pressure', 
                                                       'Arterial_Lactate', 'Hemoglobin',
                                                       'Albumin', 'Bilirubin', 'eGFR', 'Sodium', 'AST100', 'BNP100',
                                                       'BNP_NT_Pro', 'BUN10', 'INR', 
                                                       'Life_Arrhythmia', 'BiVAD_NoDischarge',
                                                       'TempSurgery_LVAD', 'Other_DurableMCSD', 'MCSD_Malfunction',
                                                       'VTach_Fib', 'Perc_LVAD', 'MCSD_Hemolysis', 'MCSD_Rhf',
                                                       'MCSD_DeviceInfection', 'MCSD_Bleed', 'MCSD_Aortic_Insufficent',
                                                       'Angina')]))
DMat_test_all <- xgb.DMatrix(as.matrix(mat_test_all_numeric))




colnames(DMat_test) <- c('(Intercept)', 'Interval_1', 'Interval_2', 'Interval_3', 'Interval_4',
                         'Age10_1', 'Age10_2', 'Age10_3', 'Age10_4', 'Diabetes1', 'Dialysis1',
                         'Diag_Congenital', 'Diag_Hypertrophic', 'Diag_Ischemic',
                         'Diag_Other', 'Diag_Retransplant', 'Diag_Restricted', 'Diag_Valvular',
                         'Dobutamine_High', 'Dopamine_High', 'Epinephrine_High', 'Milrinone_High', 'IABP1', 'ECMO1',
                         'LVAD1', 'MCSD_Complication1', 'SystolicBP', 'DiastolicBP', 'PASP', 'PADP',
                         'Heart_Rate10', 'Cardiac_Output', 'Central_Venous_Pressure',
                         'Arterial_Lactate', 'Hemoglobin', 'Albumin',
                         'Bilirubin', 'eGFR', 'Sodium', 'AST100', 'BNP100', 'BNP_NT_Pro1', 'BUN10', 'INR',
                         'Life_Arrhythmia1', 'BiVAD_NoDischarge1', 'TempSurgery_LVAD1', 'Other_DurableMCSD1',
                         'MCSD_Malfunction1', 'VTach_Fib1', 'Perc_LVAD1', 'MCSD_Hemolysis1', 'MCSD_Rhf1',
                         'MCSD_DeviceInfection1', 'MCSD_Bleed1', 'MCSD_Aortic_Insufficent1', 'Angina1')


colnames(DMat_test_all) <- c('(Intercept)', 'Interval_1', 'Interval_2', 'Interval_3', 'Interval_4',
                             'Age10_1', 'Age10_2', 'Age10_3', 'Age10_4', 'Diabetes1', 'Dialysis1',
                             'Diag_Congenital', 'Diag_Hypertrophic', 'Diag_Ischemic',
                             'Diag_Other', 'Diag_Retransplant', 'Diag_Restricted', 'Diag_Valvular',
                             'Dobutamine_High', 'Dopamine_High', 'Epinephrine_High', 'Milrinone_High', 'IABP1', 'ECMO1',
                             'LVAD1', 'MCSD_Complication1', 'SystolicBP', 'DiastolicBP', 'PASP', 'PADP',
                             'Heart_Rate10', 'Cardiac_Output', 'Central_Venous_Pressure',
                             'Arterial_Lactate', 'Hemoglobin', 'Albumin',
                             'Bilirubin', 'eGFR', 'Sodium', 'AST100', 'BNP100', 'BNP_NT_Pro1', 'BUN10', 'INR',
                             'Life_Arrhythmia1', 'BiVAD_NoDischarge1', 'TempSurgery_LVAD1', 'Other_DurableMCSD1',
                             'MCSD_Malfunction1', 'VTach_Fib1', 'Perc_LVAD1', 'MCSD_Hemolysis1', 'MCSD_Rhf1',
                             'MCSD_DeviceInfection1', 'MCSD_Bleed1', 'MCSD_Aortic_Insufficent1', 'Angina1',
                             
                             'Temp_Surg_Ever1', 'BiVAD_No_Discharge_Ever1', 'IV_Inotropes_Ever1', 
                             'IABP_Ever1', 'ECMO_Ever1','BiVAD_Ever1', 'LVAD_Ever1', 'RVAD_Ever1', 'Short_MCS_Ever',
                             
                             'Sodium_Min', 'Creatinine_Min', 'Bilirubin_Min', 'Albumin_Min', 
                             'Arterial_Lactate_Min', 'BUN10_Min', 'AST100_Min', 'INR_Min', 'BNP100_Min',
                             
                             'Sodium_Max', 'Creatinine_Max', 'Bilirubin_Max', 'Albumin_Max', 
                             'Arterial_Lactate_Max', 'BUN10_Max', 'AST100_Max', 'INR_Max', 'BNP100_Max',
                             
                             'Sodium_Slope', 'Creatinine_Slope', 'Bilirubin_Slope', 'Albumin_Slope', 
                             'Arterial_Lactate_Slope', 'BUN10_Slope', 'AST100_Slope', 'INR_Slope', 'BNP100_Slope')
```


-------------


# 3. Run selected logistic regression models and create coefficient plots
All models are run in the training datasets.


### 6-Status Model

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model6status <- glm(formula = as.formula(
  death6week ~ status), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
  
save(model6status, file = './model_6status.RData') 
```


### Selected Model #1: Prior French score (includes balloon pumps)

* Short term MCS (ECMO or Balloon Pump)
* Natural log of (bilirubin + 1)
* eGFR
* Natural log of (BNP + 1) and NT-proBNP interaction


```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_french_old <- glm(formula = as.formula(
  death6week ~ 
    short_MCS_French + log(bilirubin + 1) + eGFR + log(BNP + 1):BNP_NT_Pro), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_french_old_results <- as.data.frame(summary(model_french_old)$coefficients)
model_french_old_results$name <- rownames(model_french_old_results)

model_french_old_results <- model_french_old_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_french_old_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_french_old_results) <- seq(1:nrow(model_french_old_results))
model_french_old_results <- model_french_old_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_french_old_results$Variable <- c('Intercept', 'Short Term MCS', 'Log Bilirubin+1', 'eGFR', 
                                        'Log BNP+1, Regular BNP', 'Log BNP+1, NT-proBNP')

model_french_old_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)

save(model_french_old, file = './model_frenchCRS_old.RData')
```


### Selected Model #2: New French candidate risk score


```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_french_new <- glm(formula = as.formula(
  death6week ~ 
    short_MCS_French_new + log(bilirubin + 1) + eGFR + log(BNP + 1):BNP_NT_Pro), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_french_new_results <- as.data.frame(summary(model_french_new)$coefficients)
model_french_new_results$name <- rownames(model_french_new_results)

model_french_new_results <- model_french_new_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_french_new_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_french_new_results) <- seq(1:nrow(model_french_new_results))
model_french_new_results <- model_french_new_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_french_new_results$Variable <- c('Intercept', 'Short Term MCS', 'Log Bilirubin+1', 'eGFR', 
                                        'Log BNP+1, Regular BNP', 'Log BNP+1, NT-proBNP')

model_french_new_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)

save(model_french_new, file = './model_frenchCRS_new.RData')
```


### Selected Model #3: US candidate risk score with PCWP

* Pulmonary capillary wedge pressure (PCWP)
* Albumin
* Natural log of (bilirubin + 1)
* eGFR
* Sodium
* Natural log of (BNP + 1) and NT-proBNP interaction
* NT-proBNP (removed in a second model)
* LVAD
* Short MCS ever (ECMO ever, temporary surgery LVAD ever, BiVAD no discharge ever)


```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_PCWP <- glm(formula = as.formula(
  death6week ~ 
    PCWP + albumin + log(bilirubin + 1) + eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_PCWP_results <- as.data.frame(summary(model_PCWP)$coefficients)
model_PCWP_results$name <- rownames(model_PCWP_results)

model_PCWP_results <- model_PCWP_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_PCWP_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_PCWP_results) <- seq(1:nrow(model_PCWP_results))
model_PCWP_results <- model_PCWP_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_PCWP_results$Variable <- c('Intercept', 'PCWP', 'Albumin', 'Log Bilirubin+1', 
                             'eGFR', 'Sodium', 'LVAD', 'Short MCS Ever', 
                             'Log BNP+1, Regular BNP',
                             'Log BNP+1, NT-proBNP')

model_PCWP_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


model_PCWP_noBNP <- glm(formula = as.formula(
  death6week ~ 
    PCWP + albumin + log(bilirubin + 1) + eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
```


### Selected Model #4: US candidate risk score with CPO, API

* Replaces PCWP with Cardiac Pressure Output (CPO) and Aortic Pulsatility Index (API)
* CPO = (1/541) x (Cardiac Output) x (2/3 x Systolic BP  +  1/3 x Diastolic BP)
* API = (Systolic BP - Diastolic BP) / PCWP


#### Check that CPO and API are not heavily correlated

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
paste0('Pearson correlation ', cor(df_intervals$cpo, df_intervals$api, 
                                   use = 'pairwise.complete.obs', 
                                   method = 'pearson'))
paste0('Spearman correlation ', cor(df_intervals$cpo, df_intervals$api, 
                                    use = 'pairwise.complete.obs', 
                                    method = 'spearman'))
```


#### Model results

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_CPO_API <- glm(formula = as.formula(
  death6week ~ 
    cpo + api + albumin + log(bilirubin + 1) + eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_CPO_API_results <- as.data.frame(summary(model_CPO_API)$coefficients)
model_CPO_API_results$name <- rownames(model_CPO_API_results)

model_CPO_API_results <- model_CPO_API_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_CPO_API_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_CPO_API_results) <- seq(1:nrow(model_CPO_API_results))
model_CPO_API_results <- model_CPO_API_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_CPO_API_results$Variable <- c('Intercept', 'CPO', 'API', 'Albumin', 
                                    'Log Bilirubin+1', 'eGFR', 
                                    'Sodium', 'LVAD', 'Short MCS Ever', 
                                    'Log BNP+1, Regular BNP',
                                    'Log BNP+1, NT-proBNP')

model_CPO_API_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


model_CPO_API_noBNP <- glm(formula = as.formula(
  death6week ~ 
    cpo + api + albumin + log(bilirubin + 1) + eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
```


### Selected Model #5: US candidate risk score with only CPO


```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_CPO <- glm(formula = as.formula(
  death6week ~ 
    cpo + albumin + log(bilirubin + 1) + eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_CPO_results <- as.data.frame(summary(model_CPO)$coefficients)
model_CPO_results$name <- rownames(model_CPO_results)

model_CPO_results <- model_CPO_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_CPO_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_CPO_results) <- seq(1:nrow(model_CPO_results))
model_CPO_results <- model_CPO_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_CPO_results$Variable <- c('Intercept', 'CPO', 'Albumin', 'Log Bilirubin+1', 
                                'eGFR', 'Sodium', 'LVAD', 'Short MCS Ever', 
                                'Log BNP+1, Regular BNP',
                                'Log BNP+1, NT-proBNP')

model_CPO_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)

model_CPO_noBNP <- glm(formula = as.formula(
  death6week ~ 
    cpo + albumin + log(bilirubin + 1) + eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)


model_CPO_noBNP <- glm(formula = as.formula(
  death6week ~ 
    cpo + albumin + log(bilirubin + 1) + eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
```


### Selected Model #6: US candidate risk score with only API


```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_API <- glm(formula = as.formula(
  death6week ~ 
    api + albumin + log(bilirubin + 1) + eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_API_results <- as.data.frame(summary(model_API)$coefficients)
model_API_results$name <- rownames(model_API_results)

model_API_results <- model_API_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_API_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_API_results) <- seq(1:nrow(model_API_results))
model_API_results <- model_API_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_API_results$Variable <- c('Intercept', 'API', 'Albumin', 
                                'Log Bilirubin+1', 'eGFR', 'Sodium',                          
                                'LVAD', 'Short MCS Ever',
                                'Log BNP+1, Regular BNP',
                                'Log BNP+1, NT-proBNP')

model_API_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


model_API_noBNP <- glm(formula = as.formula(
  death6week ~ 
    api + albumin + log(bilirubin + 1) + eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
```


### Selected Model #7: US candidate risk score replacing API with PAPI

* PAPI = (Systolic pulmonary artery pressure - diastolic pulmonary artery pressure) / right atrial pressure 
* Right atrial pressure is central venous pressure


#### Check that CPO and PAPi are not heavily correlated

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
paste0('Pearson correlation ', cor(df_intervals$cpo, df_intervals$papi, 
                                   use = 'pairwise.complete.obs', 
                                   method = 'pearson'))
paste0('Spearman correlation ', cor(df_intervals$cpo, df_intervals$papi, 
                                    use = 'pairwise.complete.obs', 
                                    method = 'spearman'))
```


#### Model results

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_PAPI_CPO <- glm(formula = as.formula(
  death6week ~ 
    cpo + papi + albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_PAPI_CPO_results <- as.data.frame(summary(model_PAPI_CPO)$coefficients)
model_PAPI_CPO_results$name <- rownames(model_PAPI_CPO_results)

model_PAPI_CPO_results <- model_PAPI_CPO_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_PAPI_CPO_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_PAPI_CPO_results) <- seq(1:nrow(model_PAPI_CPO_results))
model_PAPI_CPO_results <- model_PAPI_CPO_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_PAPI_CPO_results$Variable <- c('Intercept', 'CPO', 'PAPi', 
                                     'Albumin', 'Log Bilirubin+1',
                                     'eGFR', 'Sodium', 'LVAD', 'Short MCS Ever', 
                                     'Log BNP+1, Regular BNP',
                                     'Log BNP+1, NT-proBNP')

model_PAPI_CPO_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


model_PAPI_CPO_noBNP <- glm(formula = as.formula(
  death6week ~ 
    cpo + papi + albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
```


### Selected Model #8: US candidate risk score with only PAPI

#### Correlation between PAPi and API

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
paste0('Pearson correlation ', cor(df_intervals$api, df_intervals$papi,
                                   use = 'pairwise.complete.obs', 
                                   method = 'pearson'))
paste0('Spearman correlation ', cor(df_intervals$api, df_intervals$papi, 
                                    use = 'pairwise.complete.obs', 
                                    method = 'spearman'))
```


#### Model results

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_PAPI <- glm(formula = as.formula(
  death6week ~ 
    papi + albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) +
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_PAPI_results <- as.data.frame(summary(model_PAPI)$coefficients)
model_PAPI_results$name <- rownames(model_PAPI_results)

model_PAPI_results <- model_PAPI_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_PAPI_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_PAPI_results) <- seq(1:nrow(model_PAPI_results))
model_PAPI_results <- model_PAPI_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_PAPI_results$Variable <- c('Intercept', 'PAPi', 
                                 'Albumin', 'Log Bilirubin+1', 
                                 'eGFR', 'Sodium', 'LVAD', 'Short MCS Ever', 
                                 'Log BNP+1, Regular BNP',
                                 'Log BNP+1, NT-proBNP')

model_PAPI_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


model_PAPI_noBNP <- glm(formula = as.formula(
  death6week ~ 
    papi + albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
```


### Selected Model #9: US candidate risk score with PAPi, AST, and API

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_CPO_PAPI_AST_API <- glm(formula = as.formula(
  death6week ~ 
    cpo + papi + api + AST + albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) +
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_CPO_PAPI_AST_API_results <- as.data.frame(summary(model_CPO_PAPI_AST_API)$coefficients)
model_CPO_PAPI_AST_API_results$name <- rownames(model_CPO_PAPI_AST_API_results)

model_CPO_PAPI_AST_API_results <- model_CPO_PAPI_AST_API_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_CPO_PAPI_AST_API_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_CPO_PAPI_AST_API_results) <- seq(1:nrow(model_CPO_PAPI_AST_API_results))
model_CPO_PAPI_AST_API_results <- model_CPO_PAPI_AST_API_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_CPO_PAPI_AST_API_results$Variable <- c('Intercept', 'CPO', 'PAPi', 
                                             'API', 'AST', 'Albumin', 
                                             'Log Bilirubin+1', 'eGFR', 'Sodium', 
                                             'LVAD', 'Short MCS Ever', 
                                             'Log BNP+1, Regular BNP',
                                             'Log BNP+1, NT-proBNP')

model_CPO_PAPI_AST_API_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


model_CPO_PAPI_AST_API_noBNP <- glm(formula = as.formula(
  death6week ~ 
    cpo + papi + api + AST + albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
```


### Selected Model #10: US candidate risk score with PAPi and API

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_CPO_PAPI_API <- glm(formula = as.formula(
  death6week ~ 
    cpo + papi + api + albumin + log(bilirubin + 1) + eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) +
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_CPO_PAPI_API_results <- as.data.frame(summary(model_CPO_PAPI_API)$coefficients)
model_CPO_PAPI_API_results$name <- rownames(model_CPO_PAPI_API_results)

model_CPO_PAPI_API_results <- model_CPO_PAPI_API_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_CPO_PAPI_API_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_CPO_PAPI_API_results) <- seq(1:nrow(model_CPO_PAPI_API_results))
model_CPO_PAPI_API_results <- model_CPO_PAPI_API_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_CPO_PAPI_API_results$Variable <- c('Intercept', 
                                         'CPO', 'PAPi', 'API', 
                                         'Albumin', 'Log Bilirubin+1', 
                                         'eGFR', 'Sodium', 
                                         'LVAD', 'Short MCS Ever', 
                                         'Log BNP+1, Regular BNP',
                                         'Log BNP+1, NT-proBNP')

model_CPO_PAPI_API_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


model_CPO_PAPI_API_noBNP <- glm(formula = as.formula(
  death6week ~ 
    cpo + papi + api + albumin + log(bilirubin + 1) + eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
```


### Selected Model #11: US candidate risk score with PAPi and AST

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_CPO_PAPI_AST <- glm(formula = as.formula(
  death6week ~ 
    cpo + papi + AST + albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_CPO_PAPI_AST_results <- as.data.frame(summary(model_CPO_PAPI_AST)$coefficients)
model_CPO_PAPI_AST_results$name <- rownames(model_CPO_PAPI_AST_results)

model_CPO_PAPI_AST_results <- model_CPO_PAPI_AST_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_CPO_PAPI_AST_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_CPO_PAPI_AST_results) <- seq(1:nrow(model_CPO_PAPI_AST_results))
model_CPO_PAPI_AST_results <- model_CPO_PAPI_AST_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_CPO_PAPI_AST_results$Variable <- c('Intercept', 
                                         'CPO', 'PAPi', 'AST', 
                                         'Albumin', 'Log Bilirubin+1', 
                                         'eGFR', 'Sodium',                              
                                         'LVAD', 'Short MCS Ever', 
                                         'Log BNP+1, Regular BNP',
                                         'Log BNP+1, NT-proBNP')

model_CPO_PAPI_AST_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


model_CPO_PAPI_AST_noBNP <- glm(formula = as.formula(
  death6week ~ 
    cpo + papi + AST + albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
```


### Selected Model #12: No hemodynamics

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_no_hemo <- glm(formula = as.formula(
  death6week ~ 
    albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_no_hemo_results <- as.data.frame(summary(model_no_hemo)$coefficients)
model_no_hemo_results$name <- rownames(model_no_hemo_results)

model_no_hemo_results <- model_no_hemo_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_no_hemo_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_no_hemo_results) <- seq(1:nrow(model_no_hemo_results))
model_no_hemo_results <- model_no_hemo_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_no_hemo_results$Variable <- c('Intercept', 'Albumin', 'Log Bilirubin+1', 
                                    'eGFR', 'Sodium', 'LVAD', 'Short MCS Ever', 
                                    'Log BNP+1, Regular BNP',
                                    'Log BNP+1, NT-proBNP')

model_no_hemo_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)

model_no_hemo_noBNP <- glm(formula = as.formula(
  death6week ~ 
    albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)
```



### Compare model fits

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
df_intervals_train <- subset(df_intervals, df_intervals$train_test == 'Train')

model_comparison <- data.frame(
  'Model' = c('Old French', 
              'New French',
              'US-CRS with PCWP', 
              'US-CRS with CPO and API', 
              'US-CRS with CPO Only',
              'US-CRS with API Only',
              'US-CRS with CPO and PAPi',
              'US-CRS with PAPi Only',
              'US-CRS with PAPi, API, AST',
              'US-CRS with PAPi and API',
              'US-CRS with PAPi and AST',
              'US-CRS without Hemodynamics',
              
              'US-CRS with PCWP, no BNP', 
              'US-CRS with CPO and API, no BNP', 
              'US-CRS with CPO Only, no BNP',
              'US-CRS with API Only, no BNP',
              'US-CRS with CPO and PAPi, no BNP',
              'US-CRS with PAPi Only, no BNP',
              'US-CRS with PAPi, API, AST, no BNP',
              'US-CRS with PAPi and API, no BNP',
              'US-CRS with PAPi and AST, no BNP',
              'US-CRS without Hemodynamics, no BNP'),
  
  'AUC' = c(auc(df_intervals_train$death6week ~ 
                  predict(model_french_old, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_french_new, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_PCWP, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_CPO_API, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_CPO, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_API, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_PAPI_CPO, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_PAPI, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_CPO_PAPI_AST_API, newdata = df_intervals_train, type = 'response', direction = '<')), 
            auc(df_intervals_train$death6week ~ 
                  predict(model_CPO_PAPI_API, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_CPO_PAPI_AST, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_no_hemo, newdata = df_intervals_train, type = 'response', direction = '<')),
            
            
            auc(df_intervals_train$death6week ~ 
                  predict(model_PCWP_noBNP, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_CPO_API_noBNP, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_CPO_noBNP, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_API_noBNP, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_PAPI_CPO_noBNP, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_PAPI_noBNP, newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_CPO_PAPI_AST_API_noBNP, 
                          newdata = df_intervals_train, type = 'response', direction = '<')), 
            auc(df_intervals_train$death6week ~ 
                  predict(model_CPO_PAPI_API_noBNP, 
                          newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_CPO_PAPI_AST_noBNP, 
                          newdata = df_intervals_train, type = 'response', direction = '<')),
            auc(df_intervals_train$death6week ~ 
                  predict(model_no_hemo_noBNP, newdata = df_intervals_train, type = 'response', direction = '<'))
            
            ),
  
  'AIC' = c(AIC(model_french_old), 
            AIC(model_french_new), 
            AIC(model_PCWP), 
            AIC(model_CPO_API), 
            AIC(model_CPO), 
            AIC(model_API), 
            AIC(model_PAPI_CPO), 
            AIC(model_PAPI), 
            AIC(model_CPO_PAPI_AST_API), 
            AIC(model_CPO_PAPI_API),
            AIC(model_CPO_PAPI_AST),
            AIC(model_no_hemo),
            
            AIC(model_PCWP_noBNP), 
            AIC(model_CPO_API_noBNP), 
            AIC(model_CPO_noBNP), 
            AIC(model_API_noBNP), 
            AIC(model_PAPI_CPO_noBNP), 
            AIC(model_PAPI_noBNP), 
            AIC(model_CPO_PAPI_AST_API_noBNP), 
            AIC(model_CPO_PAPI_API_noBNP),
            AIC(model_CPO_PAPI_AST_noBNP),
            AIC(model_no_hemo_noBNP))
  )

model_comparison$AUC <- round(model_comparison$AUC, digits = 3)


model_comparison %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)
```


### Final US-CRS model: no hemodynamics

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_final <- glm(formula = as.formula(
  death6week ~ 
    albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_final_results <- as.data.frame(summary(model_final)$coefficients)
model_final_results$name <- rownames(model_final_results)

model_final_results <- model_final_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_final_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_final_results) <- seq(1:nrow(model_final_results))
model_final_results <- model_final_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_final_results$Variable <- c('Intercept',  
                                  'Albumin', 'Log Bilirubin+1',
                                  'eGFR', 'Sodium', 
                                  'LVAD', 'Short MCS Ever',
                                  'Log BNP+1, Regular BNP',
                                  'Log BNP+1, NT-proBNP')

model_final_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


save(model_final, file = './model_USCRS.RData')
```


### Final US-CRS model: with hemodynamics

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_final_hemo <- glm(formula = as.formula(
  death6week ~ 
    cpo + papi + albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_final_hemo_results <- as.data.frame(summary(model_final_hemo)$coefficients)
model_final_hemo_results$name <- rownames(model_final_hemo_results)

model_final_hemo_results <- model_final_hemo_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_final_hemo_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_final_hemo_results) <- seq(1:nrow(model_final_hemo_results))
model_final_hemo_results <- model_final_hemo_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_final_hemo_results$Variable <- c('Intercept', 'CPO', 'PAPi',
                                  'Albumin', 'Log Bilirubin+1',
                                  'eGFR', 'Sodium', 
                                  'LVAD', 'Short MCS Ever',
                                  'Log BNP+1, Regular BNP',
                                  'Log BNP+1, NT-proBNP')

model_final_hemo_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


save(model_final_hemo, file = './model_USCRS_hemo.RData')
```


----------------------------


### Coefficient plot of results without hemodynamics (Figure 1)

```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
df_coefplot <- as.data.frame(summary(model_final)$coefficients)[ ,c('Estimate', 'Std. Error')]
df_coefplot$var <- rownames(df_coefplot)
rownames(df_coefplot) <- NULL
colnames(df_coefplot) <- c('us_est', 'us_stderr', 'var')

df_coefplot$french_est <- NA
df_coefplot$french_stderr <- NA

df_coefplot$french_est[df_coefplot$var == 'short_MCS_ever'] <- 
  summary(model_french_new)$coefficients['short_MCS_French_new', 'Estimate']
df_coefplot$french_est[df_coefplot$var == 'log(bilirubin + 1)'] <- 
  summary(model_french_new)$coefficients['log(bilirubin + 1)', 'Estimate']
df_coefplot$french_est[df_coefplot$var == 'eGFR'] <- 
  summary(model_french_new)$coefficients['eGFR', 'Estimate']


df_coefplot$french_est[df_coefplot$var == 'log(BNP + 1):BNP_NT_Pro0'] <- 
  summary(model_french_new)$coefficients['log(BNP + 1):BNP_NT_Pro0', 'Estimate']
df_coefplot$french_est[df_coefplot$var == 'log(BNP + 1):BNP_NT_Pro1'] <- 
  summary(model_french_new)$coefficients['log(BNP + 1):BNP_NT_Pro1', 'Estimate']



df_coefplot$french_stderr[df_coefplot$var == 'short_MCS_ever'] <- 
  summary(model_french_new)$coefficients['short_MCS_French_new', 'Std. Error']
df_coefplot$french_stderr[df_coefplot$var == 'log(bilirubin + 1)'] <- 
  summary(model_french_new)$coefficients['log(bilirubin + 1)', 'Std. Error']
df_coefplot$french_stderr[df_coefplot$var == 'eGFR'] <- 
  summary(model_french_new)$coefficients['eGFR', 'Std. Error']

df_coefplot$french_stderr[df_coefplot$var == 'log(BNP + 1):BNP_NT_Pro0'] <- 
  summary(model_french_new)$coefficients['log(BNP + 1):BNP_NT_Pro0', 'Std. Error']
df_coefplot$french_stderr[df_coefplot$var == 'log(BNP + 1):BNP_NT_Pro1'] <- 
  summary(model_french_new)$coefficients['log(BNP + 1):BNP_NT_Pro1', 'Std. Error']


df_coefplot <- df_coefplot[ ,c('var', 'french_est', 'french_stderr', 'us_est', 'us_stderr')]
df_coefplot <- subset(df_coefplot, df_coefplot$var != '(Intercept)')

df_coefplot$var <- c('Albumin', 'Log Bilirubin', 
'eGFR', 'Sodium', 'Durable LVAD', 'Short-Term MCS', 
'Log BNP, Regular BNP', 'Log BNP, NT-proBNP')



df_coefplot <- df_coefplot %>%
  arrange(sapply(var, 
                 function(x) 
                   which(x == c('Short-Term MCS', 'Log Bilirubin', 'eGFR', 
                                'Log BNP, Regular BNP', 
                                'Log BNP, NT-proBNP',
                                'Albumin', 
                                'Sodium', 'Durable LVAD'))))


### Scale certain estimates
df_coefplot$french_est[df_coefplot$var == 'eGFR'] <- df_coefplot$french_est[df_coefplot$var == 'eGFR'] * 10
df_coefplot$french_est[df_coefplot$var == 'Sodium'] <- df_coefplot$french_est[df_coefplot$var == 'Sodium'] * 10

df_coefplot$french_stderr[df_coefplot$var == 'eGFR'] <- df_coefplot$french_stderr[df_coefplot$var == 'eGFR'] * 10
df_coefplot$french_stderr[df_coefplot$var == 'Sodium'] <- df_coefplot$french_stderr[df_coefplot$var == 'Sodium'] * 10


df_coefplot$us_est[df_coefplot$var == 'eGFR'] <- df_coefplot$us_est[df_coefplot$var == 'eGFR'] * 10
df_coefplot$us_est[df_coefplot$var == 'Sodium'] <- df_coefplot$us_est[df_coefplot$var == 'Sodium'] * 10

df_coefplot$us_stderr[df_coefplot$var == 'eGFR'] <- df_coefplot$us_stderr[df_coefplot$var == 'eGFR'] * 10
df_coefplot$us_stderr[df_coefplot$var == 'Sodium'] <- df_coefplot$us_stderr[df_coefplot$var == 'Sodium'] * 10



df_coefplot <- df_coefplot %>%
  mutate(
    french_lower = french_est - (1.96*french_stderr),
    french_upper = french_est + (1.96*french_stderr),
    us_lower = us_est - (1.96*us_stderr),
    us_upper = us_est + (1.96*us_stderr)) %>%
  select(-c(french_stderr, us_stderr))


df_coefplot <- df_coefplot %>%
  pivot_longer(!var, names_to = 'stat', values_to = 'count')
df_coefplot$model <- ifelse(grepl('^french', df_coefplot$stat), 'French', 'US')
df_coefplot$stat <- sub('.*_', '', df_coefplot$stat)

df_coefplot$est <- ifelse(df_coefplot$stat == 'est', df_coefplot$count, NA)
df_coefplot$lower <- ifelse(df_coefplot$stat == 'lower', df_coefplot$count, NA)
df_coefplot$upper <- ifelse(df_coefplot$stat == 'upper', df_coefplot$count, NA)

df_coefplot$stat <- NULL; df_coefplot$count <- NULL
df_coefplot <- df_coefplot %>%
  group_by(var, model) %>%
  summarize_all(~ max(., na.rm=T), .groups = 'drop')

df_coefplot$est[df_coefplot$est == -Inf] <- NA
df_coefplot$lower[df_coefplot$lower == -Inf] <- NA
df_coefplot$upper[df_coefplot$upper == -Inf] <- NA

df_coefplot <- df_coefplot %>%
  arrange(sapply(var, 
                 function(x) 
                   which(x == c('Short-Term MCS', 'Log Bilirubin', 'eGFR', 
                                'Log BNP, Regular BNP',
                                'Log BNP, NT-proBNP', 
                                'Albumin', 
                                'Sodium', 'Durable LVAD'))))

# dev.new(width = 7,height = 6, noRStudioGD = T)
df_coefplot %>%
  ggplot(aes(x=est, 
             y=factor(var, levels = c('Durable LVAD', 'Sodium', 
                                      'Albumin', 
                                      'Log BNP, NT-proBNP',
                                      'Log BNP, Regular BNP',
                                      'eGFR', 'Log Bilirubin', 
                                      'Short-Term MCS')), 
             color=model)) +
  geom_point(size = 3.25, position = position_dodge(width = 0.7)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), position = position_dodge(width = 0.7)) +
  geom_vline(xintercept = 0, lty = 2, color = '#880d1e', linewidth = 0.05) +
  xlab('Log-Odds for 6-Week Waitlist Mortality') + xlim(-1.25, 1.25) +
  scale_y_discrete(labels=c('Durable LVAD', expression('Sodium'^'b'), 'Albumin', 
                            'Log BNP, NT-proBNP', 
                            'Log BNP, Regular BNP', 
                            expression('eGFR'^'b'), 'Log Bilirubin', 
                            expression('Short-Term MCS'^'a'))) +
  scale_colour_manual(name='Model',
                      breaks = c('US', 'French'),
                      values = c('#880d1e', '#3f88c5'), 
                      labels = c('US-CRS', 'Current French-CRS')) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(face='bold', size = 16, margin = margin(t=5)), 
        axis.text.x = element_text(face='bold', size = 16, margin = margin(t=5)), 
        axis.title.y = element_blank(),
        axis.text.y = element_text(face='bold', size = 16, margin = margin(r=5)),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18))  
```


### Coefficient plot of results with CPO and PAPi 

```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
df_coefplot <- as.data.frame(summary(model_final_hemo)$coefficients)[ ,c('Estimate', 'Std. Error')]
df_coefplot$var <- rownames(df_coefplot)
rownames(df_coefplot) <- NULL
colnames(df_coefplot) <- c('us_est', 'us_stderr', 'var')

df_coefplot$french_est <- NA
df_coefplot$french_stderr <- NA

df_coefplot$french_est[df_coefplot$var == 'short_MCS_ever'] <- 
  summary(model_french_new)$coefficients['short_MCS_French_new', 'Estimate']
df_coefplot$french_est[df_coefplot$var == 'log(bilirubin + 1)'] <- 
  summary(model_french_new)$coefficients['log(bilirubin + 1)', 'Estimate']
df_coefplot$french_est[df_coefplot$var == 'eGFR'] <- 
  summary(model_french_new)$coefficients['eGFR', 'Estimate']


df_coefplot$french_est[df_coefplot$var == 'log(BNP + 1):BNP_NT_Pro0'] <- 
  summary(model_french_new)$coefficients['log(BNP + 1):BNP_NT_Pro0', 'Estimate']
df_coefplot$french_est[df_coefplot$var == 'log(BNP + 1):BNP_NT_Pro1'] <- 
  summary(model_french_new)$coefficients['log(BNP + 1):BNP_NT_Pro1', 'Estimate']



df_coefplot$french_stderr[df_coefplot$var == 'short_MCS_ever'] <- 
  summary(model_french_new)$coefficients['short_MCS_French_new', 'Std. Error']
df_coefplot$french_stderr[df_coefplot$var == 'log(bilirubin + 1)'] <- 
  summary(model_french_new)$coefficients['log(bilirubin + 1)', 'Std. Error']
df_coefplot$french_stderr[df_coefplot$var == 'eGFR'] <- 
  summary(model_french_new)$coefficients['eGFR', 'Std. Error']

df_coefplot$french_stderr[df_coefplot$var == 'log(BNP + 1):BNP_NT_Pro0'] <- 
  summary(model_french_new)$coefficients['log(BNP + 1):BNP_NT_Pro0', 'Std. Error']
df_coefplot$french_stderr[df_coefplot$var == 'log(BNP + 1):BNP_NT_Pro1'] <- 
  summary(model_french_new)$coefficients['log(BNP + 1):BNP_NT_Pro1', 'Std. Error']


df_coefplot <- df_coefplot[ ,c('var', 'french_est', 'french_stderr', 'us_est', 'us_stderr')]
df_coefplot <- subset(df_coefplot, df_coefplot$var != '(Intercept)')

df_coefplot$var <- c('CPO', 'PAPi', 'Albumin', 'Log Bilirubin', 
'eGFR', 'Sodium', 'Durable LVAD', 'Short-Term MCS', 
'Log BNP, Regular BNP', 'Log BNP, NT-proBNP')



df_coefplot <- df_coefplot %>%
  arrange(sapply(var, 
                 function(x) 
                   which(x == c('Short-Term MCS', 'Log Bilirubin', 'eGFR', 
                                'Log BNP, Regular BNP', 
                                'Log BNP, NT-proBNP',
                                'Albumin', 'CPO', 'PAPi',
                                'Sodium', 'Durable LVAD'))))


### Scale certain estimates
df_coefplot$french_est[df_coefplot$var == 'eGFR'] <- df_coefplot$french_est[df_coefplot$var == 'eGFR'] * 10
df_coefplot$french_est[df_coefplot$var == 'PAPi'] <- df_coefplot$french_est[df_coefplot$var == 'PAPi'] * 2
df_coefplot$french_est[df_coefplot$var == 'Sodium'] <- df_coefplot$french_est[df_coefplot$var == 'Sodium'] * 10

df_coefplot$french_stderr[df_coefplot$var == 'eGFR'] <- df_coefplot$french_stderr[df_coefplot$var == 'eGFR'] * 10
df_coefplot$french_stderr[df_coefplot$var == 'PAPi'] <- df_coefplot$french_stderr[df_coefplot$var == 'PAPi'] * 2
df_coefplot$french_stderr[df_coefplot$var == 'Sodium'] <- df_coefplot$french_stderr[df_coefplot$var == 'Sodium'] * 10


df_coefplot$us_est[df_coefplot$var == 'eGFR'] <- df_coefplot$us_est[df_coefplot$var == 'eGFR'] * 10
df_coefplot$us_est[df_coefplot$var == 'PAPi'] <- df_coefplot$us_est[df_coefplot$var == 'PAPi'] * 2
df_coefplot$us_est[df_coefplot$var == 'Sodium'] <- df_coefplot$us_est[df_coefplot$var == 'Sodium'] * 10

df_coefplot$us_stderr[df_coefplot$var == 'eGFR'] <- df_coefplot$us_stderr[df_coefplot$var == 'eGFR'] * 10
df_coefplot$us_stderr[df_coefplot$var == 'PAPi'] <- df_coefplot$us_stderr[df_coefplot$var == 'PAPi'] * 2
df_coefplot$us_stderr[df_coefplot$var == 'Sodium'] <- df_coefplot$us_stderr[df_coefplot$var == 'Sodium'] * 10



df_coefplot <- df_coefplot %>%
  mutate(
    french_lower = french_est - (1.96*french_stderr),
    french_upper = french_est + (1.96*french_stderr),
    us_lower = us_est - (1.96*us_stderr),
    us_upper = us_est + (1.96*us_stderr)) %>%
  select(-c(french_stderr, us_stderr))


df_coefplot <- df_coefplot %>%
  pivot_longer(!var, names_to = 'stat', values_to = 'count')
df_coefplot$model <- ifelse(grepl('^french', df_coefplot$stat), 'French', 'US')
df_coefplot$stat <- sub('.*_', '', df_coefplot$stat)

df_coefplot$est <- ifelse(df_coefplot$stat == 'est', df_coefplot$count, NA)
df_coefplot$lower <- ifelse(df_coefplot$stat == 'lower', df_coefplot$count, NA)
df_coefplot$upper <- ifelse(df_coefplot$stat == 'upper', df_coefplot$count, NA)

df_coefplot$stat <- NULL; df_coefplot$count <- NULL
df_coefplot <- df_coefplot %>%
  group_by(var, model) %>%
  summarize_all(~ max(., na.rm=T), .groups = 'drop')

df_coefplot$est[df_coefplot$est == -Inf] <- NA
df_coefplot$lower[df_coefplot$lower == -Inf] <- NA
df_coefplot$upper[df_coefplot$upper == -Inf] <- NA

df_coefplot <- df_coefplot %>%
  arrange(sapply(var, 
                 function(x) 
                   which(x == c('Short-Term MCS', 'Log Bilirubin', 'eGFR', 
                                'Log BNP, Regular BNP',
                                'Log BNP, NT-proBNP', 
                                'Albumin', 'PAPi', 'CPO',
                                'Sodium', 'Durable LVAD'))))

# dev.new(width = 7,height = 6, noRStudioGD = T)
df_coefplot %>%
  ggplot(aes(x=est, 
             y=factor(var, levels = c('Durable LVAD', 'Sodium', 
                                      'Albumin', 'PAPi', 'CPO',
                                      'Log BNP, NT-proBNP',
                                      'Log BNP, Regular BNP',
                                      'eGFR', 'Log Bilirubin', 
                                      'Short-Term MCS')), 
             color=model)) +
  geom_point(size = 3.25, position = position_dodge(width = 0.7)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), position = position_dodge(width = 0.7)) +
  geom_vline(xintercept = 0, lty = 2, color = '#880d1e', linewidth = 0.05) +
  xlab('Log-Odds for 6-Week Waitlist Mortality') + xlim(-1.25, 1.25) +
  scale_y_discrete(labels=c('Durable LVAD', expression('Sodium'^'b'), 'Albumin', 
                            expression('PAPi'^'c'), 'CPO',
                            'Log BNP, NT-proBNP', 
                            'Log BNP, Regular BNP', 
                            expression('eGFR'^'b'), 'Log Bilirubin', 
                            expression('Short-Term MCS'^'a'))) +
  scale_colour_manual(name='Model',
                      breaks = c('US', 'French'),
                      values = c('#880d1e', '#3f88c5'), 
                      labels = c('US-CRS', 'Current French-CRS')) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(face='bold', size = 16, margin = margin(t=5)), 
        axis.text.x = element_text(face='bold', size = 16, margin = margin(t=5)), 
        axis.title.y = element_blank(),
        axis.text.y = element_text(face='bold', size = 16, margin = margin(r=5)),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18))  
```


-------------


# 4. Run sensitivity logistic regression models

### US-CRS with balloon pumps and perc LVAD in short-term MCS (no hemodynamics)

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_final_BP <- glm(formula = as.formula(
  death6week ~ 
    albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever_with_BP_perc), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_final_BP_results <- as.data.frame(summary(model_final_BP)$coefficients)
model_final_BP_results$name <- rownames(model_final_BP_results)

model_final_BP_results <- model_final_BP_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_final_BP_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_final_BP_results) <- seq(1:nrow(model_final_BP_results))
model_final_BP_results <- model_final_BP_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_final_BP_results$Variable <- c('Intercept', 'Albumin', 'Log Bilirubin+1',
                                     'eGFR', 'Sodium', 'LVAD', 
                                     'Short MCS Ever (with IABP, perc)',
                                     'Log BNP+1, Regular BNP',
                                     'Log BNP+1, NT-proBNP')

model_final_BP_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)
```


### US-CRS with balloon pumps and perc LVAD in short-term MCS (with hemodynamics)

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
model_hemo_BP <- glm(formula = as.formula(
  death6week ~ 
    cpo + papi + albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever_with_BP_perc), 
  data = df_intervals[df_intervals$train_test == 'Train',], 
  family = binomial)

model_hemo_BP_results <- as.data.frame(summary(model_hemo_BP)$coefficients)
model_hemo_BP_results$name <- rownames(model_hemo_BP_results)

model_hemo_BP_results <- model_hemo_BP_results[ ,c('name', 'Estimate', 'Pr(>|z|)')]
colnames(model_hemo_BP_results) <- c('Variable', 'Estimate', 'PValue')
rownames(model_hemo_BP_results) <- seq(1:nrow(model_hemo_BP_results))
model_hemo_BP_results <- model_hemo_BP_results %>% 
  mutate(Estimate = round(Estimate, 3),
           PValue = round(PValue, 3))

model_hemo_BP_results$Variable <- c('Intercept', 'CPO', 'PAPi', 'Albumin', 
                                    'Log Bilirubin+1', 'eGFR', 
                                    'Sodium', 'LVAD', 
                                    'Short MCS Ever (with IABP, perc)',
                                    'Log BNP+1, Regular BNP',
                                    'Log BNP+1, NT-proBNP')

model_hemo_BP_results %>%
  kable(align=c('c', 'c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)
```


-------------


# 5. Obtain machine learning model results 

### Elastic Net Regression, No Memory Variables
Results from the elastic net regressions are obtained from **elastic_net_model.R**.

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
load('./Models/model_elastic_nomem_6wk.RData')

model_elastic_nomem_results <- data.frame(
  'Variable' = rownames(
    coef(model_elastic_nomem$finalModel, 
         model_elastic_nomem$bestTune$lambda, 
         model_elastic_nomem$bestTune$alpha)),
  
  'Estimate' = as.numeric(
    coef(model_elastic_nomem$finalModel, 
         model_elastic_nomem$bestTune$lambda, 
         model_elastic_nomem$bestTune$alpha)))


model_elastic_nomem_results[ ,'Estimate'] <- 
  signif(model_elastic_nomem_results[ ,'Estimate'], 2)
model_elastic_nomem_results %>%
  kable(align=c('c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)
```


### Elastic Net Regression, All Memory Variables

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
load('./Models/model_elastic_mem_6wk.RData')

model_elastic_all_results <- data.frame(
  'Variable' = rownames(
    coef(model_elastic_all$finalModel, model_elastic_all$bestTune$lambda, model_elastic_all$bestTune$alpha)),
  
  'Estimate' = as.numeric(coef(model_elastic_all$finalModel, model_elastic_all$bestTune$lambda,
                               model_elastic_all$bestTune$alpha)))


model_elastic_all_results[ ,'Estimate'] <- signif(model_elastic_all_results[ ,'Estimate'], 2)
model_elastic_all_results %>%
  kable(align=c('c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)
```


### Gradient-Boosted Model Results
Results are obtained from the final iteration of **xgboost_mem_vars_model.R**.

```{r, echo=F, warning=F, message=F, comment=NA}
load('./Models/model_xgboost_nomem_final.RData')
load('./Models/model_xgboost_mem_final.RData')
```


-------------


# 6. Make predictions on test dataset

```{r, echo=F, warning=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8, results='hide'}
model_french_old_predict <- as.numeric(
  predict(model_french_old, newdata = df_intervals_test, type = 'response'))
model_french_old_indices <- which(!is.na(model_french_old_predict))
model_french_old_predict <- na.omit(model_french_old_predict)

model_french_new_predict <- as.numeric(
  predict(model_french_new, newdata = df_intervals_test, type = 'response'))
model_french_new_indices <- which(!is.na(model_french_new_predict))
model_french_new_predict <- na.omit(model_french_new_predict)

model_final_predict <- as.numeric(
  predict(model_final, newdata = df_intervals_test, type = 'response'))
model_final_indices <- which(!is.na(model_final_predict))
model_final_predict <- na.omit(model_final_predict)

model_final_hemo_predict <- as.numeric(
  predict(model_final_hemo, newdata = df_intervals_test, type = 'response'))
model_final_hemo_indices <- which(!is.na(model_final_hemo_predict))
model_final_hemo_predict <- na.omit(model_final_hemo_predict)



elastic_nomem_predict <- predict(model_elastic_nomem, 
                                 newdata = mat_test, type = 'prob', 
                                 na.action = na.pass)[,'1']
nomem_indices <- which(!is.na(elastic_nomem_predict))
elastic_nomem_predict<- na.omit(elastic_nomem_predict)

elastic_all_predict <- predict(model_elastic_all, 
                               newdata = mat_test_all, type = 'prob', 
                               na.action = na.pass)[,'1']
mem_indices <- which(!is.na(elastic_all_predict))
elastic_all_predict<- na.omit(elastic_all_predict)


xg_nomem_predict <- predict(model_xgboost_nomem, newdata = DMat_test)
xg_all_predict <- predict(model_xgboost_mem, newdata = DMat_test_all)


rownames(df_intervals_test) <- seq(1:nrow(df_intervals_test))

df_intervals_test_nomem <- df_intervals_test[(as.numeric(rownames(df_intervals_test)) %in% nomem_indices), ]
df_intervals_test_mem <- df_intervals_test[(as.numeric(rownames(df_intervals_test)) %in% mem_indices), ]

df_intervals_test_model_french_old <- 
  df_intervals_test[(as.numeric(rownames(df_intervals_test)) %in% model_french_old_indices), ]
df_intervals_test_model_french_new <- 
  df_intervals_test[(as.numeric(rownames(df_intervals_test)) %in% model_french_new_indices), ]
df_intervals_test_model_final <- 
  df_intervals_test[(as.numeric(rownames(df_intervals_test)) %in% model_final_indices), ]
df_intervals_test_model_final_hemo <- 
  df_intervals_test[(as.numeric(rownames(df_intervals_test)) %in% model_final_hemo_indices), ]
```


-------------


# 7. Create AUC curves

### ROC curve for models with all memory variables (eFigure 4)

```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8, results='hide'}
# dev.new(width = 7,height = 6, noRStudioGD = T)
pROC::roc(data=df_intervals_test, response=death6week, predictor=status_initial, direction='>', 
          plot=T, col='#880d1e', print.auc=T, ci=T, ci.type = 'no', lwd=2.5, quiet=T)
pROC::roc(df_intervals_test_mem$death6week ~ elastic_all_predict, direction='<', 
          plot=T, print.auc=T, ci=T, ci.type = 'no',  
          print.auc.y=0.45, smooth=T, lwd=2.5, col='wheat3', add=T, quiet=T)
pROC::roc(df_intervals_test$death6week ~ xg_all_predict, direction='<',
          plot=T, print.auc=T, ci=T, ci.type = 'no', 
          print.auc.y=0.40, smooth=T, lwd=2.5, col='#a37c40', add=T, quiet=T)
pROC::roc(df_intervals_test_model_french_old$death6week ~ model_french_old_predict, direction='<',
          plot=T, print.auc=T, ci=T, ci.type = 'no',
          print.auc.y=0.35, smooth=T, lwd=2.5, col='#07090f', add=T, quiet=T)
pROC::roc(df_intervals_test_model_final$death6week ~ model_final_predict, direction='<',
          plot=T, print.auc=T, ci=T, ci.type = 'no',
          print.auc.y=0.30, smooth=T, lwd=2.5, col='#3f88c5', add=T, quiet=T)
legend('bottomright', cex = 0.9, xpd = T,
      legend = c('6-Status', 
                 'Elastic Net',
                 'Gradient-Boosted Model', 
                 'Prior French-CRS',
                 'US-CRS'),
       col = c('#880d1e', 'wheat3', '#a37c40', '#07090f', '#3f88c5'), lwd = 2.5)
```


### ROC curve for subset of models (Figure 2)

```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.width=7, fig.height=6}
# dev.new(width = 7,height = 6, noRStudioGD = T)
pROC::roc(data=df_intervals_test, response=death6week, predictor=status_initial, direction='>',
          plot=T, col='#880d1e', print.auc=T, ci=T, ci.type = 'no',
          lwd=3, quiet=T, print.thres = c(1,2,3,4,5,6), 
          print.thres.cex = 1.2, 
          print.thres.pattern= "Status%2.f",
          print.auc.cex = 1.2,
          legacy.axes=T)
pROC::roc(df_intervals_test_model_french_new$death6week ~ model_french_new_predict, direction='<',
          plot=T, print.auc=T, ci=T, ci.type = 'no',
          print.auc.y=0.45, smooth=T, lwd=2.5, col='#a37c40', add=T, quiet=T, print.auc.cex = 1.2)
pROC::roc(df_intervals_test_model_final$death6week ~ model_final_predict, direction='<',
          plot=T, print.auc=T, ci=T, ci.type = 'no',
          print.auc.y=0.40, smooth=T, lwd=2.5, col='#3f88c5', add=T, quiet=T, print.auc.cex = 1.2)
legend('bottomright', xpd = T,
      legend = c('6-Status', 'Current French-CRS', 'US-CRS'),
       col = c('#880d1e', '#a37c40', '#3f88c5'), lwd=2.5,  cex=1.1)
```


-------------


# 8. Variable importance plots from gradient-boosted models

## Variable importance for XGBoost, No Memory

```{r, warning=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8, results='hide'}
importance1 <- xgb.importance(feature_names = colnames(DMat_test), model=model_xgboost_nomem)
importance1 <- importance1[importance1$Gain > 0.03, ]


p1 <- xgb.ggplot.importance(importance1, n_clusters = 1)

p1 <- p1 +  
  theme_bw() + 
  scale_fill_manual(values = '#880d1e') +
  theme(
    legend.position = 'none',
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 14, margin = margin(t=5)), 
    axis.text.x = element_text(size = 13, margin = margin(t=5)), 
    axis.title.y = element_text(size = 14, margin = margin(r=5)),
    axis.text.y = element_text(size = 13, margin = margin(r=5)),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    plot.title = element_blank()) 
```


## Variable importance for XGBoost, All Memory

```{r, warning=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8, results='hide'}
importance2 <- xgb.importance(feature_names = colnames(DMat_test_all), model=model_xgboost_mem)
importance2 <- importance2[importance2$Gain > 0.03, ]


p2 <- xgb.ggplot.importance(importance1, n_clusters = 1)

p2 <- p2 +  
  theme_bw() + 
  scale_fill_manual(values = '#880d1e') +
  ggtitle('') +
  theme(
    legend.position = 'none',
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 14, margin = margin(t=5)), 
    axis.text.x = element_text(size = 13, margin = margin(t=5)), 
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 13, margin = margin(r=5)),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    plot.title = element_blank()) 
```


```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
cowplot::plot_grid(p1, p2, labels = 'AUTO', scale = 0.9)
```


-------------


# 9. Create calibration plot in test dataset (Figure 4)

```{r, warning=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
## Convert first to 50-point medical urgency score
df_intervals$uscrs_predict <- predict(model_final, newdata = df_intervals, type = 'response')
df_intervals <- df_intervals %>%
  ungroup() %>%
  mutate(uscrs_score = cut_number(uscrs_predict, 50, labels= FALSE))


df_intervals$death6week <- as.numeric(as.character(df_intervals$death6week))
df_intervals_test <- subset(df_intervals, df_intervals$train_test == 'Test')
df_intervals_test <- df_intervals_test %>% select(death6week, uscrs_predict, uscrs_score)
df_intervals_test <- subset(df_intervals_test, !is.na(uscrs_score))


df_intervals_test_calib <- 
  df_intervals_test %>%
  mutate(decile_predictions = cut_number(uscrs_predict, 10, labels= FALSE)) %>%
  group_by(decile_predictions) %>%
  summarise(predicted = mean(uscrs_predict),
            observed = mean(death6week),
            mean_uscrs =  mean(uscrs_score),
            total = n()) %>%
  mutate(sd = sqrt(observed*(1-observed)),
         se = sd/sqrt(total),
         upper_ci = observed + 1.96*se,
         lower_ci = observed - 1.96*se)


df_intervals_test_calib %>%
  ggplot(aes(x = predicted, y = observed)) +
  geom_point(aes(color = mean_uscrs)) +  
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci, color = mean_uscrs)) + 
  geom_abline(slope = 1, intercept = 0, color = 'black', linetype = 2) + 
  theme_bw() +
  scale_color_gradient(name = 'Average Medical Urgency', low = '#3f88c5', high = '#880d1e') +
  xlab('US-CRS Predicted Risk of 6-Week Mortality') + ylab('Observed Risk of 6-Week Mortality') +
  xlim(0, 0.06) + ylim(0, 0.06) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14, margin = margin(t=5)),
        axis.text.x = element_text(size = 13, margin = margin(t=5)),
        axis.title.y = element_text(size = 14, margin = margin(r=5)),
        axis.text.y = element_text(size = 13, margin = margin(r=5)),
        legend.title = element_text(size = 12, face='bold'),
        legend.text = element_text(size = 12)) 


### Find calibration slope and intercept
lm(observed ~ predicted, data = df_intervals_test_calib)
```


-------------


# 10. Create facet plot of 50 point score at initial listing (Figure 3)

```{r, warning=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
df_intervals$uscrs_predict <- predict(model_final, newdata = df_intervals)

df_intervals %>%
  filter(!is.na(status)) %>%
  group_by(PX_ID) %>%
  filter(row_number()==1) %>%
  ggplot(aes(x = uscrs_score, fill = status)) +
  scale_fill_manual(name = 'Status', values = c('#880d1e', '#a37c40', 'wheat3', '#3f88c5', 'grey', '#07090f')) +
  geom_histogram(binwidth = 2) +  
  xlab('US-CRS Initial Score') + ylab('Number of Candidates') +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank()) +
  facet_wrap(~ status, labeller = as_labeller(c('1' = 'Status 1', '2' = 'Status 2', '3' = 'Status 3',
                                                '4' = 'Status 4', '5' = 'Status 5', '6' = 'Status 6')))
```


-------------


# 11. Examine gender and race differences in prediction

```{r, echo=F, warning=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
df_gender_race <- df_intervals %>% select(PX_ID, uscrs_predict, 
                                          uscrs_score, death6week)

### Obtain gender and race from cand_thor
df_candthor <- haven::read_sas('./cand_thor.sas7bdat') %>%
  select(PX_ID, CAN_RACE, CAN_GENDER) %>%
  mutate(female = case_when(
    CAN_GENDER == 'F' ~ 'Female',
    TRUE ~ 'Male'),
    
    race = case_when(
      CAN_RACE == '8' ~ 'White',
      TRUE ~ 'Not White')) %>%
  
  select(-c(CAN_GENDER, CAN_RACE))


df_gender_race <- merge(df_gender_race, df_candthor, by = 'PX_ID', all.x = T, all.y = F)
rm(df_candthor)
df_gender_race <- subset(df_gender_race, !is.na(df_gender_race$uscrs_predict))


df_gender_race %>% ungroup() %>%
  tbl_summary(by = female, 
              include = c('uscrs_predict', 'uscrs_score', 'death6week'),
              digits = everything() ~ 5) %>%
  add_p()

df_gender_race %>% ungroup() %>%
  tbl_summary(by = race, 
              include = c('uscrs_predict', 'uscrs_score', 'death6week'),
              digits = everything() ~ 5) %>%
  add_p()



p1 <- df_gender_race %>%
  ungroup() %>%
  filter(female == 'Female') %>%
  mutate(decile_predictions = cut_number(uscrs_predict, 10, labels= FALSE)) %>%
  group_by(decile_predictions) %>%
  summarise(predicted = mean(uscrs_predict),
            observed = mean(as.numeric(as.character(death6week))),
            mean_uscrs =  mean(uscrs_score),
            total = n()) %>%
  mutate(sd = sqrt(observed*(1-observed)),
         se = sd/sqrt(total),
         upper_ci = observed + 1.96*se,
         lower_ci = observed - 1.96*se) %>%
  ggplot(aes(x = predicted, y = observed)) +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) + 
  geom_abline(slope = 1, intercept = 0, color = '#880d1e', linetype = 2) + 
  theme_bw() + 
  xlab('') + ylab('Observed Risk of 6-Week Mortality') +
  xlim(0, 0.06) + ylim(0, 0.06) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14, margin = margin(t=5)),
        axis.text.x = element_text(size = 13, margin = margin(t=5)),
        axis.title.y = element_text(size = 14, margin = margin(r=5)),
        axis.text.y = element_text(size = 13, margin = margin(r=5)),
        legend.title = element_text(size = 12, face='bold'),
        legend.text = element_text(size = 12)) 

p2 <- df_gender_race %>%
  ungroup() %>%
  filter(female == 'Male') %>%
  mutate(decile_predictions = cut_number(uscrs_predict, 10, labels= FALSE)) %>%
  group_by(decile_predictions) %>%
  summarise(predicted = mean(uscrs_predict),
            observed = mean(as.numeric(as.character(death6week))),
            mean_uscrs =  mean(uscrs_score),
            total = n()) %>%
  mutate(sd = sqrt(observed*(1-observed)),
         se = sd/sqrt(total),
         upper_ci = observed + 1.96*se,
         lower_ci = observed - 1.96*se) %>%
  ggplot(aes(x = predicted, y = observed)) +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) + 
  geom_abline(slope = 1, intercept = 0, color = '#880d1e', linetype = 2) + 
  theme_bw() + 
  xlab('') + ylab('') +
  xlim(0, 0.06) + ylim(0, 0.06) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14, margin = margin(t=5)),
        axis.text.x = element_text(size = 13, margin = margin(t=5)),
        axis.title.y = element_text(size = 14, margin = margin(r=5)),
        axis.text.y = element_text(size = 13, margin = margin(r=5)),
        legend.title = element_text(size = 12, face='bold'),
        legend.text = element_text(size = 12)) 

p3 <- df_gender_race %>%
  ungroup() %>%
  filter(race == 'Not White') %>%
  mutate(decile_predictions = cut_number(uscrs_predict, 10, labels= FALSE)) %>%
  group_by(decile_predictions) %>%
  summarise(predicted = mean(uscrs_predict),
            observed = mean(as.numeric(as.character(death6week))),
            mean_uscrs =  mean(uscrs_score),
            total = n()) %>%
  mutate(sd = sqrt(observed*(1-observed)),
         se = sd/sqrt(total),
         upper_ci = observed + 1.96*se,
         lower_ci = observed - 1.96*se) %>%
  ggplot(aes(x = predicted, y = observed)) +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) + 
  geom_abline(slope = 1, intercept = 0, color = '#880d1e', linetype = 2) + 
  theme_bw() + 
  xlab('US-CRS Predicted Risk of 6-Week Mortality') + ylab('Observed Risk of 6-Week Mortality') +
  xlim(0, 0.06) + ylim(0, 0.06) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14, margin = margin(t=5)),
        axis.text.x = element_text(size = 13, margin = margin(t=5)),
        axis.title.y = element_text(size = 14, margin = margin(r=5)),
        axis.text.y = element_text(size = 13, margin = margin(r=5)),
        legend.title = element_text(size = 12, face='bold'),
        legend.text = element_text(size = 12)) 

p4 <- df_gender_race %>%
  ungroup() %>%
  filter(race == 'White') %>%
  mutate(decile_predictions = cut_number(uscrs_predict, 10, labels= FALSE)) %>%
  group_by(decile_predictions) %>%
  summarise(predicted = mean(uscrs_predict),
            observed = mean(as.numeric(as.character(death6week))),
            mean_uscrs =  mean(uscrs_score),
            total = n()) %>%
  mutate(sd = sqrt(observed*(1-observed)),
         se = sd/sqrt(total),
         upper_ci = observed + 1.96*se,
         lower_ci = observed - 1.96*se) %>%
  ggplot(aes(x = predicted, y = observed)) +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) + 
  geom_abline(slope = 1, intercept = 0, color = '#880d1e', linetype = 2) + 
  theme_bw() + 
  xlab('US-CRS Predicted Risk of 6-Week Mortality') + ylab('') +
  xlim(0, 0.06) + ylim(0, 0.06) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14, margin = margin(t=5)),
        axis.text.x = element_text(size = 13, margin = margin(t=5)),
        axis.title.y = element_text(size = 14, margin = margin(r=5)),
        axis.text.y = element_text(size = 13, margin = margin(r=5)),
        legend.title = element_text(size = 12, face='bold'),
        legend.text = element_text(size = 12))     

cowplot::plot_grid(p1, p2, p3, p4, ncol=2, labels='auto', scale=0.9)
```


-------------


# 12. Check for informative censoring

```{r, echo=F, warning=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
set.seed(500)
sample_deaths <- sample(unique(df_intervals$PX_ID[df_intervals$death6week == '1']),
                    size = 100, replace = F)
sample_transplants <- sample(unique(df_intervals$PX_ID[df_intervals$transplant == '1']),
                    size = 100, replace = F)

df_censor <- df_intervals[df_intervals$PX_ID %in% c(sample_deaths, sample_transplants), 
                          c('PX_ID', 'interval_stop', 'last_group',
                            'death6week', 'transplant',
                            'albumin', 'bilirubin',
                            'eGFR', 'sodium', 'BNP',
                            'LVAD', 'short_MCS_ever')]
min_time <- min(df_censor$interval_stop[df_censor$last_group == '1' & df_censor$transplant == '1'])
df_censor$transplant_death <- 'Transplant'
df_censor$transplant_death[df_censor$PX_ID %in% sample_deaths] <- 'Death'

df_censor <- subset(df_censor, df_censor$interval_stop <= min_time)
df_censor <- df_censor[complete.cases(df_censor),]
df_censor <- df_censor %>% select(-c(PX_ID, interval_stop, last_group,
                                     death6week, transplant))


df_censor %>% 
  tbl_summary(by = transplant_death) %>%
  add_p()
```



-------------


# 13. Examine a model with center random effects

```{r, echo=F, warning=F, message=F, comment=NA}
model_mixed <- glmer(formula = as.formula(
  death6week ~ 
    albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever + (1 | CenterId)), 
  data = df_intervals[df_intervals$train_test == 'Train',],
  family = binomial)
```



-------------


# 14. Examine sensitivity and specificity at certain cut points

```{r, echo=F, warning=F, message=F, comment=NA}
sixstatus_auc <- roc(data=df_intervals_test, 
                     response=death6week, 
                     predictor=status_initial, direction='>', quiet=T)
french_auc <- roc(df_intervals_test_model_french_new$death6week ~ model_french_new_predict, direction='<')
us_auc <- roc(df_intervals_test_model_final$death6week ~ model_final_predict, direction='<')

coords(sixstatus_auc, x='best', input='threshold')
coords(french_auc, x='best', input='threshold')
coords(us_auc, x='best', input='threshold')

ci.coords(sixstatus_auc, x=0.9, input='specificity')
ci.coords(french_auc, x=0.9, input='specificity')
ci.coords(us_auc, x=0.9, input='specificity')

ci.coords(sixstatus_auc, x=0.9, input='sensitivity')
ci.coords(french_auc, x=0.9, input='sensitivity')
ci.coords(us_auc, x=0.9, input='sensitivity')

coords(sixstatus_auc, x=0.6, input='sensitivity')
coords(sixstatus_auc, x=0.7, input='sensitivity')
coords(sixstatus_auc, x=0.8, input='sensitivity')
coords(sixstatus_auc, x=0.9, input='sensitivity')
coords(sixstatus_auc, x=0.95, input='sensitivity')
coords(french_auc, x=0.6, input='sensitivity')
coords(french_auc, x=0.7, input='sensitivity')
coords(french_auc, x=0.8, input='sensitivity')
coords(french_auc, x=0.9, input='sensitivity')
coords(french_auc, x=0.95, input='sensitivity')
coords(us_auc, x=0.6, input='sensitivity')
coords(us_auc, x=0.7, input='sensitivity')
coords(us_auc, x=0.8, input='sensitivity')
coords(us_auc, x=0.9, input='sensitivity')
coords(us_auc, x=0.95, input='sensitivity')

coords(sixstatus_auc, x=0.6, input='specificity')
coords(sixstatus_auc, x=0.7, input='specificity')
coords(sixstatus_auc, x=0.8, input='specificity')
coords(sixstatus_auc, x=0.9, input='specificity')
coords(sixstatus_auc, x=0.95, input='specificity')
coords(french_auc, x=0.6, input='specificity')
coords(french_auc, x=0.7, input='specificity')
coords(french_auc, x=0.8, input='specificity')
coords(french_auc, x=0.9, input='specificity')
coords(french_auc, x=0.95, input='specificity')
coords(us_auc, x=0.6, input='specificity')
coords(us_auc, x=0.7, input='specificity')
coords(us_auc, x=0.8, input='specificity')
coords(us_auc, x=0.9, input='specificity')
coords(us_auc, x=0.95, input='specificity')
```



-------------


# 15. Examine model performance based on temporal split

```{r, echo=F, warning=F, message=F, comment=NA}
df_intervals$train_test <- 'Train'

px_test <- unique(df_intervals$PX_ID)
px_test <- px_test[(length(px_test) - floor(0.3*length(px_test)) + 1):length(px_test)]

df_intervals$train_test[df_intervals$PX_ID %in% px_test] <- 'Test'
df_intervals_train <- subset(df_intervals, df_intervals$train_test == 'Train')
df_intervals_test <- subset(df_intervals, df_intervals$train_test == 'Test')



model_french_new_temporal <- glm(formula = as.formula(
  death6week ~ 
    short_MCS_French_new + log(bilirubin + 1) + eGFR + log(BNP + 1):BNP_NT_Pro), 
  data = df_intervals_train, 
  family = binomial)


model_final_temporal <- glm(formula = as.formula(
  death6week ~ 
    albumin + log(bilirubin + 1) + 
    eGFR + sodium + 
    (log(BNP + 1):BNP_NT_Pro) + 
    LVAD + short_MCS_ever), 
  data = df_intervals_train, 
  family = binomial)



model_french_new_temporal_predict <- as.numeric(
  predict(model_french_new, newdata = df_intervals_test, type = 'response'))
model_french_new_temporal_indices <- which(!is.na(model_french_new_temporal_predict))
model_french_new_temporal_predict <- na.omit(model_french_new_temporal_predict)
df_intervals_test_model_french_new_temporal <- 
  df_intervals_test[(as.numeric(rownames(df_intervals_test)) %in% model_french_new_temporal_indices), ]


model_final_temporal_predict <- as.numeric(
  predict(model_final_temporal, newdata = df_intervals_test, type = 'response'))
model_final_temporal_indices <- which(!is.na(model_final_temporal_predict))
model_final_temporal_predict <- na.omit(model_final_temporal_predict)
df_intervals_test_model_final_temporal <- 
  df_intervals_test[(as.numeric(rownames(df_intervals_test)) %in% model_final_temporal_indices), ]



df_intervals_test$status_initial <- as.numeric(df_intervals_test$status_initial)
result <- auc(df_intervals_test$death6week ~ df_intervals_test$status_initial, direction='>')
result; ci.auc(result)


result <- auc(df_intervals_test_model_french_new_temporal$death6week ~ model_french_new_temporal_predict, 
              direction='<')
result; ci.auc(result)


result <- auc(df_intervals_test_model_final_temporal$death6week ~ model_final_temporal_predict, 
              direction='<')
result; ci.auc(result)
```
