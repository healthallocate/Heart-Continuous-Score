---
title: "Heart Transplant 14-Day Interval Data, Death in 6 Weeks"
output:
  html_document:
    toc: yes
    df_print: paged
  pdf_document:
    toc: yes
authors: Kevin Zhang, Kevin Lazenby, and William Parker
---
 
<!-- 1. Set up original modified dataset (Line 40) -->
<!-- 2. Merge with status justification datasets and create variables (Line 158) -->
<!-- 3. Merge with cand_thor dataset and create create time-related variables (Line 487) -->
<!-- 4. Set up remaining clinical variables (Line 741) -->
<!-- 5. Add in BNP type and fix sodium (Line 847) -->
<!-- 6. Create intervals (Line 868) -->
<!-- 7. Add memory variables (Line 1196) -->
<!-- 8. Death in 6 weeks (Line 1338) -->
<!-- 9. Count missingness (Line 1373) -->
<!-- 10. Impute variables (Line 1447) -->
<!-- 11. Generate new clinical variables (Line 1598) -->
<!-- 12. Histograms of variables (Line 1647) -->
<!-- 13. Sample checks between blocked and unblocked (Line 1729) -->



```{r setup, include=F, warning=F, echo=F, message=F, comment=NA}
rm(list=ls()); invisible(gc())
if (!require('pacman')) {install.packages('pacman')}
library(pacman)
pacman::p_load(tidyverse, Hmisc, ggplot2, expss, haven, lubridate, knitr, cowplot)
knitr::opts_knit$set(root.dir = '~/US-CRS')
```


---------------------------------


# 1. Set up original modified dataset

The starting dataset (*status_changes_pubsaf2303*) is from https://github.com/kevinlazenby/heart_data_pipeline. <br>
This dataset is checked against the most recent SRTR code in the later sections. As of writing, this was 2023 Q1 data.


```{r, warning=F, comment=NA, message=F}
df <- read.csv('./status_changes_pubsaf2303.csv')
df_raw <- df


## Patients who were listed from 2019 to 2022 
df2 <- subset(df, df$t_start == '0' & as.Date(df$unique_date) >= '2019-01-01' & as.Date(df$unique_date) <= '2022-12-31')
postpolicy_id <- unique(df2$PX_ID)
rm(df2)
df <- df[which(df$PX_ID %in% postpolicy_id), ]



## Select relevant variables
clinical_vars <- c('CAN_AGE_IN_MONTHS_AT_LISTING', 'CAN_DGN',
                'CAN_DIAB_TY', 'CAN_DIAL','CAN_PERIPH_VASC')

labs_vars <- c('sodium', 'creatinine', 'HrSevFailBun', 'albumin', 'AST',
               'arterial_lactate', 'HrSevFailInr', 'bilirubin', 'HrSevFailBun', 'BNP',
               'VadLdhLevels')

hemodynamic_vars <- c('systolicBP', 'diastolicBP', 'resting_HR',
                      'central_venous_pressure', 'cardiac_output', 'PCWP', 'PASP', 'PADP', 'HemoHemoglobin')

treatment_vars <- c(grep(names(df), pattern='ExtIno|_dose$|^InoSin|^InoMul|Iabp', value=T),
                    'EcmoWithHemo', 'EcmoWithoutHemo',
                    'ExtMcsdDobutamine', 'ExtMcsdDopamine',
                    'ExtMcsdEpinephrine', 'ExtMcsdMilrinone', 'CANHX_TAH',
                    'BivadPlacement', 'CAN_VAD_TY', 'CAN_VAD1')



df <- df[ ,which(colnames(df) %in% c('PX_ID', 'JustId', 
                                     'unique_event', 'unique_date','t_start', 't_stop',
                                     'RequestedCandStatCd', 'status_criteria', 'Exception', 
                                     clinical_vars, labs_vars, hemodynamic_vars, treatment_vars))]

colnames(df) <- c('PX_ID', 'JustId', 'events', 'date', 
                  't_start', 't_stop', 'systolicBP', 'PCWP', 
                  'central_venous_pressure', 'cardiac_output', 'arterial_lactate', 'AST',
                  
                  'creatinine', 'bilirubin', 'albumin', 'sodium', 
                  'BNP', 'heart_rate', 'diastolicBP', 'PASP', 
                  'PADP', 'hemoglobin', 'LDH', 'BUN',
                  
                  'INR', 'diagnosis', 'VAD', 'VAD_brand', 
                  'diabetes', 'dialysis', 'age_m', 'peripheral_vascular',
                  'status_criteria', 'status', 'exception', 'ecmo_hemo',
                  'ecmo_without_hemo', 'bivad', 'iabp_hemo', 'iabp_cardiacindex', 'iabp_without_hemo', 
                  
                  'InoSingle', 'InoMultiple', 'InoSinDobutamine', 'InoSinMilrinone', 
                  'InoSinEpinephrine', 'InoMulDobutamine', 'InoMulMilrinone',
                  
                  'InoMulEpinephrine', 'InoMulDopamine', 'ExtInoSingleDose', 'ExtInoMultiDose', 
                  'ExtInoSinDobutamine', 'ExtInoSinMilrinone', 'ExtInoSinEpinephrine', 'ExtInoMulDobutamine',
                  'ExtInoMulMilrinone','ExtInoMulEpinephrine', 'ExtInoMulDopamine', 'ExtMcsdDobutamine',
                  
                  'ExtMcsdDopamine', 'ExtMcsdEpinephrine', 'ExtMcsdMilrinone', 'ExtInotropeDobutamine', 
                  'ExtInotropeMilrinone', 'ExtInotropeEpinephrine', 'ExtInotropeDopamine', 
                  
                  'TAH','dobutamine_dose', 'milrinone_dose', 'dopamine_dose', 'epinephrine_dose')
rownames(df) <- seq(1:nrow(df))
df$date <- NULL



## TAH is completely missing and removed
## table(df$TAH, useNA='a')
df <- df %>% select(-TAH)
```


### Add transplant indicator based on a REC_TX event
```{r, warning=F, comment=NA, message=F}
df$transplant <- 0
df$transplant[which(grepl(pattern = 'REC_TX_DT', x = df$events))] <- 1
```


### Censor all observations after transplant
```{r, warning=F, comment=NA, message=F}
## A transplant "interval" counter
df <- df %>% group_by(PX_ID) %>%
  mutate(transplant = cumsum(cumsum(transplant)))


df %>% 
  filter(transplant > 0) %>%
  select(PX_ID, events, t_start, t_stop, transplant) %>%
  head(10)

## Ignore any intervals after transplant since we censor to transplant
df <- subset(df, df$transplant <= 1) 
```



### Modify transplant to ever/max transplant per patient to prevent dropping in later rows
```{r, warning=F, comment=NA, message=F}
df <- df %>% group_by(PX_ID) %>%
  mutate(transplant = max(transplant))


paste0('Number of Patients: ', length(unique(df$PX_ID)))
paste0('Number Transplanted: ', length(unique(df$PX_ID[df$transplant == 1])))
paste0('Percent Transplanted: ', round(100 * (length(unique(df$PX_ID[df$transplant == 1])) / length(unique(df$PX_ID))), 2))
```


---------------------------------


# 2. Merge with status justification datasets and create variables

```{r, warning=F, comment=NA, message=F}
## Merge is on JustId; remove whitespace from JustId to confirm
df$JustId <- trimws(df$JustId)


## Read in status datasets
df_just1 <- haven::read_sas('./JustFormHRStat1.sas7bdat')
df_just2 <- haven::read_sas('./JustFormHRStat2.sas7bdat')
df_just3 <- haven::read_sas('./JustFormHRStat3.sas7bdat')
df_just4 <- haven::read_sas('./JustFormHRStat4.sas7bdat')


## Status 1 justification and relevant variables
df_just1 <- df_just1[ ,c('JustId', 'EcmoWithHemo', 'EcmoWithoutHemo',
                         'EcmoCapWedgePressure', 'EcmoCardiacIndex',
                         'EcmoSystolicBloodPressure', 'EcmoWithoutHemoCprDt', 'EcmoWithoutHemoSbp',
                         'EcmoWithoutHemoArtLac', 'EcmoWithoutHemoAst', 'EcmoWithoutHemoAlt', 'VentricularEpisode',
                         'CriteriaBivadSupport', 'CriteriaEcmoSupport')]
df_just1$JustId <- trimws(df_just1$JustId)
df_just1 <- expss::drop_all_labels(df_just1)
df <- merge(df, df_just1, by = 'JustId', all.x = T, all.y = F, suffixes = c('.x', '.y'), no.dups = T)


## Status 2 justification
df_just2 <- df_just2[ ,c('JustId', 'IabpWithHemo', 'IabpWithoutHemo', 'IabpCapWedgePressure', 'IabpCardiacIndex',
                         'IabpSystolicBloodPressure', 'IabpWithoutHemoCprDt', 'IabpWithoutHemoSbp',
                         'IabpWithoutHemoArtLac', 'IabpWithoutHemoAst', 'IabpWithoutHemoAlt',
                         'CriteriaLvadSupport', 'CriteriaMcsdMalfunction', 'CriteriaDurableDevSupport',
                         'CriteriaVentEpisode', 'CriteriaMcsdEndovasSupp', 'CriteriaIabpSupport')]
df_just2$JustId <- trimws(df_just2$JustId)
df_just2 <- expss::drop_all_labels(df_just2)
df <- merge(df, df_just2, by = 'JustId', all.x = T, all.y = F, suffixes = c('.x', '.y'), no.dups = T)


## Status 3 justification
df_just3 <- df_just3[ ,c('JustId', grep(names(df_just3), pattern = 'Rhf', value=T),
                         'CriteriaVaEcmoSupport', 'CriteriaLvadSupport', 'CriteriaLvadDiscSupport', 
                         'CriteriaPercuSupport', 'CriteriaMcsdWithPump',
                         'CriteriaMcsdWithHemo', 'CriteriaMcsdMucosalBleed', 'CriteriaMcsdWithAI',
                         'CriteriaMcsdInfection', 'CriteriaInotropeSupport', 'CriteriaIabpSupport',
                         
                         'InoInotropeSupport','InoInvasiveCatheter', 'InoHemodynamicMonitoring', 
                         'InoCapWedgePressure', 'InoCardiacIndex', 'InoSysBloodPressure',
                         
                         'ExtInoSinDobutamine','ExtInoSinMilrinone', 'ExtInoSinEpinephrine', 
                         'ExtInoMulDobutamine', 'ExtInoMulMilrinone', 'ExtInoMulEpinephrine', 'ExtInoMulDopamine',
                         
                         'InoSinDobutamine', 'InoSinMilrinone', 'InoSinEpinephrine', 
                         'InoMulDobutamine', 'InoMulMilrinone', 'InoMulEpinephrine', 'InoMulDopamine',
                         'ExtMcsdDobutamine', 'ExtMcsdDopamine', 'ExtMcsdEpinephrine', 'ExtMcsdMilrinone')]
df_just3$JustId <- trimws(df_just3$JustId)
df_just3 <- expss::drop_all_labels(df_just3)

df_just3$CriteriaIabpSupport3 <- df_just3$CriteriaIabpSupport
df_just3$CriteriaIabpSupport <- NULL
df_just3$CriteriaLvadSupport3 <- df_just3$CriteriaLvadSupport
df_just3$CriteriaLvadSupport <- NULL
df <- merge(df, df_just3, by = 'JustId', all.x = T, all.y = F, suffixes = c('.x', '.y'), no.dups = T)


## Status 4 justification
df_just4 <- df_just4[ ,c('JustId', 'InotropeDobutamine', 'InotropeDopamine',
                         'InotropeEpinephrine', 'InotropeMilrinone', 
                         'CriteriaIschemicHeart', 'CriteriaInotropeSupport', 'InotropeCardiacIndex', 'InotropePcwp',
                         
                         'ExtInotropeDobutamine', 'ExtInotropeMilrinone', 'ExtInotropeEpinephrine', 'ExtInotropeDopamine')]
df_just4$JustId <- trimws(df_just4$JustId)
df_just4 <- expss::drop_all_labels(df_just4)

df_just4$CriteriaInotropeSupport4 <- df_just4$CriteriaInotropeSupport ## A rename to prevent duplicate columns
df_just4$CriteriaInotropeSupport <- NULL
df <- merge(df, df_just4, by = 'JustId', all.x = T, all.y = F, suffixes = c('.x', '.y'), no.dups = T)
```



## Inotrope variables
These lab variables are categorical, with cutoffs based on the 'High' cutoffs in the data dictionary. Lab variables are also 'High' if indicator variables for those variables are fulfilled. \newline

Categories are 'Not High' and 'High'. None includes 0 or no data. The cutoffs for 'High' (inclusive) when numeric: \newline

* 3 for dopamine
* 7.5 for dobutamine
* 0.5 for milrinone
* 0.02 for epinephrine


### Dopamine
```{r, warning=F, comment=NA, message=F}
df <- df %>%
  mutate(dopamine = case_when(
    
    as.numeric(dopamine_dose) >= 3 | as.numeric(McsdWithRhfDopamine) >= 3 | as.numeric(InotropeDopamine) >= 3 |
    as.numeric(ExtMcsdDopamine.y) >= 3 | as.numeric(ExtInotropeDopamine.y) >= 3 | 
    ExtInoMulDopamine.y == 1 | InoMulDopamine.y == 1 ~ 'High',
    
    TRUE ~ 'Not High')) 


df %>%
  filter(dopamine == 'High') %>%
  select(PX_ID, dopamine, dopamine_dose, McsdWithRhfDopamine, InotropeDopamine, 
         ExtMcsdDopamine.x, ExtMcsdDopamine.y, 
         ExtInotropeDopamine.x, ExtInotropeDopamine.y,
         ExtInoMulDopamine.x, ExtInoMulDopamine.y,
         InoMulDopamine.x, InoMulDopamine.y)
```


### Dobutamine
```{r, warning=F, comment=NA, message=F}
df <- df %>% 
  mutate(dobutamine = case_when(
    
    as.numeric(dobutamine_dose) >= 7.5 | as.numeric(McsdWithRhfDobutamine) >= 7.5 | as.numeric(InotropeDobutamine) >= 7.5 |
    as.numeric(ExtMcsdDobutamine.y) >= 7.5 | as.numeric(ExtInotropeDobutamine.y) >= 7.5 | 
    ExtInoSinDobutamine.y == 1 | InoSinDobutamine.y == 1 ~ 'High',
    
    TRUE ~ 'Not High'))


df %>%
  filter(dobutamine == 'High') %>%
  select(PX_ID, dobutamine, dobutamine_dose, McsdWithRhfDobutamine, InotropeDobutamine, 
         ExtMcsdDobutamine.x, ExtMcsdDobutamine.y, 
         ExtInotropeDobutamine.x, ExtInotropeDobutamine.y,
         ExtInoMulDobutamine.x, ExtInoMulDobutamine.y,
         ExtInoSinDobutamine.x, ExtInoSinDobutamine.y,
         InoSinDobutamine.x, InoSinDobutamine.y,
         InoMulDobutamine.x, InoMulDobutamine.y)
```


### Milrinone
```{r, warning=F, comment=NA, message=F}
df <- df %>% 
  mutate(milrinone = case_when(
    
    as.numeric(milrinone_dose) >= 0.5 | as.numeric(McsdWithRhfMilrinone) >= 0.5 | as.numeric(InotropeMilrinone) >= 0.5 |
    as.numeric(ExtMcsdMilrinone.y) >= 0.5 | as.numeric(ExtInotropeMilrinone.y) >= 0.5 | 
    ExtInoSinMilrinone.y == 1 | InoSinMilrinone.y == 1  ~ 'High',
    
    TRUE ~ 'Not High'))


df %>%
  filter(milrinone == 'High') %>%
  select(PX_ID, milrinone, milrinone_dose, McsdWithRhfMilrinone, InotropeMilrinone, 
         ExtMcsdMilrinone.x, ExtMcsdMilrinone.y, 
         ExtInotropeMilrinone.x, ExtInotropeMilrinone.y,
         ExtInoMulMilrinone.x, ExtInoMulMilrinone.y,
         ExtInoSinMilrinone.x, ExtInoSinMilrinone.y,
         InoSinMilrinone.x, InoSinMilrinone.y,
         InoMulMilrinone.x, InoMulMilrinone.y)
```


### Epinephrine
```{r, warning=F, comment=NA, message=F}
df <- df %>% 
  mutate(epinephrine = case_when(
    
    as.numeric(epinephrine_dose) >= 0.02 | as.numeric(McsdWithRhfEpinephrine) >= 0.02 | 
    as.numeric(InotropeEpinephrine) >= 0.02 |
    as.numeric(ExtMcsdEpinephrine.y) >= 0.02 | as.numeric(ExtInotropeEpinephrine.y) >= 0.02 | 
    ExtInoSinEpinephrine.y == 1 | InoSinEpinephrine.y == 1 ~ 'High',
    
    TRUE ~ 'Not High'))


df %>%
  filter(epinephrine == 'High') %>%
  select(PX_ID, epinephrine, epinephrine_dose, McsdWithRhfEpinephrine, InotropeEpinephrine, 
         ExtMcsdEpinephrine.x, ExtMcsdEpinephrine.y, 
         ExtInotropeEpinephrine.x, ExtInotropeEpinephrine.y,
         ExtInoMulEpinephrine.x, ExtInoMulEpinephrine.y,
         ExtInoSinEpinephrine.x, ExtInoSinEpinephrine.y,
         InoSinEpinephrine.x, InoSinEpinephrine.y,
         InoMulEpinephrine.x, InoMulEpinephrine.y)
```


### Remove component variables
```{r, warning=F, comment=NA, message=F}
df <- df %>%
  select(-c(
    
    ExtInoSingleDose, ExtInoMultiDose, 
  
    dopamine_dose, McsdWithRhfDopamineDt, InotropeDopamine, 
    ExtMcsdDopamine.x, ExtMcsdDopamine.y, 
    ExtInotropeDopamine.x, ExtInotropeDopamine.y,
    ExtInoMulDopamine.x, ExtInoMulDopamine.y,
    InoMulDopamine.x, InoMulDopamine.y,
         
    dobutamine_dose, McsdWithRhfDobutamineDt, InotropeDobutamine, 
    ExtMcsdDobutamine.x, ExtMcsdDobutamine.y, 
    ExtInotropeDobutamine.x, ExtInotropeDobutamine.y,
    ExtInoMulDobutamine.x, ExtInoMulDobutamine.y,
    ExtInoSinDobutamine.x, ExtInoSinDobutamine.y,
    InoSinDobutamine.x, InoSinDobutamine.y,
    InoMulDobutamine.x, InoMulDobutamine.y,
    
    milrinone_dose, McsdWithRhfEpinephrineDt, InotropeMilrinone, 
    ExtMcsdMilrinone.x, ExtMcsdMilrinone.y, 
    ExtInotropeMilrinone.x, ExtInotropeMilrinone.y,
    ExtInoMulMilrinone.x, ExtInoMulMilrinone.y,
    ExtInoSinMilrinone.x, ExtInoSinMilrinone.y,
    InoSinMilrinone.x, InoSinMilrinone.y,
    InoMulMilrinone.x, InoMulMilrinone.y,
    
    epinephrine_dose, McsdWithRhfMilrinoneDt, InotropeEpinephrine, 
    ExtMcsdEpinephrine.x, ExtMcsdEpinephrine.y, 
    ExtInotropeEpinephrine.x, ExtInotropeEpinephrine.y,
    ExtInoMulEpinephrine.x, ExtInoMulEpinephrine.y,
    ExtInoSinEpinephrine.x, ExtInoSinEpinephrine.y,
    InoSinEpinephrine.x, InoSinEpinephrine.y,
    InoMulEpinephrine.x, InoMulEpinephrine.y))
```



## Other treatment variables
```{r, warning=F, comment=NA, message=F}
df <- df %>%
  mutate(
    life_arrhythmia = case_when(VentricularEpisode == 1 ~ 1, TRUE ~ 0),
    
    angina = case_when(CriteriaIschemicHeart == 1 ~ 1, TRUE ~ 0),
    
    BiVAD_no_discharge = case_when(CriteriaBivadSupport == 1 ~ 1, TRUE ~ 0),
    
    temp_surg_LVAD = case_when(CriteriaLvadSupport == 1 ~ 1, TRUE ~ 0),
    
    v_tach_fib = case_when(CriteriaVentEpisode == 1 ~ 1, TRUE ~ 0),
    
    perc_LVAD = case_when(CriteriaMcsdEndovasSupp == 1 ~ 1, TRUE ~ 0),
    
    ###################################
    
    other_durable_MCSD = case_when(CriteriaDurableDevSupport == 1 ~ 1, TRUE ~ 0),
    
    MCSD_malfunction = case_when(CriteriaMcsdMalfunction == 1 ~ 1, TRUE ~ 0),
    
    MCSD_hemolysis = case_when(CriteriaMcsdWithHemo == 1  ~ 1, TRUE ~ 0),
    
    MCSD_device_infx = case_when(CriteriaMcsdInfection == 1 ~ 1, TRUE ~ 0),
    
    MCSD_bleed = case_when(CriteriaMcsdMucosalBleed == 1 ~ 1, TRUE ~ 0),
    
    MCSD_aortic_insf = case_when(CriteriaMcsdWithAI == 1 ~ 1, TRUE ~ 0),
    
    MCSD_rhf = case_when(
      CriteriaMcsdWithRhf == 1 | !is.na(McsdWithRhfDobutamine) | !is.na(McsdWithRhfDopamine) |
      !is.na(McsdWithRhfMilrinone) | !is.na(McsdWithRhfEpinephrine) | 
      (!is.na(McsdWithRhfNitricOxide) & McsdWithRhfNitricOxide > 0) | 
      (!is.na(McsdWithRhfProstacyclin) & McsdWithRhfProstacyclin > 0) |   
      !is.na(McsdWithRhfPcwp) | !is.na(McsdWithRhfVenPressure) ~ 1,
      TRUE ~ 0),
    
    MCSD_complication = case_when(
      MCSD_malfunction == 1 | MCSD_hemolysis == 1 | MCSD_device_infx == 1 | MCSD_bleed == 1 | 
      MCSD_aortic_insf == 1 | MCSD_rhf == 1 | CriteriaMcsdWithAI == 1 | CriteriaMcsdWithPump == 1 ~ 1,
      TRUE ~ 0),
    
    ###################################
    
    IV_inotropes = case_when(
      CriteriaInotropeSupport == 1 | CriteriaInotropeSupport4 == 1 | 
      InoSingle == 1 | InoMultiple == 1 |  InoInotropeSupport == 1 |
      InoInvasiveCatheter == 1 | InoHemodynamicMonitoring == 1 | 
      !is.na(InoCardiacIndex) | !is.na(InoCapWedgePressure) | !is.na(InoSysBloodPressure) |
      !is.na(InotropePcwp) | !is.na(InotropeCardiacIndex) |
      dopamine == 'High' | dobutamine == 'High' | epinephrine == 'High' | milrinone == 'High' ~ 1,
      
      TRUE ~ 0),
    
    IABP = case_when(
      CriteriaIabpSupport == 1 | CriteriaIabpSupport3 == 1 | IabpWithHemo == 1  | IabpWithoutHemo == 1 |
      !is.na(IabpCapWedgePressure) | !is.na(IabpCardiacIndex) | !is.na(IabpSystolicBloodPressure) |
      !is.na(IabpWithoutHemoAlt) | !is.na(IabpWithoutHemoArtLac) | !is.na(IabpWithoutHemoAst) |
      !is.na(IabpWithoutHemoCprDt) | !is.na(IabpWithoutHemoSbp) ~ 1,

      TRUE ~ 0),
    
    ECMO = case_when(
      CriteriaEcmoSupport == 1 | CriteriaVaEcmoSupport == 1 | EcmoWithHemo == 1 | EcmoWithoutHemo == 1 | 
      !is.na(EcmoCapWedgePressure) | !is.na(EcmoCardiacIndex) | !is.na(EcmoSystolicBloodPressure) |
      !is.na(EcmoWithoutHemoAlt) | !is.na(EcmoWithoutHemoArtLac) | !is.na(EcmoWithoutHemoAst) |
      !is.na(EcmoWithoutHemoCprDt) | !is.na(EcmoWithoutHemoCprDt) | !is.na(EcmoWithoutHemoSbp) ~ 1,
      
      TRUE ~ 0
    )
) %>%
  
  
  ### Remove component variables
  select(-c(VentricularEpisode, CriteriaIschemicHeart,
            CriteriaMcsdMalfunction, CriteriaVentEpisode,
            CriteriaMcsdWithHemo, CriteriaMcsdInfection, CriteriaMcsdMucosalBleed, CriteriaMcsdWithAI, 
            CriteriaMcsdWithPump,
            
            CriteriaMcsdWithRhf, McsdWithRhfDobutamine, McsdWithRhfDopamine, McsdWithRhfMilrinone,
            McsdWithRhfEpinephrine, McsdWithRhfNitricOxide, McsdWithRhfNitricOxideDt, 
            McsdWithRhfProstacyclin, McsdWithRhfProstacyclinDt,
            McsdWithRhfPcwp, McsdWithRhfPcwpDt, McsdWithRhfVenPressure, McsdWithRhfVenPressureDt,
            
            CriteriaInotropeSupport, CriteriaInotropeSupport4, InoSingle, InoMultiple, InoInotropeSupport,
            InoInvasiveCatheter, InoHemodynamicMonitoring,  InoCardiacIndex, InoCapWedgePressure, InoSysBloodPressure,
            InotropePcwp, InotropeCardiacIndex,
            
            CriteriaIabpSupport, CriteriaIabpSupport3, IabpWithHemo, IabpWithoutHemo,
            IabpCapWedgePressure, IabpCardiacIndex, IabpSystolicBloodPressure, IabpWithoutHemoAlt, 
            IabpWithoutHemoArtLac, IabpWithoutHemoAst, IabpWithoutHemoCprDt, IabpWithoutHemoSbp,
            
            CriteriaEcmoSupport, CriteriaVaEcmoSupport, EcmoWithHemo, EcmoWithoutHemo,
            EcmoCapWedgePressure, EcmoCardiacIndex, EcmoSystolicBloodPressure, EcmoWithoutHemoAlt, 
            EcmoWithoutHemoArtLac, EcmoWithoutHemoAst, EcmoWithoutHemoCprDt, EcmoWithoutHemoCprDt, EcmoWithoutHemoSbp,
            
            
            ecmo_hemo, ecmo_without_hemo, iabp_hemo, iabp_without_hemo, iabp_cardiacindex))
```


---------------------------------


# 3. Merge with cand_thor dataset and create time-related variables

```{r, warning=F, comment=NA, message=F}
df_candthor <- haven::read_sas('./cand_thor.sas7bdat')
df_candthor <- df_candthor[which(df_candthor$PX_ID %in% postpolicy_id), ]
df_candthor <- expss::drop_all_labels(df_candthor)
df_candthor_raw <- df_candthor



## Obtain relevant variables
df_candthor <- df_candthor[,c('PX_ID', 'CAN_LISTING_DT', 'PERS_SSA_DEATH_DT',
                              'PERS_OPTN_DEATH_DT', 'CAN_REM_DT', 'CAN_DEATH_DT',
                              'CAN_REM_CD', 'REC_TX_DT', 'CAN_LISTING_CTR_ID',
                              'CAN_LAST_ACT_STAT_DT', 'CAN_LAST_INACT_STAT_DT',
                              'CAN_VAD_TY', 'CAN_VAD1', 
                              'CAN_AGE_IN_MONTHS_AT_LISTING', 'CAN_DGN', 'CAN_DIAB_TY', 'CAN_DIAL', 'CAN_INIT_STAT')]



df_candthor <- df_candthor %>% 
  
  
  ## Rename variables
  mutate(
    transplant_cand_thor = case_when(!is.na(REC_TX_DT) | CAN_REM_CD == '4' ~ 1,
      TRUE ~ 0),
    
    CenterId = CAN_LISTING_CTR_ID,
    removal_code_cand_thor = CAN_REM_CD,
    start_date = as.Date(CAN_LISTING_DT),
    transplant_date = as.Date(REC_TX_DT),
    removal_date = as.Date(CAN_REM_DT),
    last_active_date = as.Date(CAN_LAST_ACT_STAT_DT),
    last_inactive_date = as.Date(CAN_LAST_INACT_STAT_DT),
    death_date = as.Date(CAN_DEATH_DT),
    death_date_max = pmax(CAN_DEATH_DT, PERS_SSA_DEATH_DT, PERS_OPTN_DEATH_DT, na.rm=T)) %>%
  
  mutate(transplant_time = ifelse(!is.na(transplant_date), 
                                  as.numeric(transplant_date - start_date, units='days'), 0)) %>%
  mutate(death_time = ifelse(!is.na(death_date_max), as.numeric(death_date_max - start_date, units='days'), 0)) %>%
  mutate(removal_time = as.numeric(pmax(removal_date, last_active_date, last_inactive_date, na.rm = T) - 
                                     start_date, units='days')) %>%
  
  
  ## Extra time after removal date in days (can be 0 or negative if no death); cannot be transplanted or dead at removal
  ## i.e. death_date_max - start_date - (removal_date - start_date) = death_date_max - removal_date
  mutate(
    extra_time = case_when(
      transplant_cand_thor != '1' & CAN_REM_CD != '8'  ~ 
        as.numeric(death_time - removal_time, units = 'days'),
      TRUE ~ 0)) %>%
  
  ## Keep only relevant variables
  select(PX_ID, CenterId, start_date, transplant_cand_thor, transplant_time, death_time, death_date_max, 
         extra_time, transplant_date, removal_date, removal_time,
         removal_code_cand_thor, death_date, death_date_max, CAN_VAD_TY, CAN_VAD1, 
         CAN_AGE_IN_MONTHS_AT_LISTING, CAN_DGN, CAN_DIAB_TY, CAN_DIAL, CAN_INIT_STAT, CAN_LISTING_DT)
```


### Merge cand_thor with df
```{r, warning=F, comment=NA, message=F}
df <- merge(df, df_candthor, all.x = T, all.y = F, by = 'PX_ID')
df <- df[order(df$PX_ID, df$t_start), ]
df <- df %>% relocate(CenterId, .after = PX_ID)
```



### Update with transplant observations that were present in candthor, last group, and start date variables
```{r, warning=F, comment=NA, message=F}
df <- df %>% 
  group_by(PX_ID) %>%
  mutate(
    transplant = case_when(
      transplant == '0' & transplant_cand_thor == '1' ~ 1,
      TRUE ~ transplant)) %>%
  
  mutate(
    ## Recreate max transplant, as before
    transplant = max(transplant),    
    
    ## Last group indicator, useful for other variables
    last_group = case_when(
      row_number() == n() ~ 1,
      TRUE ~ 0)) %>%
  
  select(-c(transplant_cand_thor))
```


### Confirm that all transplants from candthor were found
```{r, warning=F, comment=NA, message=F}
transplant_ids <- unique(df$PX_ID[df$transplant == 1])
transplant_ids_candthor <- unique(df_candthor$PX_ID[df_candthor$transplant_cand_thor == 1])

paste0('In Candthor, not in Dataset: ', setdiff(transplant_ids_candthor, transplant_ids))
paste0('In Dataset, not in Candthor: ', setdiff(transplant_ids, transplant_ids_candthor))
rm(transplant_ids_candthor)

paste0('Number of Patients: ', length(unique(df$PX_ID)))
paste0('Number Transplanted: ', length(unique(df$PX_ID[df$transplant == 1])))
paste0('Percent Transplanted: ', round(100 * (length(unique(df$PX_ID[df$transplant == 1])) / length(unique(df$PX_ID))), 2))
```



### Update with candthor's transplant time, death time, or removal time 
```{r, warning=F, comment=NA, message=F}
df <- df %>% relocate(last_group, .after = t_stop)

### Removal time from cand_thor (removal_date - start_date)
df$t_stop[df$last_group == '1' & df$transplant == '0' & !is.na(df$removal_time) & df$t_stop != df$removal_time] <-
  as.numeric(df$removal_time[df$last_group == '1' & 
                               df$transplant == '0' & 
                               !is.na(df$removal_time) & 
                               df$t_stop != df$removal_time])


### Only replace with death time from cand_thor if extra time is 0
df$t_stop[df$last_group == '1' & !is.na(df$death_time) & df$extra_time == 0 & df$death_time > df$t_stop] <-
  as.numeric(df$death_time[df$last_group == '1' & 
                             !is.na(df$death_time) & 
                             df$extra_time == 0 & 
                             df$death_time > df$t_stop])


### If both transplanted and died, transplant takes priority
### Change time to cand_thor's transplant time
df$t_stop[df$last_group == '1' & df$transplant == '1' & df$transplant_time != df$t_stop] <-
  as.numeric(df$transplant_time[df$last_group == '1' & 
                                  df$transplant == '1' & 
                                  df$transplant_time != df$t_stop])
```



### Sample PX_IDs showing the change; correct start and stop times accordingly

#### Extra time > 0
```{r, warning=F, comment=NA, message=F}
### Extra time exists: need 'phantom' intervals
df %>% filter(PX_ID == '1484214' | PX_ID == '1504645') %>% select(PX_ID, t_start, t_stop, last_group, removal_time, death_time, extra_time, transplant, transplant_time)
```

#### Extra time > 42
```{r, warning=F, comment=NA, message=F}
### Extra time is greater than 42: need to cut off the intervals past 42
df %>% filter(PX_ID == '1252414') %>% select(PX_ID, t_start, t_stop, last_group, removal_time, death_time, extra_time, transplant, transplant_time)
```

```{r, warning=F, comment=NA, message=F}
## Intervals to cut when extra time is more than 42
df$interval_cut_flag <- 0
df$interval_cut_flag[df$last_group == '1' & df$transplant == '0' &
                       (df$extra_time > 42) &
                       (df$t_start >= df$removal_time)] <- 1
df <- df %>% filter(interval_cut_flag == 0) %>% select(-interval_cut_flag)


## Recreate last group
df <- df %>% group_by(PX_ID) %>%  
  mutate(
    last_group = case_when(
      row_number() == n() ~ 1,
      TRUE ~ 0)) %>%
  
  mutate(
    t_stop = case_when(
      last_group == '1' & transplant == '0' & extra_time > 42 & 
        (t_stop > removal_time) & !is.na(removal_time) ~ removal_time,
      TRUE ~ t_stop)) %>%
  
  filter(last_group == 0 | 
        (last_group == '1' & t_start <= removal_time & transplant == '0') | 
        (last_group == '1' & transplant == '1'))


### Examine sample patients with different values of extra time
df %>% filter(PX_ID == '1252414' | PX_ID == '1484214' | PX_ID == '1504645') %>% 
  select(PX_ID, t_start, t_stop, last_group, removal_time, death_time, extra_time, transplant, transplant_time)
```



### Cut off extra rows past transplant date
```{r, warning=F, comment=NA, message=F}
### Sample patients that have extra intervals
df %>% filter(PX_ID == '1256398' | PX_ID == '1265188') %>%
  select(PX_ID, t_start, t_stop, transplant, transplant_time)
```


```{r, warning=F, comment=NA, message=F}
df <- df %>% 
  filter(transplant == '0' | (transplant == '1' & t_start <= transplant_time)) %>%
  
  mutate(t_stop = case_when(
    transplant == '1' & t_stop > transplant_time ~ transplant_time,
    TRUE ~ t_stop))

### Recheck these patients
df %>% filter(PX_ID == '1256398' | PX_ID == '1265188') %>%
  select(PX_ID, t_start, t_stop, transplant, transplant_time)
```



### Preliminary death indicator
```{r, warning=F, comment=NA, message=F}
df <- df %>% 
  mutate(death_flag = case_when(
    (!is.na(death_date_max) | removal_code_cand_thor == '8') & transplant == '0' & extra_time <= 42 ~ '1' ,
    TRUE ~ '0'))
```


### Confirm that all deaths from candthor were found
```{r, warning=F, comment=NA, message=F}
death_ids <- unique(df$PX_ID[df$death_flag == 1])


candthor_death_ids <- df_candthor_raw %>%
  select(PX_ID, CAN_REM_CD, CAN_REM_DT, CAN_DEATH_DT, PERS_OPTN_DEATH_DT, PERS_SSA_DEATH_DT, REC_TX_DT) %>%
  filter(CAN_REM_CD == '8' | !is.na(CAN_DEATH_DT) | !is.na(PERS_OPTN_DEATH_DT) | !is.na(PERS_SSA_DEATH_DT)) %>%
  
  mutate(death_dt = pmin(CAN_DEATH_DT, PERS_OPTN_DEATH_DT, PERS_SSA_DEATH_DT, na.rm=T)) %>%
  mutate(time_since_rm = difftime(death_dt, CAN_REM_DT, units='days')) %>%
  
  filter(time_since_rm <= 42) %>%
  filter(is.na(REC_TX_DT))
candthor_death_ids <- unique(candthor_death_ids$PX_ID)


paste0('In Candthor, not in Dataset: ', setdiff(candthor_death_ids, death_ids))
paste0('In Dataset, not in Candthor: ', setdiff(death_ids, candthor_death_ids))
rm(candthor_death_ids)
```


### Examine the single case: dropped in our dataset since no time available (same day)
```{r, warning=F, comment=NA, message=F}
df_candthor_raw %>% filter(PX_ID == '1288472') %>%
  select(PX_ID, CAN_LISTING_DT, CAN_DEATH_DT, PERS_SSA_DEATH_DT, PERS_OPTN_DEATH_DT, REC_TX_DT, CAN_REM_CD)

death_ids <- subset(death_ids, death_ids != '1288472')
df <- subset(df, df$PX_ID != '1288472')
```


---------------------------------


# 4. Set up remaining clinical variables

```{r, warning=F, comment=NA, message=F}
## Age in years
df$age <- df$CAN_AGE_IN_MONTHS_AT_LISTING / 12


## Initial status at listing
# 2010 = Status 1A, 2020 = Status 1B, 2030 = (Old) Status 2
df$status <- recode_factor(df$status,
                           '1110' = '1', '1120' = '2', '1130' = '3',
                           '1140' = '4', '1150' = '5', '1160' = '6',
                           '2110' = '1', '2120' = '2', '2130' = '3',
                           '2140' = '4', '2150' = '5', '2160' = '6',
                           
                           '1999' = 'inactive', 
                           '2010' = NA_character_, '2020' = NA_character_, '2030' = '6',
                           '2999' = 'inactive')
df$status_initial <- recode_factor(df$CAN_INIT_STAT,
                           '1110' = '1', '1120' = '2', '1130' = '3',
                           '1140' = '4', '1150' = '5', '1160' = '6',
                           '2110' = '1', '2120' = '2', '2130' = '3',
                           '2140' = '4', '2150' = '5', '2160' = '6',
                           
                           '1999' = 'inactive', 
                           '2010' = NA_character_, '2020' = NA_character_, '2030' = '6',
                           '2999' = 'inactive')


###################################


## Diagnosis, diabetes, and dialysis
df$diagnosis <- as.numeric(df$CAN_DGN)
df <- df %>% mutate(
  diagnosis = case_when(
    diagnosis >= 1000 & diagnosis <= 1049 & diagnosis != 1007 ~ 'Dilated_CM',
    diagnosis >= 1050 & diagnosis <= 1099 & diagnosis != 1051 ~ 'Restricted',
    diagnosis == 1051 ~ 'Amyloid',
    diagnosis >= 1101 & diagnosis <= 1106 ~ 'Re-Transplant',
    diagnosis == 1201 ~ 'Hypertrophic',
    diagnosis == 1202 ~ 'Valvular',
    diagnosis == 1203 | (diagnosis >= 1205 & diagnosis <= 1209) ~ 'Congenital', 
    diagnosis == 1200 | diagnosis == 1007 ~ 'Ischemic',
    TRUE ~ 'Other'), 
  
   diabetes = case_when(
    CAN_DIAB_TY == 1 ~ '0',
    CAN_DIAB_TY == 2 | CAN_DIAB_TY == 3 | CAN_DIAB_TY == 4 | CAN_DIAB_TY == 5 ~ '1',
    TRUE ~ NA_character_),
  
  
  dialysis = case_when(
    CAN_DIAL == 1 ~ '0',
    CAN_DIAL == 2 | CAN_DIAL == 3 | CAN_DIAL == 4 | CAN_DIAL == 5 | CAN_DIAL == 999 ~ '1',
    TRUE ~ NA_character_)
  )


###################################


## LVAD, RVAD, BiVAD
df <- df %>% mutate(
  LVAD = case_when(
    CriteriaLvadSupport == 1 | CriteriaLvadSupport3 == 1 | CriteriaLvadDiscSupport == 1 |
    CriteriaMcsdEndovasSupp == 1 | CriteriaPercuSupport == 1 | 
    (CAN_VAD_TY == 2) |
    (CAN_VAD1 %in% c('205', '236', '313', '330', '206', '208', '314', '210', '319', '216', '305', '217',
                    '306', '223', '312', '224', '316', '230', '324', '231', '325', '232', '326', '233', '327')) ~ 1,
    
    TRUE ~ 0),
  
  
  RVAD = case_when(
    CriteriaDurableDevSupport == 1 | CriteriaMcsdEndovasSupp == 1 | CriteriaPercuSupport == 1 | 
    (CAN_VAD_TY == 3) |
    (CAN_VAD_TY != 1 & !is.na(CAN_VAD_TY) & 
       !(CAN_VAD1 %in% c('205', '236', '313', '330', '206', '208', '314', '210', '319', '216', '305', '217',
                    '306', '223', '312', '224', '316', '230', '324', '231', '325', '232', '326', '233', '327'))) ~ 1,
  TRUE ~ 0),
  
  
  BiVAD = case_when(
    CriteriaMcsdEndovasSupp == 1 | CriteriaPercuSupport == 1 | CriteriaBivadSupport == 1 |
    (LVAD == 1 & RVAD == 1) |
    bivad == 1 ~ 1,
 TRUE ~ 0))



df <- df %>% select(-c(JustId, events,
                       start_date, transplant_time, death_time, death_date_max, transplant_date,
                       removal_date, removal_time, removal_code_cand_thor, death_date, extra_time,
                       
                       age_m, CAN_AGE_IN_MONTHS_AT_LISTING, CAN_INIT_STAT, CAN_DGN, CAN_DIAB_TY, CAN_DIAL,
                       
                       CriteriaLvadSupport, CriteriaLvadSupport3, CriteriaLvadDiscSupport, CriteriaBivadSupport, 
                       CriteriaMcsdEndovasSupp, CriteriaPercuSupport, CriteriaDurableDevSupport, 
                       CAN_VAD_TY, CAN_VAD1, VAD, VAD_brand, bivad))
```


---------------------------------


# 5. Add in BNP type and fix sodium

```{r, warning=F, comment=NA, message=F}
df_riskstrat <- haven::read_sas('./RiskStratDataHR.sas7bdat')
df_riskstrat <- df_riskstrat %>% select(px_id, HrSevFailNtBnpType) 


df$BNP_NT_Pro <- 0
df$BNP_NT_Pro[df$PX_ID %in%
                unique(df_riskstrat$px_id[df_riskstrat$HrSevFailNtBnpType == 'NT Pro BNP'])] <- 1


### Assume sodium < 100 is a data entry error
df$sodium <- as.numeric(df$sodium)
df$sodium[df$sodium < 100] <- NA
```


---------------------------------


# 6. Create intervals

### Save non-interval data
```{r, warning=F, comment=NA, message=F}
save(df, file = './intervals_v17_continuous.RData')
```


### Adjust time variables
```{r, warning=F, comment=NA, message=F}
### Reconstruct transplant, remove preliminary death flag since we have death ids
df <- df %>% group_by(PX_ID) %>%
  mutate(transplant = max(transplant)) %>%
  select(-c(death_flag))
```


### Deal with inactive statuses
```{r, warning=F, comment=NA, message=F}
df$status[df$status == 'inactive'] <- NA_character_

df <- df %>% 
  group_by(PX_ID) %>%
  fill(status) %>%
  mutate(status = as.factor(status),
         time = t_stop - t_start)
```


### Create 14-day intervals and interval numbers
```{r, warning=F, comment=NA, message=F}
df_setup <- data.frame('PX_ID' = df$PX_ID,
                       'cumulative_time' = df$t_stop,
                       'last_group' = df$last_group,
                       'counts' = ceiling(df$time / 14))
df_setup$counts[df_setup$counts == 0] <- 1

df_setup <- df_setup %>% 
  group_by(PX_ID) %>%
  mutate(cumulative_days = 14 * cumsum(counts)) %>%
  mutate(intervals_add = case_when(
    cumulative_days < cumulative_time ~ 1,
    TRUE ~ 0)) %>%
  mutate(intervals_add = max(intervals_add))

df_setup$counts[df_setup$intervals_add == 1] <- df_setup$counts[df_setup$intervals_add == 1] + 1
df_setup$counts[df_setup$counts == 0 & df_setup$last_group == 1] <- 1


row_reps <- rep(1:nrow(df), df_setup$counts)
df_intervals <- df[row_reps, ]



df_intervals <- df_intervals %>% group_by(PX_ID) %>%
  mutate(
    interval = row_number(),
    interval_start = 14 * (interval - 1),
    interval_stop = 14 * interval,
    max_time = max(t_stop)) 
```


### Convert continuous time-series to discrete-time format
```{r, warning=F, comment=NA, message=F}
# Remove extra intervals
df_intervals <- df_intervals %>%
  group_by(PX_ID) %>%
  
  filter(interval_start < max_time | max_time == 0)


## Reassign last group flags to df_intervals
df_intervals <- df_intervals %>% group_by(PX_ID) %>%
  mutate(
    last_group = case_when(
      row_number() == n() ~ 1,
      TRUE ~ 0)) %>% 
  ungroup()

## Reassign last group flags to df
df <- df %>% group_by(PX_ID) %>%
  mutate(
    last_group = case_when(
      row_number() == n() ~ 1,
      TRUE ~ 0)) %>% 
  ungroup()

vars_to_mutate <- c("systolicBP", "PCWP", 
                    "central_venous_pressure", "cardiac_output",
                    "arterial_lactate",
                    "AST", "creatinine", "bilirubin", "albumin",
                    "sodium", "BNP", "BNP_NT_Pro", "heart_rate", "diastolicBP",
                    "PASP", "PADP", "hemoglobin", "LDH", "BUN", "INR", "diagnosis",
                    "diabetes", "dialysis", "peripheral_vascular", "status_criteria",
                    "status", "status_initial",
                    "exception", "dobutamine", "dopamine", "epinephrine",
                    "milrinone", "IV_inotropes", "IABP", "ECMO", "BiVAD", "LVAD",
                    "RVAD", "MCSD_complication", "age", "life_arrhythmia",
                    "BiVAD_no_discharge",
                    "temp_surg_LVAD", "other_durable_MCSD", "MCSD_malfunction",
                    "v_tach_fib", "perc_LVAD", "MCSD_hemolysis", "MCSD_rhf", 
                    "MCSD_device_infx", "MCSD_bleed", "MCSD_aortic_insf", 
                    "angina")

for (i in 1:(nrow(df_intervals))) {
  
  PX_ID_at_index <- df_intervals[i,]$PX_ID
  
  # Check if this interval is the first interval for the given patient
  # If true, assign initial values from df to df_intervals
  if (df_intervals$interval_start[i] == 0) {
    
    initial_values <- df %>% 
      filter(PX_ID == PX_ID_at_index & t_start == 0) %>%
      select(all_of(vars_to_mutate))
    
    df_intervals$systolicBP[i] <- initial_values %>% pull(systolicBP)
    df_intervals$PCWP[i] <- initial_values %>% pull(PCWP)
    df_intervals$central_venous_pressure[i] <- initial_values %>% pull(central_venous_pressure)
    df_intervals$cardiac_output[i] <- initial_values %>% pull(cardiac_output)
    df_intervals$arterial_lactate[i] <- initial_values %>% pull(arterial_lactate)
    df_intervals$AST[i] <- initial_values %>% pull(AST)
    df_intervals$creatinine[i] <- initial_values %>% pull(creatinine)
    df_intervals$bilirubin[i] <- initial_values %>% pull(bilirubin)
    df_intervals$albumin[i] <- initial_values %>% pull(albumin)
    df_intervals$sodium[i] <- initial_values %>% pull(sodium)
    df_intervals$BNP[i] <- initial_values %>% pull(BNP)
    df_intervals$BNP_NT_Pro[i] <- initial_values %>% pull(BNP_NT_Pro)
    df_intervals$heart_rate[i] <- initial_values %>% pull(heart_rate)
    df_intervals$diastolicBP[i] <- initial_values %>% pull(diastolicBP)
    df_intervals$PASP[i] <- initial_values %>% pull(PASP)
    df_intervals$PADP[i] <- initial_values %>% pull(PADP)
    df_intervals$hemoglobin[i] <- initial_values %>% pull(hemoglobin)
    df_intervals$LDH[i] <- initial_values %>% pull(LDH)
    df_intervals$BUN[i] <- initial_values %>% pull(BUN)
    df_intervals$INR[i] <- initial_values %>% pull(INR)
    df_intervals$diagnosis[i] <- initial_values %>% pull(diagnosis)
    df_intervals$diabetes[i] <- initial_values %>% pull(diabetes)
    df_intervals$dialysis[i] <- initial_values %>% pull(dialysis)
    df_intervals$peripheral_vascular[i] <- initial_values %>% pull(peripheral_vascular)
    df_intervals$status_criteria[i] <- initial_values %>% pull(status_criteria)
    df_intervals$status[i] <- initial_values %>% pull(status)
    df_intervals$status_initial[i] <- initial_values %>% pull(status_initial)
    df_intervals$exception[i] <- initial_values %>% pull(exception)
    df_intervals$dobutamine[i] <- initial_values %>% pull(dobutamine)
    df_intervals$dopamine[i] <- initial_values %>% pull(dopamine)
    df_intervals$epinephrine[i] <- initial_values %>% pull(epinephrine)
    df_intervals$milrinone[i] <- initial_values %>% pull(milrinone)
    df_intervals$IV_inotropes[i] <- initial_values %>% pull(IV_inotropes)
    df_intervals$IABP[i] <- initial_values %>% pull(IABP)
    df_intervals$ECMO[i] <- initial_values %>% pull(ECMO)
    df_intervals$BiVAD[i] <- initial_values %>% pull(BiVAD)
    df_intervals$LVAD[i] <- initial_values %>% pull(LVAD)
    df_intervals$RVAD[i] <- initial_values %>% pull(RVAD)
    df_intervals$MCSD_complication[i] <- initial_values %>% pull(MCSD_complication)
    df_intervals$age[i] <- initial_values %>% pull(age)    
    df_intervals$life_arrhythmia[i] <- initial_values %>% pull(life_arrhythmia)
    df_intervals$BiVAD_no_discharge[i] <- initial_values %>% pull(BiVAD_no_discharge)
    df_intervals$temp_surg_LVAD[i] <- initial_values %>% pull(temp_surg_LVAD)
    df_intervals$other_durable_MCSD[i] <- initial_values %>% pull(other_durable_MCSD)
    df_intervals$MCSD_malfunction[i] <- initial_values %>% pull(MCSD_malfunction)
    df_intervals$v_tach_fib[i] <- initial_values %>% pull(v_tach_fib)
    df_intervals$perc_LVAD[i] <- initial_values %>% pull(perc_LVAD)
    df_intervals$MCSD_hemolysis[i] <- initial_values %>% pull(MCSD_hemolysis)
    df_intervals$MCSD_rhf[i] <- initial_values %>% pull(MCSD_rhf)
    df_intervals$MCSD_device_infx[i] <- initial_values %>% pull(MCSD_device_infx)
    df_intervals$MCSD_bleed[i] <- initial_values %>% pull(MCSD_bleed)
    df_intervals$MCSD_aortic_insf[i] <- initial_values %>% pull(MCSD_aortic_insf)
    df_intervals$angina[i] <- initial_values %>% pull(angina)
    
    # Check if this interval is the last interval for the given patient
    # If true, assign final values from df to df_intervals
  } else if (df_intervals$last_group[i] == 1) {
    
    final_values <- df %>% 
      filter(PX_ID == PX_ID_at_index & last_group == 1) %>%
      select(all_of(vars_to_mutate))
    
    df_intervals$systolicBP[i] <- final_values %>% pull(systolicBP)
    df_intervals$PCWP[i] <- final_values %>% pull(PCWP)
    df_intervals$central_venous_pressure[i] <- final_values %>% pull(central_venous_pressure)
    df_intervals$cardiac_output[i] <- final_values %>% pull(cardiac_output)
    df_intervals$arterial_lactate[i] <- final_values %>% pull(arterial_lactate)
    df_intervals$AST[i] <- final_values %>% pull(AST)
    df_intervals$creatinine[i] <- final_values %>% pull(creatinine)
    df_intervals$bilirubin[i] <- final_values %>% pull(bilirubin)
    df_intervals$albumin[i] <- final_values %>% pull(albumin)
    df_intervals$sodium[i] <- final_values %>% pull(sodium)
    df_intervals$BNP[i] <- final_values %>% pull(BNP)
    df_intervals$BNP_NT_Pro[i] <- final_values %>% pull(BNP_NT_Pro)
    df_intervals$heart_rate[i] <- final_values %>% pull(heart_rate)
    df_intervals$diastolicBP[i] <- final_values %>% pull(diastolicBP)
    df_intervals$PASP[i] <- final_values %>% pull(PASP)
    df_intervals$PADP[i] <- final_values %>% pull(PADP)
    df_intervals$hemoglobin[i] <- final_values %>% pull(hemoglobin)
    df_intervals$LDH[i] <- final_values %>% pull(LDH)
    df_intervals$BUN[i] <- final_values %>% pull(BUN)
    df_intervals$INR[i] <- final_values %>% pull(INR)
    df_intervals$diagnosis[i] <- final_values %>% pull(diagnosis)
    df_intervals$diabetes[i] <- final_values %>% pull(diabetes)
    df_intervals$dialysis[i] <- final_values %>% pull(dialysis)
    df_intervals$peripheral_vascular[i] <- final_values %>% pull(peripheral_vascular)
    df_intervals$status_criteria[i] <- final_values %>% pull(status_criteria)
    df_intervals$status[i] <- final_values %>% pull(status)
    df_intervals$status_initial[i] <- final_values %>% pull(status_initial)
    df_intervals$exception[i] <- final_values %>% pull(exception)
    df_intervals$dobutamine[i] <- final_values %>% pull(dobutamine)
    df_intervals$dopamine[i] <- final_values %>% pull(dopamine)
    df_intervals$epinephrine[i] <- final_values %>% pull(epinephrine)
    df_intervals$milrinone[i] <- final_values %>% pull(milrinone)
    df_intervals$IV_inotropes[i] <- final_values %>% pull(IV_inotropes)
    df_intervals$IABP[i] <- final_values %>% pull(IABP)
    df_intervals$ECMO[i] <- final_values %>% pull(ECMO)
    df_intervals$BiVAD[i] <- final_values %>% pull(BiVAD)
    df_intervals$LVAD[i] <- final_values %>% pull(LVAD)
    df_intervals$RVAD[i] <- final_values %>% pull(RVAD)
    df_intervals$MCSD_complication[i] <- final_values %>% pull(MCSD_complication)
    df_intervals$age[i] <- final_values %>% pull(age)    
    df_intervals$life_arrhythmia[i] <- final_values %>% pull(life_arrhythmia)
    df_intervals$BiVAD_no_discharge[i] <- final_values %>% pull(BiVAD_no_discharge)
    df_intervals$temp_surg_LVAD[i] <- final_values %>% pull(temp_surg_LVAD)
    df_intervals$other_durable_MCSD[i] <- final_values %>% pull(other_durable_MCSD)
    df_intervals$MCSD_malfunction[i] <- final_values %>% pull(MCSD_malfunction)
    df_intervals$v_tach_fib[i] <- final_values %>% pull(v_tach_fib)
    df_intervals$perc_LVAD[i] <- final_values %>% pull(perc_LVAD)
    df_intervals$MCSD_hemolysis[i] <- final_values %>% pull(MCSD_hemolysis)
    df_intervals$MCSD_rhf[i] <- final_values %>% pull(MCSD_rhf)
    df_intervals$MCSD_device_infx[i] <- final_values %>% pull(MCSD_device_infx)
    df_intervals$MCSD_bleed[i] <- final_values %>% pull(MCSD_bleed)
    df_intervals$MCSD_aortic_insf[i] <- final_values %>% pull(MCSD_aortic_insf)
    df_intervals$angina[i] <- final_values %>% pull(angina)
    
  } else {
    
    # Find most recent row for the given patient in df that starts 
    # before current interval in df_intervals, and assign values to 
    # current interval in df_intervals
    
    previous_values <- df %>%
      filter(PX_ID == PX_ID_at_index &
               t_start <= df_intervals$interval_start[i]) %>%
      filter(t_start == max(t_start)) %>%
      select(all_of(vars_to_mutate))
      
      
    df_intervals$systolicBP[i] <- previous_values %>% pull(systolicBP)
    df_intervals$PCWP[i] <- previous_values %>% pull(PCWP)
    df_intervals$central_venous_pressure[i] <- previous_values %>% pull(central_venous_pressure)
    df_intervals$cardiac_output[i] <- previous_values %>% pull(cardiac_output)
    df_intervals$arterial_lactate[i] <- previous_values %>% pull(arterial_lactate)
    df_intervals$AST[i] <- previous_values %>% pull(AST)
    df_intervals$creatinine[i] <- previous_values %>% pull(creatinine)
    df_intervals$bilirubin[i] <- previous_values %>% pull(bilirubin)
    df_intervals$albumin[i] <- previous_values %>% pull(albumin)
    df_intervals$sodium[i] <- previous_values %>% pull(sodium)
    df_intervals$BNP[i] <- previous_values %>% pull(BNP)
    df_intervals$BNP_NT_Pro[i] <- previous_values %>% pull(BNP_NT_Pro)
    df_intervals$heart_rate[i] <- previous_values %>% pull(heart_rate)
    df_intervals$diastolicBP[i] <- previous_values %>% pull(diastolicBP)
    df_intervals$PASP[i] <- previous_values %>% pull(PASP)
    df_intervals$PADP[i] <- previous_values %>% pull(PADP)
    df_intervals$hemoglobin[i] <- previous_values %>% pull(hemoglobin)
    df_intervals$LDH[i] <- previous_values %>% pull(LDH)
    df_intervals$BUN[i] <- previous_values %>% pull(BUN)
    df_intervals$INR[i] <- previous_values %>% pull(INR)
    df_intervals$diagnosis[i] <- previous_values %>% pull(diagnosis)
    df_intervals$diabetes[i] <- previous_values %>% pull(diabetes)
    df_intervals$dialysis[i] <- previous_values %>% pull(dialysis)
    df_intervals$peripheral_vascular[i] <- previous_values %>% pull(peripheral_vascular)
    df_intervals$status_criteria[i] <- previous_values %>% pull(status_criteria)
    df_intervals$status[i] <- previous_values %>% pull(status)
    df_intervals$status_initial[i] <- previous_values %>% pull(status_initial)
    df_intervals$exception[i] <- previous_values %>% pull(exception)
    df_intervals$dobutamine[i] <- previous_values %>% pull(dobutamine)
    df_intervals$dopamine[i] <- previous_values %>% pull(dopamine)
    df_intervals$epinephrine[i] <- previous_values %>% pull(epinephrine)
    df_intervals$milrinone[i] <- previous_values %>% pull(milrinone)
    df_intervals$IV_inotropes[i] <- previous_values %>% pull(IV_inotropes)
    df_intervals$IABP[i] <- previous_values %>% pull(IABP)
    df_intervals$ECMO[i] <- previous_values %>% pull(ECMO)
    df_intervals$BiVAD[i] <- previous_values %>% pull(BiVAD)
    df_intervals$LVAD[i] <- previous_values %>% pull(LVAD)
    df_intervals$RVAD[i] <- previous_values %>% pull(RVAD)
    df_intervals$MCSD_complication[i] <- previous_values %>% pull(MCSD_complication)
    df_intervals$age[i] <- previous_values %>% pull(age)    
    df_intervals$life_arrhythmia[i] <- previous_values %>% pull(life_arrhythmia)
    df_intervals$BiVAD_no_discharge[i] <- previous_values %>% pull(BiVAD_no_discharge)
    df_intervals$temp_surg_LVAD[i] <- previous_values %>% pull(temp_surg_LVAD)
    df_intervals$other_durable_MCSD[i] <- previous_values %>% pull(other_durable_MCSD)
    df_intervals$MCSD_malfunction[i] <- previous_values %>% pull(MCSD_malfunction)
    df_intervals$v_tach_fib[i] <- previous_values %>% pull(v_tach_fib)
    df_intervals$perc_LVAD[i] <- previous_values %>% pull(perc_LVAD)
    df_intervals$MCSD_hemolysis[i] <- previous_values %>% pull(MCSD_hemolysis)
    df_intervals$MCSD_rhf[i] <- previous_values %>% pull(MCSD_rhf)
    df_intervals$MCSD_device_infx[i] <- previous_values %>% pull(MCSD_device_infx)
    df_intervals$MCSD_bleed[i] <- previous_values %>% pull(MCSD_bleed)
    df_intervals$MCSD_aortic_insf[i] <- previous_values %>% pull(MCSD_aortic_insf)
    df_intervals$angina[i] <- previous_values %>% pull(angina)
    
  }
}
```


### Clean up intervals
```{r, warning=F, comment=NA, message=F}
## Clean up old time variables and string variables 
df_intervals <- df_intervals %>% select(-c(t_start, t_stop, time))
df_intervals <- data.frame(lapply(df_intervals, trimws), stringsAsFactors = F) 
df_intervals$exception[is.na(df_intervals$exception) == T] <- '0'
```


### Fix some final variables
```{r, warning=F, comment=NA, message=F}
### Divide certain variables by 10 or 100
df_intervals <- df_intervals %>% 
  mutate(BNP = as.numeric(BNP) / 100,
         BUN = as.numeric(BUN) / 10,
         AST = as.numeric(AST) / 100,
         heart_rate = as.numeric(heart_rate) / 10)
```


---------------------------------


# 7. Add memory variables

### Treatments: ever on?
```{r, warning=F, comment=NA, message=F}
df_intervals <- df_intervals %>%
  group_by(PX_ID) %>%
  
  mutate(IV_inotropes_ever = case_when(IV_inotropes == '1' ~ '1', TRUE ~ NA_character_),
         IABP_ever = case_when(IABP == '1' ~ '1', TRUE ~ NA_character_),
         ECMO_ever = case_when(ECMO == '1' ~ '1', TRUE ~ NA_character_),
         BiVAD_ever = case_when(BiVAD == '1' ~ '1', TRUE ~ NA_character_),
         LVAD_ever = case_when(LVAD == '1' ~ '1', TRUE ~ NA_character_),
         RVAD_ever = case_when(RVAD == '1' ~ '1', TRUE ~ NA_character_),
         exception_ever = case_when(exception == '1' ~ '1', TRUE ~ NA_character_),
         temp_surg_ever = case_when(temp_surg_LVAD == '1' ~ '1', TRUE ~ NA_character_),
         BiVAD_no_discharge_ever = case_when(BiVAD_no_discharge == '1' ~ '1', TRUE ~ NA_character_)) %>%
  
  fill(ECMO_ever, .direction = 'down') %>%
  fill(BiVAD_ever, .direction = 'down') %>%
  fill(LVAD_ever, .direction = 'down') %>%
  fill(RVAD_ever, .direction = 'down') %>%
  fill(exception_ever, .direction = 'down') %>%
  fill(temp_surg_ever, .direction = 'down') %>%
  fill(BiVAD_no_discharge_ever, .direction = 'down') %>%

  mutate(IV_inotropes_ever = case_when(is.na(IV_inotropes_ever) ~ '0', TRUE ~ IV_inotropes_ever),
         IABP_ever = case_when(is.na(IABP_ever) ~ '0', TRUE ~ IABP_ever),
         ECMO_ever = case_when(is.na(ECMO_ever) ~ '0', TRUE ~ ECMO_ever),
         BiVAD_ever = case_when(is.na(BiVAD_ever) ~ '0', TRUE ~ BiVAD_ever),
         LVAD_ever = case_when(is.na(LVAD_ever) ~ '0', TRUE ~ LVAD_ever),
         RVAD_ever = case_when(is.na(RVAD_ever) ~ '0', TRUE ~ RVAD_ever),
         exception_ever = case_when(is.na(exception_ever) ~ '0', TRUE ~ exception_ever),
         temp_surg_ever = case_when(is.na(temp_surg_ever) ~ '0', TRUE ~ temp_surg_ever),
         BiVAD_no_discharge_ever = case_when(is.na(BiVAD_no_discharge_ever) ~ '0', TRUE ~ exception_ever))
```
         


### Labs: min, max
```{r, warning=F, comment=NA, message=F}
df_intervals <- df_intervals %>%
  group_by(PX_ID) %>%
  
  mutate(sodium_max = cummax(sodium),
         creatinine_max = cummax(creatinine),
         bilirubin_max = cummax(bilirubin),
         albumin_max = cummax(albumin),
         arterial_lactate_max = cummax(arterial_lactate),
         BUN_max = cummax(BUN),
         AST_max = cummax(AST),
         INR_max = cummax(INR),
         BNP_max = cummax(BNP),
         LDH_max = cummax(LDH)) %>%
  
  fill(sodium_max, .direction = 'down') %>%
  fill(creatinine_max, .direction = 'down') %>%
  fill(bilirubin_max, .direction = 'down') %>%
  fill(albumin_max, .direction = 'down') %>%
  fill(arterial_lactate_max, .direction = 'down') %>%
  fill(BUN_max, .direction = 'down') %>%
  fill(AST_max, .direction = 'down') %>%
  fill(INR_max, .direction = 'down') %>%
  fill(BNP_max, .direction = 'down') %>%
  fill(LDH_max, .direction = 'down') %>%
  
  mutate(sodium_min = cummin(sodium),
         creatinine_min = cummin(creatinine),
         bilirubin_min = cummin(bilirubin),
         albumin_min = cummin(albumin),
         arterial_lactate_min = cummin(arterial_lactate),
         BUN_min = cummin(BUN),
         AST_min = cummin(AST),
         INR_min = cummin(INR),
         BNP_min = cummin(BNP),
         LDH_min = cummax(as.numeric(LDH))) %>%
  
  fill(sodium_min, .direction = 'down') %>%
  fill(creatinine_min, .direction = 'down') %>%
  fill(bilirubin_min, .direction = 'down') %>%
  fill(albumin_min, .direction = 'down') %>%
  fill(arterial_lactate_min, .direction = 'down') %>%
  fill(BUN_min, .direction = 'down') %>%
  fill(AST_min, .direction = 'down') %>%
  fill(INR_min, .direction = 'down') %>%
  fill(BNP_min, .direction = 'down') %>%
  fill(LDH_min, .direction = 'down') 
```



### Labs: slope
```{r, warning=F, comment=NA, message=F}
df_intervals <- df_intervals %>%
  
  group_by(PX_ID) %>%
  
  mutate(sodium_lag = as.numeric(lag(sodium, n = 1)),
         creatinine_lag = as.numeric(lag(creatinine, n = 1)),
         bilirubin_lag = as.numeric(lag(bilirubin, n = 1)),
         albumin_lag = as.numeric(lag(albumin, n = 1)),
         arterial_lactate_lag = as.numeric(lag(arterial_lactate, n = 1)),
         BUN_lag = as.numeric(lag(BUN, n = 1)),
         AST_lag = as.numeric(lag(AST, n = 1)),
         INR_lag = as.numeric(lag(INR, n = 1)),
         BNP_lag = as.numeric(lag(BNP, n = 1)),
         LDH_lag = as.numeric(lag(LDH, n = 1))) %>%
  
  mutate(sodium_slope = as.numeric(sodium) - sodium_lag,
         creatinine_slope = as.numeric(creatinine) - creatinine_lag,
         bilirubin_slope = as.numeric(bilirubin) - bilirubin_lag,
         albumin_slope = as.numeric(albumin) - albumin_lag,
         arterial_lactate_slope = as.numeric(arterial_lactate) - arterial_lactate_lag,
         BUN_slope = as.numeric(BUN) - BUN_lag,
         AST_slope = as.numeric(AST) - AST_lag,
         INR_slope = as.numeric(INR) - INR_lag,
         BNP_slope = as.numeric(BNP) - BNP_lag,
         LDH_slope = as.numeric(LDH) - LDH_lag)


df_intervals <- df_intervals %>%
  group_by(PX_ID) %>%
  
  mutate(sodium_slope = case_when(is.na(sodium_slope) ~ 0, TRUE ~ sodium_slope),
         creatinine_slope = case_when(is.na(creatinine_slope) ~ 0, TRUE ~ creatinine_slope),
         bilirubin_slope = case_when(is.na(bilirubin_slope) ~ 0, TRUE ~ bilirubin_slope),
         albumin_slope = case_when(is.na(albumin_slope) ~ 0, TRUE ~ albumin_slope),
         arterial_lactate_slope = case_when(is.na(arterial_lactate_slope) ~ 0, TRUE ~ arterial_lactate_slope),
         BUN_slope = case_when(is.na(BUN_slope) ~ 0, TRUE ~ BUN_slope),
         AST_slope = case_when(is.na(AST_slope) ~ 0, TRUE ~ AST_slope),
         INR_slope = case_when(is.na(INR_slope) ~ 0, TRUE ~ INR_slope),
         BNP_slope = case_when(is.na(BNP_slope) ~ 0, TRUE ~ BNP_slope),
         LDH_slope = case_when(is.na(LDH_slope) ~ 0, TRUE ~ LDH_slope)) %>%
  
  select(-c(sodium_lag, creatinine_lag, bilirubin_lag, albumin_lag,
            arterial_lactate_lag, BUN_lag, AST_lag, INR_lag,
            BNP_lag, LDH_lag))
```


---------------------------------


# 8. Death in 6 weeks

### Create variable
```{r, warning=F, comment=NA, message=F}
## General death flag (non-last group)
df_intervals$death_flag <- 0
df_intervals$death_flag[which(df_intervals$PX_ID %in% death_ids)] <- 1

## Death within 6 weeks
df_intervals$interval_stop <- as.numeric(df_intervals$interval_stop)
df_intervals <- df_intervals %>%
  group_by(PX_ID) %>%
  mutate(death_time = max(interval_stop))

df_intervals$death6week <- 0
df_intervals$deathdifference <- (as.numeric(df_intervals$death_time) - 
                                   as.numeric(df_intervals$interval_stop))
df_intervals$death6week[df_intervals$death_flag == '1' & df_intervals$deathdifference <= 42] <- 1

## If transplanted, no death within 6 weeks in any interval
df_intervals$death6week[df_intervals$transplant == '1'] <- '0'
```


### Return max transplant by PX_ID to last group transplant
```{r, warning=F, comment=NA, message=F}
df_intervals$transplant[df_intervals$last_group == '0'] <- '0'


df_intervals <- df_intervals %>% select(-c(death_flag, death_time, deathdifference))
```


---------------------------------


# 9. Count missingness

### Add in weight, height, and gender for body surface area

```{r, warning=F, comment=NA, message=F}
### Get bsa from cand_thor again since ht, wt, and gender are constant
df_bsa <- haven::read_sas('./cand_thor.sas7bdat')
df_bsa <- df_bsa %>%
  select(PX_ID, CAN_HGT_CM, CAN_WGT_KG, CAN_GENDER) %>%
  mutate(bsa = 0.007184 * (CAN_HGT_CM ^ 0.425) * (CAN_WGT_KG ^ 0.725)) %>%
  select(PX_ID, bsa, CAN_GENDER)
df_bsa <- df_bsa[!duplicated(df_bsa), ]


df_intervals <- merge(df_intervals, df_bsa, by = 'PX_ID', all.x = T, all.y = F)
rm(df_bsa)
```


### Find missings in all intervals

```{r, warning=F, comment=NA, message=F}
library(plyr)

df_missing <- df_intervals %>%
  select(PX_ID, BNP, sodium, cardiac_output,
         central_venous_pressure, PASP, PADP, 
         systolicBP, diastolicBP, PCWP, age, creatinine, CAN_GENDER)


df_missing$creatinine <- as.numeric(df_missing$creatinine)
df_missing$age <- as.numeric(df_missing$age)

df_missing <- df_missing %>%
  mutate(eGFR = case_when(
    
    CAN_GENDER == 'F' & !is.na(creatinine) ~ 142 * (pmin((creatinine / 0.7), 1)^(-0.241)) *
      (pmax((creatinine / 0.7), 1)^(-1.2)) * 0.9938^(age) * 1.012,
    
    CAN_GENDER == 'M' & !is.na(creatinine) ~ 142 * (pmin((creatinine / 0.9), 1)^(-0.302)) *
      (pmax((creatinine / 0.7), 1)^(-1.2)) * 0.9938^(age))) %>%
  
  select(-c(age, creatinine))


100*sum(aggregate(df_missing$BNP, list(df_missing$PX_ID), 
              function(x){all(is.na(x))})$x) / 16905  
100*sum(aggregate(df_missing$sodium, list(df_missing$PX_ID), 
              function(x){all(is.na(x))})$x) / 16905 
100*sum(aggregate(df_missing$eGFR, list(df_missing$PX_ID), 
              function(x){all(is.na(x))})$x) / 16905 
100*sum(aggregate(df_missing$cardiac_output, list(df_missing$PX_ID), 
              function(x){all(is.na(x))})$x) / 16905  

100*sum(aggregate(df_missing$central_venous_pressure, list(df_missing$PX_ID), 
              function(x){all(is.na(x))})$x) / 16905  
100*sum(aggregate(df_missing$PASP, list(df_missing$PX_ID), 
              function(x){all(is.na(x))})$x) / 16905 
100*sum(aggregate(df_missing$PADP, list(df_missing$PX_ID), 
              function(x){all(is.na(x))})$x) / 16905  

100*sum(aggregate(df_missing$systolicBP, list(df_missing$PX_ID), 
              function(x){all(is.na(x))})$x) / 16905 
100*sum(aggregate(df_missing$diastolicBP, list(df_missing$PX_ID), 
              function(x){all(is.na(x))})$x) / 16905  
100*sum(aggregate(df_missing$PCWP, list(df_missing$PX_ID), 
              function(x){all(is.na(x))})$x) / 16905 
```


---------------------------------


# 10. Impute variables 

### Replace certain variables with normal values

* Lactate: 1 mmol/L
* LDH: 220 U/L
* Hemoglobin: 14.9 g/dL for males, 13.3 g/dL for females
* BNP: median based on BNP type
* Sodium: median
* Albumin: median
* Bilirubin: median
* eGFR: 100 mL/min/1.73m^2
* Cardiac output: 2.5 x bsa if LVAD, 2.2 x bsa else
* CVP: 10 mm Hg if LVAD, 12 else
* PASP/PADP: 35/15 mm Hg if LVAD, 38/18 else
* PCWP: 15 mm Hg if LVAD, 18 else
* Systolic/Diastolic BP: 100/80 if LVAD, 110/80 else
* Heart rate: 85 bpm


```{r, warning=F, comment=NA, message=F}
df_intervals$arterial_lactate[is.na(df_intervals$arterial_lactate)] <- 1
df_intervals$LDH[is.na(df_intervals$LDH)] <- 220
df_intervals$hemoglobin[is.na(df_intervals$hemoglobin) & df_intervals$CAN_GENDER == 'M'] <- 14.9
df_intervals$hemoglobin[is.na(df_intervals$hemoglobin) & df_intervals$CAN_GENDER == 'F'] <- 13.3

df_intervals$BNP[is.na(df_intervals$BNP) & df_intervals$BNP_NT_Pro == '0'] <- 
  median(df_intervals$BNP[df_intervals$BNP_NT_Pro == '0'], na.rm=T)
df_intervals$BNP[is.na(df_intervals$BNP) & df_intervals$BNP_NT_Pro == '1'] <- 
  median(df_intervals$BNP[df_intervals$BNP_NT_Pro == '1'], na.rm=T)


df_intervals$sodium[is.na(df_intervals$sodium)] <- median(df_intervals$sodium, na.rm=T)
df_intervals$albumin[is.na(df_intervals$albumin)] <- median(df_intervals$albumin, na.rm=T)
df_intervals$bilirubin[is.na(df_intervals$bilirubin)] <- median(df_intervals$bilirubin, na.rm=T)
```

```{r, warning=F, comment=NA, message=F}
df_intervals <- df_intervals %>%
  mutate(cardiac_output = ifelse((is.na(cardiac_output) & LVAD == '1'),  2.5*bsa, cardiac_output)) %>%
  mutate(cardiac_output = ifelse((is.na(cardiac_output) & LVAD != '1'),  2.2*bsa, cardiac_output)) %>%
  select(-c(bsa))


df_intervals$central_venous_pressure[is.na(df_intervals$central_venous_pressure) & df_intervals$LVAD == '1'] <- 10
df_intervals$PASP[is.na(df_intervals$PASP) & df_intervals$LVAD == '1'] <- 35
df_intervals$PADP[is.na(df_intervals$PADP) & df_intervals$LVAD == '1'] <- 15
df_intervals$PCWP[is.na(df_intervals$PCWP) & df_intervals$LVAD == '1'] <- 15
df_intervals$systolicBP[is.na(df_intervals$systolicBP) & df_intervals$LVAD == '1'] <- 100
df_intervals$diastolicBP[is.na(df_intervals$diastolicBP) & df_intervals$LVAD == '1'] <- 80
df_intervals$heart_rate[is.na(df_intervals$heart_rate) & df_intervals$LVAD == '1'] <- 8.5


df_intervals$central_venous_pressure[is.na(df_intervals$central_venous_pressure) & df_intervals$LVAD != '1'] <- 12
df_intervals$PASP[is.na(df_intervals$PASP) & df_intervals$LVAD != '1'] <- 38
df_intervals$PADP[is.na(df_intervals$PADP) & df_intervals$LVAD != '1'] <- 18
df_intervals$PCWP[is.na(df_intervals$PCWP) & df_intervals$LVAD != '1'] <- 18
df_intervals$systolicBP[is.na(df_intervals$systolicBP) & df_intervals$LVAD != '1'] <- 110
df_intervals$diastolicBP[is.na(df_intervals$diastolicBP) & df_intervals$LVAD != '1'] <- 80
df_intervals$heart_rate[is.na(df_intervals$heart_rate) & df_intervals$LVAD != '1'] <- 8.5
```


### Final cleanup of variables
```{r, warning=F, comment=NA, message=F}
### Reupdate min/max variables based on imputations by replacing with imputed value
df_intervals$sodium_min[is.na(df_intervals$sodium_min) & !is.na(df_intervals$sodium)] <- 
  df_intervals$sodium[is.na(df_intervals$sodium_min) & !is.na(df_intervals$sodium)]
df_intervals$creatinine_min[is.na(df_intervals$creatinine_min) & !is.na(df_intervals$creatinine)] <- 
  df_intervals$creatinine[is.na(df_intervals$creatinine_min) & !is.na(df_intervals$creatinine)]
df_intervals$bilirubin_min[is.na(df_intervals$bilirubin_min) & !is.na(df_intervals$bilirubin)] <- 
  df_intervals$bilirubin[is.na(df_intervals$bilirubin_min) & !is.na(df_intervals$bilirubin)]
df_intervals$albumin_min[is.na(df_intervals$albumin_min) & !is.na(df_intervals$albumin)] <- 
  df_intervals$albumin[is.na(df_intervals$albumin_min) & !is.na(df_intervals$albumin)]
df_intervals$arterial_lactate_min[is.na(df_intervals$arterial_lactate_min) & !is.na(df_intervals$arterial_lactate)] <-
  df_intervals$arterial_lactate[is.na(df_intervals$arterial_lactate_min) & !is.na(df_intervals$arterial_lactate)]
df_intervals$BUN_min[is.na(df_intervals$BUN_min) & !is.na(df_intervals$BUN)] <- 
  df_intervals$BUN[is.na(df_intervals$BUN_min) & !is.na(df_intervals$BUN)]
df_intervals$AST_min[is.na(df_intervals$AST_min) & !is.na(df_intervals$AST)] <- 
  df_intervals$AST[is.na(df_intervals$AST_min) & !is.na(df_intervals$AST)]
df_intervals$INR_min[is.na(df_intervals$INR_min) & !is.na(df_intervals$INR)] <- 
  df_intervals$INR[is.na(df_intervals$INR_min) & !is.na(df_intervals$INR)]
df_intervals$BNP_min[is.na(df_intervals$BNP_min) & !is.na(df_intervals$BNP)] <- 
  df_intervals$BNP[is.na(df_intervals$BNP_min) & !is.na(df_intervals$BNP)]
df_intervals$LDH_min[is.na(df_intervals$LDH_min) & !is.na(df_intervals$LDH)] <- 
  df_intervals$LDH[is.na(df_intervals$LDH_min) & !is.na(df_intervals$LDH)]
df_intervals$sodium_max[is.na(df_intervals$sodium_max) & !is.na(df_intervals$sodium)] <- 
  df_intervals$sodium[is.na(df_intervals$sodium_max) & !is.na(df_intervals$sodium)]
df_intervals$creatinine_max[is.na(df_intervals$creatinine_max) & !is.na(df_intervals$creatinine)] <- 
  df_intervals$creatinine[is.na(df_intervals$creatinine_max) & !is.na(df_intervals$creatinine)]
df_intervals$bilirubin_max[is.na(df_intervals$bilirubin_max) & !is.na(df_intervals$bilirubin)] <- 
  df_intervals$bilirubin[is.na(df_intervals$bilirubin_max) & !is.na(df_intervals$bilirubin)]
df_intervals$albumin_max[is.na(df_intervals$albumin_max) & !is.na(df_intervals$albumin)] <- 
  df_intervals$albumin[is.na(df_intervals$albumin_max) & !is.na(df_intervals$albumin)]
df_intervals$arterial_lactate_max[is.na(df_intervals$arterial_lactate_max) & !is.na(df_intervals$arterial_lactate)] <-
  df_intervals$arterial_lactate[is.na(df_intervals$arterial_lactate_max) & !is.na(df_intervals$arterial_lactate)]
df_intervals$BUN_max[is.na(df_intervals$BUN_max) & !is.na(df_intervals$BUN)] <- 
  df_intervals$BUN[is.na(df_intervals$BUN_max) & !is.na(df_intervals$BUN)]
df_intervals$AST_max[is.na(df_intervals$AST_max) & !is.na(df_intervals$AST)] <- 
  df_intervals$AST[is.na(df_intervals$AST_max) & !is.na(df_intervals$AST)]
df_intervals$INR_max[is.na(df_intervals$INR_max) & !is.na(df_intervals$INR)] <- 
  df_intervals$INR[is.na(df_intervals$INR_max) & !is.na(df_intervals$INR)]
df_intervals$BNP_max[is.na(df_intervals$BNP_max) & !is.na(df_intervals$BNP)] <- 
  df_intervals$BNP[is.na(df_intervals$BNP_max) & !is.na(df_intervals$BNP)]
df_intervals$LDH_max[is.na(df_intervals$LDH_max) & !is.na(df_intervals$LDH)] <- 
  df_intervals$LDH[is.na(df_intervals$LDH_max) & !is.na(df_intervals$LDH)]


df_intervals <- df_intervals %>% 
  relocate(death6week, .after=transplant) %>%
  relocate(interval, .after=PX_ID) %>%
  relocate(interval_start, .after=interval) %>%
  relocate(interval_stop, .after=interval_start) %>%
  select(-c(status_criteria))


df_intervals$listing_year <- year(df_intervals$CAN_LISTING_DT)
df_intervals$CAN_LISTING_DT <- NULL


df_intervals <- df_intervals[order(df_intervals$PX_ID, as.numeric(df_intervals$interval)), ]
```


### Check examples with original candthor
```{r, warning=F, comment=NA, message=F}
set.seed(200)
sample_ids <- sample(df_intervals$PX_ID, size=5, replace=F)

df_intervals %>%
  filter(PX_ID %in% sample_ids) %>%
  select(PX_ID, interval, death6week, transplant, status, age, diagnosis, dialysis) %>%
  arrange(PX_ID)
```

```{r, warning=F, comment=NA, message=F}
df_candthor <- haven::read_sas('./cand_thor.sas7bdat')

df_candthor %>%
  filter(PX_ID %in% sample_ids) %>%
  select('PX_ID', 'CAN_LISTING_DT',
         'PERS_SSA_DEATH_DT', 'PERS_OPTN_DEATH_DT', 'CAN_REM_DT', 'CAN_DEATH_DT',
          'CAN_REM_CD', 'REC_TX_DT', 'CAN_LAST_ACT_STAT_DT',
         'CAN_AGE_IN_MONTHS_AT_LISTING', 'CAN_DGN', 'CAN_DIAB_TY', 'CAN_DIAL', 'CAN_INIT_STAT') %>%
  arrange(PX_ID)
```


---------------------------------


# 11. Generate new clinical variables

### Temporary surgery MCS, ever
```{r, warning=F, comment=NA, message=F}
df_intervals <- df_intervals %>%
  mutate(temp_surg_MCS_ever = case_when(
    ECMO_ever == '1' | temp_surg_ever == '1' | BiVAD_no_discharge_ever == '1' ~ 1,
    TRUE ~ 0))
```


### Creatinine-only eGFR and kidney deficit
The formula for eGFR is available at https://www.kidney.org/content/ckd-epi-creatinine-equation-2021.

```{r, warning=F, comment=NA, message=F}
df_intervals$creatinine <- as.numeric(df_intervals$creatinine)
df_intervals$age <- as.numeric(df_intervals$age)

df_intervals <- df_intervals %>%
  mutate(eGFR = case_when(
    
    CAN_GENDER == 'F' & !is.na(creatinine) ~ 142 * (pmin((creatinine / 0.7), 1)^(-0.241)) *
      (pmax((creatinine / 0.7), 1)^(-1.2)) * 0.9938^(age) * 1.012,
    
    CAN_GENDER == 'M' & !is.na(creatinine) ~ 142 * (pmin((creatinine / 0.9), 1)^(-0.302)) *
      (pmax((creatinine / 0.7), 1)^(-1.2)) * 0.9938^(age)))

df_intervals$eGFR[df_intervals$dialysis == '1'] <- 0
df_intervals$eGFR[is.na(df_intervals$eGFR)] <- 100
```


#### Examine eGFR and kidney to check eGFR- confirmed with online calculator
```{r, warning=F, comment=NA, message=F}
df_intervals %>%
  select(PX_ID, creatinine, age, CAN_GENDER, dialysis, eGFR)
```


### Save final dataset

```{r, warning=F, comment=NA, message=F}
save(df_intervals, file = './intervals_v17_impute_6wkdeath.RData')
```


---------------------------------


# 12. Histograms of variables (eFigure 2)

```{r, echo=F, warning=F, comment=NA, fig.align='center'}
df_histograms <- df_intervals %>% select(albumin, eGFR, 
                                         sodium, bilirubin,
                                         BNP, central_venous_pressure,
                                         cardiac_output, PADP, PASP,
                                         systolicBP, diastolicBP)
df_histograms <- df_histograms %>%   
  mutate(
    cardiac_output = as.numeric(cardiac_output),
    systolicBP = as.numeric(systolicBP),
    diastolicBP = as.numeric(diastolicBP),
    PASP = as.numeric(PASP),
    PADP = as.numeric(PADP),
    central_venous_pressure = as.numeric(central_venous_pressure),
    
    cpo = (1/541) * cardiac_output * (((2/3)*systolicBP) + ((1/3)*diastolicBP)),
    papi = (PASP - PADP) / central_venous_pressure)
df_histograms$papi[df_histograms$central_venous_pressure == 0] <- 1
df_histograms$papi[df_histograms$papi < 1 & !is.na(df_histograms$papi)] <- 1

df_histograms <- df_histograms %>% 
  select(-c(central_venous_pressure, cardiac_output, PADP, PASP,
            systolicBP, diastolicBP))




hist1 <- ggplot(df_histograms, aes(x=as.numeric(albumin))) + 
  geom_histogram(fill='#880d1e', color='#880d1e') + 
  theme_bw() +
  xlab('Albumin') + ylab('') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

hist2 <- ggplot(df_histograms, aes(x=as.numeric(eGFR))) + 
  geom_histogram(fill='#880d1e', color='#880d1e') + 
  theme_bw() +
  xlab(expression('eGFR'^'a')) + ylab('') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

hist3 <- ggplot(df_histograms, aes(x=as.numeric(sodium))) + 
  geom_histogram(fill='#880d1e', color='#880d1e') + 
  theme_bw() +
  xlab('Sodium') + ylab('') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

hist4 <- ggplot(df_histograms, aes(x=as.numeric(cpo))) + 
  geom_histogram(fill='#880d1e', color='#880d1e') + 
  theme_bw() +
  xlab('CPO') + ylab('') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

options(scipen=10)
hist5 <- ggplot(df_histograms, aes(x=as.numeric(bilirubin))) + 
  geom_histogram(fill='#880d1e', color='#880d1e') + 
  theme_bw() +
  xlab('Bilirubin') + ylab('') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

hist6 <- ggplot(df_histograms, aes(x=as.numeric(BNP))) + 
  geom_histogram(fill='#880d1e', color='#880d1e') + 
  theme_bw() +
  xlab('BNP') + ylab('') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

hist7 <- ggplot(df_histograms, aes(x=as.numeric(papi))) + 
  geom_histogram(fill='#880d1e', color='#880d1e') + 
  theme_bw() +
  xlab('PAPi') + ylab('') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())


# dev.new(width = 7,height = 6, noRStudioGD = T)
cowplot::plot_grid(hist1, hist2, hist3, hist4, hist5, hist6, hist7,
                   labels = 'AUTO', scale = 0.9, nrow=2)
```


---------------------------------


# 13. Sample checks between blocked and unblocked

### A random sample of 10 patients
```{r}
sample_ids <- sample(df$PX_ID, size=10, replace=F)

df_sample <- df %>% filter(PX_ID %in% sample_ids)
df_intervals_sample <- df_intervals %>% filter(PX_ID %in% sample_ids)
```

```{r}
df_sample %>%
  select(PX_ID, t_start, t_stop, last_group, status, systolicBP, PCWP, cardiac_output, BNP)
```

```{r}
df_intervals_sample %>%
  select(PX_ID, interval_start, interval_stop, last_group, status, systolicBP, PCWP, cardiac_output, BNP)
```


### A patient where status and some lab variables change
```{r}
df %>%
  filter(PX_ID == '1257001')  %>%
  select(PX_ID, t_start, t_stop, last_group, status, systolicBP, PCWP, central_venous_pressure, cardiac_output)
```

```{r}
df_intervals %>%
  filter(PX_ID == '1257001')  %>%
  select(PX_ID, interval_start, interval_stop, status, 
         last_group, systolicBP, PCWP, central_venous_pressure, cardiac_output)
```


### A patient where data changes in <14 days
```{r}
df %>%
  filter(PX_ID == '1252031')  %>%
  select(PX_ID, t_start, t_stop, status, systolicBP, PCWP, central_venous_pressure, cardiac_output)
```

```{r}
df_intervals %>%
  filter(PX_ID == '1252031')  %>%
  select(PX_ID, interval_start, interval_stop, status, 
         systolicBP, PCWP, central_venous_pressure, cardiac_output)
```


### A patient with time in a multiple of 14

```{r}
df %>%
  filter(PX_ID == '1496791')  %>%
  select(PX_ID, t_start, t_stop, status, systolicBP, PCWP, central_venous_pressure, cardiac_output)
```

```{r}
df_intervals %>%
  filter(PX_ID == '1496791')  %>%
  select(PX_ID, interval_start, interval_stop, status, 
         systolicBP, PCWP, central_venous_pressure, cardiac_output)
```
