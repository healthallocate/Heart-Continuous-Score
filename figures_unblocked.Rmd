---
title: "Main Figures using Unblocked Dataset"
output:
  html_document:
    toc: true
    df_print: paged
authors: Kevin Zhang
---


<!-- 1. Set up continuous dataset (Line 32) -->
<!-- 2. Comparison of training and testing Datasets/Table 1 (Line 76) -->
<!-- 3. Impute values into dataset (Line 156) -->
<!-- 4. Unblock dataset using final data values (Line 241) -->
<!-- 5. Make predictions on unblocked dataset and calculate discrimination measurements (Line 261) -->
<!-- 6. Make post-prediction figures (Line 348) -->
<!-- 7. Score conversion possibilities (Line 405) -->


```{r, include=F, warning=F, echo=F, comment=NA}
rm(list=ls()); invisible(gc())
if (!require('pacman')) {install.packages('pacman')}
library(pacman)
pacman::p_load(tidyverse, splines, knitr, kableExtra, glmnet, caret, gtsummary, pROC, xgboost, survival, DescTools)
knitr::opts_knit$set(root.dir = 'C:/Users/kevinz94/Desktop/DiscreteData')
```


---------------------------------


# 1. Set up continuous dataset
Continuous dataset is obtained from Section 5 of *6week_death_data_prep.Rmd*. 


```{r, echo=F, warning=F, comment=NA}
load('./intervals_v16_continuous.RData')


## Keep only relevant variables
df <- df %>%
  select(PX_ID, CenterId, t_start, t_stop, last_group, status,
         systolicBP, PCWP, central_venous_pressure, cardiac_output, 
         AST, creatinine, bilirubin, albumin, sodium, BNP, 
         heart_rate, diastolicBP, PASP, PADP, hemoglobin, dialysis, peripheral_vascular, 
         status, ECMO, BiVAD_no_discharge, temp_surg_LVAD, IABP, ECMO, 
         death_flag, age, status_initial, LVAD, BiVAD, transplant)


## Add a train-test indicator
load('./train_ids.RData')
df$train_test <- 'Test'
df$train_test[df$CenterId %in% center_ids_train] <- 'Train'


## General death; death in final status change
df <- df %>%
  group_by(PX_ID) %>%
  mutate(death = case_when(
    death_flag == '1' & transplant == '0' & last_group == '1' ~ 1,
    TRUE ~ 0)) %>%
  select(-c(death_flag, transplant))


## Certain variables need to be obtained from cand_thor since demographics not used in model
df_cand_thor <- haven::read_sas('./cand_thor.sas7bdat')
df_cand_thor <- df_cand_thor %>% select(PX_ID, CAN_GENDER, CAN_RACE, CAN_HGT_CM, CAN_WGT_KG) %>% unique()
df <- merge(df, df_cand_thor, by='PX_ID', all.x=T, all.y=F)
df$bsa <- 0.007184 * (df$CAN_HGT_CM ^ 0.425) * (df$CAN_WGT_KG ^ 0.725)
```


---------------------------------


# 2. Comparison of training and testing Datasets/Table 1

Includes these initial variables at listing:

- 6 Status at Listing
- Age at Listing
- Sex
- Race
- Albumin
- Bilirubin
- eGFR
- Sodium
- BNP
- Pulmonary Systolic BP, Pulmonary Diastolic BP
- Central Venous Pressure


```{r, echo=F, warning=F, comment=NA, fig.align='center'}
df_table1 <- df %>%
  select(PX_ID, train_test, status, age, albumin, 
         bilirubin, creatinine, sodium, BNP, PASP, PADP, central_venous_pressure,
         systolicBP, diastolicBP, cardiac_output, CAN_GENDER, CAN_RACE) %>%
  group_by(PX_ID) %>%
  filter(row_number() == 1)


### Recreate eGFR again and fix race
df_table1 <- df_table1 %>%
  mutate(eGFR = case_when(
    CAN_GENDER == 'F' & !is.na(creatinine) ~ 142 * (pmin((creatinine / 0.7), 1)^(-0.241)) *
      (pmax((creatinine / 0.7), 1)^(-1.2)) * 0.9938^age * 1.012,
    
    CAN_GENDER == 'M' & !is.na(creatinine) ~ 142 * (pmin((creatinine / 0.9), 1)^(-0.302)) *
      (pmax((creatinine / 0.7), 1)^(-1.2)) * 0.9938^age)) %>%
  
  mutate(race = case_when(
    CAN_RACE == '8' ~ 'White',
    CAN_RACE == '16' ~ 'Black or AA',
    CAN_RACE == '64' ~ 'Asian',
    CAN_RACE == '2000' ~ 'Hispanic or Latino',
    TRUE ~ 'Other' )) 

df_table1$train_test <- factor(df_table1$train_test, levels = c('Train', 'Test'))
df_table1 <- df_table1[ ,c('train_test', 'age', 'CAN_GENDER', 'race', 
                                           'status', 'albumin', 'bilirubin', 'eGFR',
                                           'sodium', 'BNP', 'cardiac_output', 
                                           'PASP', 'PADP', 'systolicBP', 'diastolicBP',
                                           'central_venous_pressure')]


df_table1 %>%
  ungroup() %>%
  tbl_summary(by = train_test, 
              missing = 'no', 
              statistic = all_continuous() ~ "{mean} ({sd})",
              label = c(age ~ 'Age at Listing, mean (SD), y',
                        CAN_GENDER ~ 'Gender, No. (%)',
                        race ~ 'Race, No. (%)',
                        status ~ '6-Status, No. (%)',
                        albumin ~ 'Albumin, mean (SD), g/dL',
                        bilirubin ~ 'Bilirubin, mean (SD), mg/dL',
                        eGFR ~ 'eGFR, mean (SD), mL/min/1.73m2',
                        sodium ~ 'Sodium, mean (SD), mEq/L',
                        BNP ~ 'BNP, mean (SD), pg/mL',
                        cardiac_output ~ 'Cardiac output, mean (SD), L/min',
                        PASP ~ 'Pulmonary Systolic BP, mean (SD), mm Hg',
                        PADP ~ 'Pulmonary Diastolic BP, mean (SD), mm Hg',
                        systolicBP ~ 'Systolic BP, mean (SD), mm Hg',
                        diastolicBP ~ 'Diastolic BP, mean (SD), mm Hg',
                        central_venous_pressure ~ 'Central Venous Pressure, mean (SD), mm Hg')) %>%
  modify_header(label = "**Variable**") %>%
  add_p() %>%
  add_overall() %>%
  bold_labels()
```


---------------------------------


# 3. Impute values into unblocked dataset

### Impute using the same rules

```{r, warning=F, comment=NA}
df <- df %>% 
  group_by(PX_ID) %>%
  fill(status, .direction = 'down')

df$BNP[is.na(df$BNP) & df$status == '1'] <- median(df$BNP[df$status == '1'], na.rm=T)
df$BNP[is.na(df$BNP) & df$status == '2'] <- median(df$BNP[df$status == '2'], na.rm=T)
df$BNP[is.na(df$BNP) & df$status == '3'] <- median(df$BNP[df$status == '3'], na.rm=T)
df$BNP[is.na(df$BNP) & df$status == '4'] <- median(df$BNP[df$status == '4'], na.rm=T)
df$BNP[is.na(df$BNP) & df$status == '5'] <- median(df$BNP[df$status == '5'], na.rm=T)
df$BNP[is.na(df$BNP) & df$status == '6'] <- median(df$BNP[df$status == '6'], na.rm=T)

df <- df %>%
  mutate(cardiac_output = ifelse((status == '4' & is.na(cardiac_output) & LVAD == '1'),  
                                 2.5*bsa, cardiac_output)) %>%
  mutate(cardiac_output = ifelse((status == '6' & is.na(cardiac_output) & LVAD == '1'),  
                                 2.2*bsa, cardiac_output))


df$central_venous_pressure[is.na(df$central_venous_pressure) & df$status == '4' & df$LVAD == '1'] <- 10
df$PASP[is.na(df$PASP) & df$status == '4' & df$LVAD == '1'] <- 35
df$PADP[is.na(df$PADP) & df$status == '4' & df$LVAD == '1'] <- 15
df$PCWP[is.na(df$PCWP) & df$status == '4' & df$LVAD == '1'] <- 15
df$systolicBP[is.na(df$systolicBP) & df$status == '4' & df$LVAD == '1'] <- 100
df$diastolicBP[is.na(df$diastolicBP) & df$status == '4' & df$LVAD == '1'] <- 80

df$central_venous_pressure[is.na(df$central_venous_pressure) & df$status == '6'] <- 12
df$PASP[is.na(df$PASP) & df$status == '6'] <- 38
df$PADP[is.na(df$PADP) & df$status == '6'] <- 18
df$PCWP[is.na(df$PCWP) & df$status == '6'] <- 18
df$systolicBP[is.na(df$systolicBP) & df$status == '6'] <- 110
df$diastolicBP[is.na(df$diastolicBP) & df$status == '6'] <- 80
```


### Recreate short MCS ever, eGFR, cpo, api

```{r, warning=F, comment=NA, fig.align='center'}
df <- df %>%
  mutate(ECMO_ever = case_when(ECMO == '1' ~ '1', TRUE ~ NA_character_),
         temp_surg_ever = case_when(temp_surg_LVAD == '1' ~ '1', TRUE ~ NA_character_),
         BiVAD_no_discharge_ever = case_when(BiVAD_no_discharge == '1' ~ '1', TRUE ~ NA_character_)) %>%
  
  fill(ECMO_ever, .direction = 'down') %>%
  fill(temp_surg_ever, .direction = 'down') %>%
  fill(BiVAD_no_discharge_ever, .direction = 'down') %>%
  
  mutate(short_MCS_French = 
           case_when(
             (ECMO == '1' & status == '1') | IABP == '1' ~ 1,
             TRUE ~ 0)) %>% 
  
  mutate(short_MCS_ever = 
           case_when(
             ECMO_ever == '1' | temp_surg_ever == '1' | BiVAD_no_discharge_ever == '1' ~ 1,
             TRUE ~ 0)) %>%
  
 mutate(eGFR = case_when(
    
    CAN_GENDER == 'F' & !is.na(creatinine) ~ 142 * (pmin((creatinine / 0.7), 1)^(-0.241)) *
      (pmax((creatinine / 0.7), 1)^(-1.2)) * 0.9938^age * 1.012,
    
    CAN_GENDER == 'M' & !is.na(creatinine) ~ 142 * (pmin((creatinine / 0.9), 1)^(-0.302)) *
      (pmax((creatinine / 0.7), 1)^(-1.2)) * 0.9938^age)) %>%
  
  mutate(
    cpo = (1/541) * cardiac_output * (((2/3)*systolicBP) + ((1/3)*diastolicBP)),
    papi = (PASP - PADP) / central_venous_pressure)


df$eGFR[df$dialysis == '1'] <- 0
df$papi[df$central_venous_pressure == 0] <- 1
df$papi[df$papi < 1 & !is.na(df$papi)] <- 1

df$LVAD <- as.factor(df$LVAD)
```


---------------------------------


# 4. Unblock dataset using final data value
To create an unblocked dataset, using 0 for starting time, and values in last block.


```{r, warning=F, comment=NA, fig.align='center'}
### Keep only relevant variables
df <- df %>%
  group_by(PX_ID) %>%
  select(PX_ID, t_start, t_stop, status, last_group, systolicBP, bilirubin, albumin, sodium, BNP, LVAD,
         train_test, death, short_MCS_French, short_MCS_ever, eGFR, cpo, papi)

df_unblocked <- subset(df, df$last_group == '1')
df_unblocked$t_start <- 0
df_unblocked$t_stop[df_unblocked$t_stop == 0] <- 1
```


---------------------------------


# 5. Make predictions on unblocked dataset and calculate discrimination measurements

### 6-Status
6-Status model is obtained from Section 3 of **model_results.Rmd**


```{r, warning=F, echo=F, message=F, comment=NA}
load('./model_6status.RData')

model6status_predict <- predict(model6status, newdata = df_unblocked, type = 'response')
df_unblocked$model6status_predict <- model6status_predict


concordance(coxph(Surv(t_start, t_stop, death) ~ model6status_predict, data = df_unblocked), timewt = 'n')
```


### 6-Status Brier score

```{r, warning=F, echo=F, message=F, comment=NA}
df_unblocked_no_missing <- subset(df_unblocked, !is.na(df_unblocked$model6status_predict))
paste0('6-Status Brier: ', DescTools::BrierScore(df_unblocked_no_missing$death, df_unblocked_no_missing$model6status_predict))
```


### French-CRS c-index
French-CRS model is obtained from Section 3 of **model_results.Rmd**

```{r, warning=F, echo=F, message=F, comment=NA}
load('./model_frenchCRS.RData')
model1_predict <- predict(model1, newdata = df_unblocked, type = 'response')
df_unblocked$model1_predict <- model1_predict


concordance(coxph(Surv(t_start, t_stop, death) ~ model1_predict, data = df_unblocked), timewt = 'n')
```


### French-CRS Brier score

```{r, warning=F, echo=F, message=F, comment=NA}
df_unblocked_no_missing <- subset(df_unblocked, !is.na(df_unblocked$model1_predict))
paste0('French-CRS Brier: ', DescTools::BrierScore(df_unblocked_no_missing$death, df_unblocked_no_missing$model1_predict))
```


### US-CRS c-index
US-CRS model is obtained from Section 3 of **model_results.Rmd**

```{r, warning=F, echo=F, message=F, comment=NA}
load('./model_USCRS.RData')
model6_predict <- predict(model6, newdata = df_unblocked, type = 'response')
df_unblocked$model6_predict <- model6_predict

concordance(coxph(Surv(t_start, t_stop, death) ~ model6_predict, data = df_unblocked), timewt = 'n')
```


### US-CRS Brier score

```{r, warning=F, echo=F, message=F, comment=NA}
df_unblocked_no_missing <- subset(df_unblocked, !is.na(df_unblocked$model6_predict))

paste0('US-CRS Brier: ', DescTools::BrierScore(df_unblocked_no_missing$death, df_unblocked_no_missing$model6_predict))
```



### Save a sample for extraction

```{r, warning=F, echo=F, message=F, comment=NA}
df_sample <- df_unblocked %>%
  select(-c(last_group)) 

colnames(df_sample) <- 
  c('PX_ID', 't_start', 't_stop', 'status', 'systolicBP', 
    'bilirubin', 'albumin', 'sodium', 'BNP', 'LVAD', 'train_test', 
    'death', 'short_MCS_French', 'short_MCS_ever', 'eGFR', 'cpo', 
    'papi', '6status_predict', 'French_CRS_predict', 'US_CRS_predict')

save(df_sample, file = './df_sample.RData')
```


---------------------------------


# 6. Make post-prediction figures

## Plot calibration for US-CRS (eSupplement 6)

```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
df_unblocked$model6predict_c <- predict(model6, newdata = df_unblocked)
df_unblocked_calibration <- df_unblocked %>%
  ungroup() %>%
  mutate(decile_US_CRS = ntile(model6predict_c, 10))
df_unblocked_calibration <- df_unblocked_calibration[ ,c('decile_US_CRS', 'death', 'model6_predict')]
df_unblocked_calibration <- subset(df_unblocked_calibration, !is.na(df_unblocked_calibration$decile_US_CRS))


df_unblocked_calibration %>%
  group_by(decile_US_CRS) %>%
  summarise(observed = mean(as.numeric(as.character(death))),
            model6_predict = mean(model6_predict, na.rm = T)) %>%
  ggplot(aes(x = model6_predict, y = observed)) +
  xlab('Predicted Values') + ylab('Observed Values') +
  geom_point(size = 2.5) + geom_abline(linewidth = 1.2, intercept = 0, slope = 1, color = 'firebrick') +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 14, margin = margin(t=5)),
        axis.text.x = element_text(size = 13, margin = margin(t=5)),
        axis.title.y = element_text(size = 14, margin = margin(r=5)),
        axis.text.y = element_text(size = 13, margin = margin(r=5))) +
  lims(x = c(0, 0.25), y= c(0, 0.25))
```


## Boxplot of predicted risk by status (Figure 3)

```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
df_unblocked_no_missing <- subset(df_unblocked, !is.na(df_unblocked$status))


df_unblocked_no_missing %>%
  ggplot(aes(y = model6_predict, x = status, color = factor(status))) +
  geom_boxplot() +
  xlab('') + ylab('Predicted Risk from US-CRS') + labs(color = 'Status') +
  theme_bw() + 
  scale_color_brewer(palette='Reds') +
  theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 14, margin = margin(t=5)), 
    axis.text.x = element_text(size = 13, margin = margin(t=5)), 
    axis.title.y = element_text(size = 14, margin = margin(r=5)),
    axis.text.y = element_text(size = 13, margin = margin(r=5)),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13))
```


---------------------------------


# 7. Score conversion possibilities


## Find 50-point percentile cutoffs based on log-odds on entire dataset

```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
cutoffs <- quantile(model6_predict, probs = seq(0, 1, length.out = 50), na.rm = T)
cutoffs <- data.frame(Score = 1:50, RiskCutoff = cutoffs)
cutoffs$RiskCutoff <- round(cutoffs$RiskCutoff, 4)
rownames(cutoffs) <- NULL


cutoffs %>%
  kable(align=c('c', 'c')) %>%
  kable_styling(bootstrap_options='striped', full_width=F, position='center') %>%
  column_spec(1, border_right=T)


write.csv(cutoffs, file = './cutoffs.csv')
```


## Plot 50-Point Score Based on 1-Year RMST for US-CRS model (eSupplement 8)

```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}
model6_rmst <- df_unblocked
model6_rmst$t_stop[model6_rmst$t_stop > 365] <- 365

model6_rmst <- model6_rmst %>% 
  group_by(PX_ID) %>%
  mutate(time_diff = t_stop - t_start) %>%
  mutate(product = time_diff * (1-model6_predict)) 

model6_rmst <- aggregate(model6_rmst$product, by=list(model6_rmst$PX_ID), FUN=sum)
colnames(model6_rmst) <- c('PX_ID', 'rmst')



model6_rmst$score <- 50*(model6_rmst$rmst /365)
model6_rmst %>%
  ggplot(aes(x = score)) +
  geom_histogram(fill = 'firebrick') +
  theme_bw() + 
  xlab('50-Point Score') + ylab('Count') +
  theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 14, margin = margin(t=5)), 
    axis.text.x = element_text(size = 13, margin = margin(t=5)), 
    axis.title.y = element_text(size = 14, margin = margin(r=5)),
    axis.text.y = element_text(size = 13, margin = margin(r=5)))
```
